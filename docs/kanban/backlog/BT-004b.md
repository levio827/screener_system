# BT-004b: Backtesting Frontend - Results Visualization

## Metadata

| Field | Value |
|-------|-------|
| **ID** | BT-004b |
| **Title** | Build Backtesting Results Visualization |
| **Type** | Feature |
| **Status** | BACKLOG |
| **Priority** | P1 (High) |
| **Estimate** | 8 hours |
| **Sprint** | Sprint 6 |
| **Epic** | Backtesting Engine |
| **Assignee** | TBD |
| **Depends On** | BT-004a |
| **Blocks** | - |
| **Created** | 2025-11-29 |
| **Updated** | 2025-11-30 |
| **Tags** | `frontend`, `react`, `typescript`, `charts`, `visualization`, `export` |

## Description

Build comprehensive results visualization UI for displaying backtest performance metrics, equity curves, drawdown charts, and trade history. Includes interactive charts with Recharts, performance metrics dashboard, monthly/yearly heatmaps, trade analysis tables, and export functionality for PDF/Excel reports. The interface will provide in-depth analysis tools for understanding strategy performance.

## Acceptance Criteria

- [ ] **Performance Metrics Dashboard**
  - [ ] Key metrics cards (Total Return, CAGR, Sharpe, Sortino, Max DD)
  - [ ] Comparison with benchmark
  - [ ] Win rate and profit factor
  - [ ] Trade statistics (total, avg profit/loss)
  - [ ] Color coding (green for positive, red for negative)
- [ ] **Equity Curve Chart**
  - [ ] Line chart showing portfolio value over time
  - [ ] Overlay benchmark comparison
  - [ ] Interactive hover tooltips
  - [ ] Zoom and pan functionality
  - [ ] Log/linear scale toggle
  - [ ] Show drawdown periods
- [ ] **Drawdown Chart**
  - [ ] Area chart showing underwater equity
  - [ ] Highlight maximum drawdown period
  - [ ] Drawdown recovery markers
  - [ ] Percentage and dollar drawdown views
- [ ] **Returns Heatmap**
  - [ ] Monthly returns grid (years x months)
  - [ ] Color gradient (red to green)
  - [ ] Yearly totals column
  - [ ] Monthly average row
  - [ ] Hover details
- [ ] **Trade History Table**
  - [ ] Sortable columns (symbol, date, P/L, %)
  - [ ] Pagination (50 trades per page)
  - [ ] Filter by symbol, date range, profit/loss
  - [ ] Search functionality
  - [ ] Expandable row details
  - [ ] Trade-level statistics
- [ ] **Export Functionality**
  - [ ] PDF report generation
  - [ ] Excel export (trades, metrics)
  - [ ] CSV export for raw data
  - [ ] Share link generation
  - [ ] Print-friendly view
- [ ] **Responsive Design**
  - [ ] Mobile-optimized charts
  - [ ] Tablet layout adjustments
  - [ ] Desktop full-screen mode

## Subtasks

### 1. Project Setup and Dependencies
- [ ] Install required packages
  - [ ] `recharts>=2.10.0` - Charting library
  - [ ] `d3-scale>=4.0.0` - Color scales for heatmap
  - [ ] `react-table>=7.8.0` or `@tanstack/react-table>=8.0.0` - Table component
  - [ ] `jspdf>=2.5.0` - PDF generation
  - [ ] `jspdf-autotable>=3.8.0` - PDF tables
  - [ ] `xlsx>=0.18.0` - Excel export
  - [ ] `date-fns>=3.0.0` - Date formatting
  - [ ] `react-to-print>=2.15.0` - Print functionality
  - [ ] `html2canvas>=1.4.0` - Chart to image conversion
- [ ] Setup component structure
  - [ ] Create `components/backtest/results/` directory
  - [ ] Create `hooks/useBacktestResults.ts`
  - [ ] Create `utils/chartHelpers.ts`
  - [ ] Create `utils/exportHelpers.ts`

### 2. Type Definitions and Data Models
- [ ] Define TypeScript interfaces
  - [ ] `BacktestResults` - Complete results structure
  - [ ] `PerformanceMetrics` - All metrics
  - [ ] `EquityPoint` - Equity curve data point
  - [ ] `DrawdownPoint` - Drawdown data point
  - [ ] `Trade` - Individual trade details
  - [ ] `MonthlyReturns` - Heatmap data structure
- [ ] Create data transformation utilities
  - [ ] Transform API response to chart format
  - [ ] Calculate derived metrics
  - [ ] Aggregate trade statistics

### 3. Performance Metrics Dashboard
- [ ] Create `MetricsDashboard` component
  - [ ] Grid layout for metric cards
  - [ ] Responsive sizing
  - [ ] Loading states
- [ ] Build `MetricCard` component
  - [ ] Metric name and value
  - [ ] Comparison with benchmark
  - [ ] Percentage change indicator
  - [ ] Color coding
  - [ ] Tooltip with explanation
- [ ] Implement metric calculations
  - [ ] Total return calculation
  - [ ] Annualized return (CAGR)
  - [ ] Risk metrics (Sharpe, Sortino)
  - [ ] Drawdown metrics
  - [ ] Trade statistics

### 4. Equity Curve Chart
- [ ] Create `EquityCurveChart` component
  - [ ] Responsive container
  - [ ] Line chart with Recharts
  - [ ] Dual Y-axis (portfolio + benchmark)
  - [ ] Custom tooltips
  - [ ] Legend
- [ ] Implement chart features
  - [ ] Zoom controls
  - [ ] Pan functionality
  - [ ] Log/linear scale toggle
  - [ ] Date range selector
  - [ ] Export chart as image
- [ ] Add drawdown overlay
  - [ ] Shaded areas for drawdown periods
  - [ ] Max drawdown marker
  - [ ] Hover details

### 5. Drawdown Chart
- [ ] Create `DrawdownChart` component
  - [ ] Area chart visualization
  - [ ] Underwater equity (negative values)
  - [ ] Color gradient
  - [ ] Zero line reference
- [ ] Highlight features
  - [ ] Maximum drawdown period
  - [ ] Recovery periods
  - [ ] Duration markers
  - [ ] Percentage/dollar toggle
- [ ] Add statistics
  - [ ] Average drawdown
  - [ ] Max drawdown duration
  - [ ] Recovery time
  - [ ] Drawdown frequency

### 6. Returns Heatmap
- [ ] Create `ReturnsHeatmap` component
  - [ ] Grid layout (12 months x N years)
  - [ ] Color scale (red-white-green)
  - [ ] Cell labels (return percentages)
  - [ ] Totals row/column
- [ ] Implement interactivity
  - [ ] Hover tooltips
  - [ ] Click to filter trades
  - [ ] Highlight best/worst periods
- [ ] Add customization
  - [ ] Color scheme selector
  - [ ] Show/hide empty cells
  - [ ] Switch between returns/volatility

### 7. Trade History Table
- [ ] Create `TradeHistoryTable` component
  - [ ] React Table implementation
  - [ ] Column definitions
  - [ ] Sorting functionality
  - [ ] Pagination
- [ ] Implement columns
  - [ ] Symbol (with logo)
  - [ ] Entry/Exit dates
  - [ ] Entry/Exit prices
  - [ ] Quantity
  - [ ] Profit/Loss ($)
  - [ ] Profit/Loss (%)
  - [ ] Hold period
  - [ ] Actions (expand)
- [ ] Add filtering
  - [ ] Symbol search
  - [ ] Date range filter
  - [ ] Profit/loss filter
  - [ ] Status filter (open/closed)
- [ ] Implement expandable rows
  - [ ] Detailed trade info
  - [ ] Entry/exit reasons
  - [ ] Fees breakdown
  - [ ] Mini chart

### 8. Additional Charts
- [ ] Create `ReturnDistribution` chart
  - [ ] Histogram of daily/monthly returns
  - [ ] Normal distribution overlay
  - [ ] Statistics (mean, std dev)
- [ ] Create `RollingMetrics` chart
  - [ ] Rolling Sharpe ratio
  - [ ] Rolling volatility
  - [ ] Rolling beta
  - [ ] Configurable window (30/90/365 days)
- [ ] Create `MonthlyBarChart`
  - [ ] Bar chart of monthly returns
  - [ ] Color by positive/negative
  - [ ] Benchmark comparison

### 9. Export Functionality
- [ ] Implement PDF export
  - [ ] Generate PDF with jsPDF
  - [ ] Include summary metrics
  - [ ] Embed charts as images
  - [ ] Add trade table
  - [ ] Custom styling
- [ ] Implement Excel export
  - [ ] Metrics sheet
  - [ ] Trades sheet
  - [ ] Returns sheet
  - [ ] Formatting (colors, borders)
- [ ] Implement CSV export
  - [ ] Export trades
  - [ ] Export equity curve
  - [ ] Export monthly returns
- [ ] Add share functionality
  - [ ] Generate share link
  - [ ] Embed token for public access
  - [ ] QR code generation

### 10. User Experience Enhancements
- [ ] Add loading states
  - [ ] Skeleton charts
  - [ ] Loading spinners
  - [ ] Progressive loading
- [ ] Implement error states
  - [ ] Empty state illustrations
  - [ ] Error messages
  - [ ] Retry buttons
- [ ] Add customization
  - [ ] Dark/light theme
  - [ ] Chart color schemes
  - [ ] Layout preferences
  - [ ] Save view settings
- [ ] Implement tooltips
  - [ ] Metric explanations
  - [ ] Chart data details
  - [ ] Help icons

### 11. Testing
- [ ] Unit tests
  - [ ] Test data transformations
  - [ ] Test metric calculations
  - [ ] Test export functions
- [ ] Component tests
  - [ ] Render all charts
  - [ ] User interactions
  - [ ] Sorting and filtering
  - [ ] Export functionality
- [ ] Visual regression tests
  - [ ] Screenshot comparison
  - [ ] Chart rendering consistency
- [ ] Accessibility tests
  - [ ] Keyboard navigation
  - [ ] Screen reader support
  - [ ] Color contrast

## Implementation Details

### Type Definitions

```typescript
// types/backtestResults.ts
export interface PerformanceMetrics {
  totalReturn: number;
  cagr: number;
  sharpeRatio: number;
  sortinoRatio: number;
  maxDrawdown: number;
  maxDrawdownDuration: number; // days
  volatility: number;
  beta?: number;
  alpha?: number;
  winRate: number;
  profitFactor: number;
  totalTrades: number;
  avgProfit: number;
  avgLoss: number;
  avgHoldPeriod: number; // days
}

export interface EquityPoint {
  date: string;
  equity: number;
  benchmark?: number;
  drawdown?: number;
}

export interface DrawdownPoint {
  date: string;
  drawdown: number; // percentage
  drawdownDollar: number;
  underwater: boolean;
}

export interface Trade {
  id: string;
  symbol: string;
  entryDate: string;
  entryPrice: number;
  exitDate?: string;
  exitPrice?: number;
  quantity: number;
  pnl?: number;
  pnlPercent?: number;
  holdPeriod?: number; // days
  commission: number;
  slippage: number;
  status: 'open' | 'closed';
}

export interface MonthlyReturn {
  year: number;
  jan?: number;
  feb?: number;
  mar?: number;
  apr?: number;
  may?: number;
  jun?: number;
  jul?: number;
  aug?: number;
  sep?: number;
  oct?: number;
  nov?: number;
  dec?: number;
  yearTotal: number;
}

export interface BacktestResults {
  taskId: string;
  metrics: PerformanceMetrics;
  equityCurve: EquityPoint[];
  drawdownSeries: DrawdownPoint[];
  trades: Trade[];
  monthlyReturns: MonthlyReturn[];
  benchmarkMetrics?: PerformanceMetrics;
}
```

### Main Results Component

```typescript
// components/backtest/results/BacktestResults.tsx
import React, { useState } from 'react';
import { useBacktestResults } from '@/hooks/useBacktestResults';
import MetricsDashboard from './MetricsDashboard';
import EquityCurveChart from './EquityCurveChart';
import DrawdownChart from './DrawdownChart';
import ReturnsHeatmap from './ReturnsHeatmap';
import TradeHistoryTable from './TradeHistoryTable';
import ExportButtons from './ExportButtons';
import { Tabs, TabList, Tab, TabPanel } from '@/components/ui/Tabs';

interface BacktestResultsProps {
  taskId: string;
}

export const BacktestResults: React.FC<BacktestResultsProps> = ({ taskId }) => {
  const { data: results, isLoading, error } = useBacktestResults(taskId);
  const [selectedTab, setSelectedTab] = useState(0);

  if (isLoading) {
    return <ResultsSkeleton />;
  }

  if (error) {
    return (
      <div className="rounded-lg bg-red-50 p-6">
        <h3 className="text-lg font-medium text-red-800">
          Failed to load backtest results
        </h3>
        <p className="mt-2 text-sm text-red-600">{error.message}</p>
      </div>
    );
  }

  if (!results) {
    return (
      <div className="text-center py-12">
        <p className="text-gray-500">No results found</p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">
            Backtest Results
          </h1>
          <p className="mt-1 text-sm text-gray-600">
            Task ID: {taskId}
          </p>
        </div>
        <ExportButtons results={results} />
      </div>

      {/* Performance Metrics Dashboard */}
      <MetricsDashboard
        metrics={results.metrics}
        benchmarkMetrics={results.benchmarkMetrics}
      />

      {/* Tabbed Charts */}
      <Tabs selectedIndex={selectedTab} onChange={setSelectedTab}>
        <TabList className="border-b border-gray-200">
          <Tab>Equity Curve</Tab>
          <Tab>Drawdown</Tab>
          <Tab>Returns Heatmap</Tab>
          <Tab>Trade Analysis</Tab>
        </TabList>

        <TabPanel>
          <div className="mt-6 bg-white rounded-lg shadow p-6">
            <EquityCurveChart
              data={results.equityCurve}
              benchmarkIncluded={!!results.benchmarkMetrics}
            />
          </div>
        </TabPanel>

        <TabPanel>
          <div className="mt-6 bg-white rounded-lg shadow p-6">
            <DrawdownChart data={results.drawdownSeries} />
          </div>
        </TabPanel>

        <TabPanel>
          <div className="mt-6 bg-white rounded-lg shadow p-6">
            <ReturnsHeatmap data={results.monthlyReturns} />
          </div>
        </TabPanel>

        <TabPanel>
          <div className="mt-6 space-y-6">
            {/* Trade Statistics Summary */}
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-lg font-medium mb-4">Trade Statistics</h3>
              <TradeStatistics trades={results.trades} />
            </div>

            {/* Trade History Table */}
            <div className="bg-white rounded-lg shadow p-6">
              <TradeHistoryTable trades={results.trades} />
            </div>
          </div>
        </TabPanel>
      </Tabs>
    </div>
  );
};
```

### Metrics Dashboard Component

```typescript
// components/backtest/results/MetricsDashboard.tsx
import React from 'react';
import { PerformanceMetrics } from '@/types/backtestResults';
import MetricCard from './MetricCard';

interface MetricsDashboardProps {
  metrics: PerformanceMetrics;
  benchmarkMetrics?: PerformanceMetrics;
}

export const MetricsDashboard: React.FC<MetricsDashboardProps> = ({
  metrics,
  benchmarkMetrics,
}) => {
  const formatPercent = (value: number) => `${(value * 100).toFixed(2)}%`;
  const formatNumber = (value: number, decimals = 2) => value.toFixed(decimals);

  const metricsData = [
    {
      label: 'Total Return',
      value: formatPercent(metrics.totalReturn),
      benchmark: benchmarkMetrics ? formatPercent(benchmarkMetrics.totalReturn) : undefined,
      positive: metrics.totalReturn > 0,
      tooltip: 'Total return over the backtest period',
    },
    {
      label: 'CAGR',
      value: formatPercent(metrics.cagr),
      benchmark: benchmarkMetrics?.cagr ? formatPercent(benchmarkMetrics.cagr) : undefined,
      positive: metrics.cagr > 0,
      tooltip: 'Compound Annual Growth Rate',
    },
    {
      label: 'Sharpe Ratio',
      value: formatNumber(metrics.sharpeRatio),
      benchmark: benchmarkMetrics?.sharpeRatio ? formatNumber(benchmarkMetrics.sharpeRatio) : undefined,
      positive: metrics.sharpeRatio > 1,
      tooltip: 'Risk-adjusted return (higher is better)',
    },
    {
      label: 'Sortino Ratio',
      value: formatNumber(metrics.sortinoRatio),
      positive: metrics.sortinoRatio > 1,
      tooltip: 'Downside risk-adjusted return',
    },
    {
      label: 'Max Drawdown',
      value: formatPercent(metrics.maxDrawdown),
      benchmark: benchmarkMetrics?.maxDrawdown ? formatPercent(benchmarkMetrics.maxDrawdown) : undefined,
      positive: metrics.maxDrawdown > -0.1,
      inverse: true, // Lower is better
      tooltip: 'Maximum peak-to-trough decline',
    },
    {
      label: 'Volatility',
      value: formatPercent(metrics.volatility),
      positive: metrics.volatility < 0.2,
      inverse: true,
      tooltip: 'Annualized standard deviation of returns',
    },
    {
      label: 'Win Rate',
      value: formatPercent(metrics.winRate),
      positive: metrics.winRate > 0.5,
      tooltip: 'Percentage of profitable trades',
    },
    {
      label: 'Profit Factor',
      value: formatNumber(metrics.profitFactor),
      positive: metrics.profitFactor > 1,
      tooltip: 'Gross profit divided by gross loss',
    },
  ];

  return (
    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
      {metricsData.map((metric) => (
        <MetricCard key={metric.label} {...metric} />
      ))}
    </div>
  );
};
```

### Equity Curve Chart Component

```typescript
// components/backtest/results/EquityCurveChart.tsx
import React, { useState } from 'react';
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from 'recharts';
import { EquityPoint } from '@/types/backtestResults';
import { format } from 'date-fns';

interface EquityCurveChartProps {
  data: EquityPoint[];
  benchmarkIncluded: boolean;
}

export const EquityCurveChart: React.FC<EquityCurveChartProps> = ({
  data,
  benchmarkIncluded,
}) => {
  const [scale, setScale] = useState<'linear' | 'log'>('linear');

  const CustomTooltip = ({ active, payload, label }: any) => {
    if (active && payload && payload.length) {
      return (
        <div className="bg-white p-4 border border-gray-200 rounded shadow-lg">
          <p className="font-medium">{format(new Date(label), 'MMM dd, yyyy')}</p>
          <p className="text-blue-600">
            Portfolio: ${payload[0].value.toLocaleString()}
          </p>
          {benchmarkIncluded && payload[1] && (
            <p className="text-green-600">
              Benchmark: ${payload[1].value.toLocaleString()}
            </p>
          )}
          {payload[0].payload.drawdown && (
            <p className="text-red-600">
              Drawdown: {(payload[0].payload.drawdown * 100).toFixed(2)}%
            </p>
          )}
        </div>
      );
    }
    return null;
  };

  return (
    <div>
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-lg font-medium">Equity Curve</h3>
        <div className="flex gap-2">
          <button
            onClick={() => setScale('linear')}
            className={`px-3 py-1 rounded ${
              scale === 'linear'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-gray-700'
            }`}
          >
            Linear
          </button>
          <button
            onClick={() => setScale('log')}
            className={`px-3 py-1 rounded ${
              scale === 'log'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-gray-700'
            }`}
          >
            Log
          </button>
        </div>
      </div>

      <ResponsiveContainer width="100%" height={400}>
        <LineChart data={data}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis
            dataKey="date"
            tickFormatter={(value) => format(new Date(value), 'MMM yyyy')}
          />
          <YAxis
            scale={scale}
            domain={scale === 'log' ? ['auto', 'auto'] : undefined}
            tickFormatter={(value) => `$${(value / 1000).toFixed(0)}k`}
          />
          <Tooltip content={<CustomTooltip />} />
          <Legend />
          <Line
            type="monotone"
            dataKey="equity"
            stroke="#3B82F6"
            name="Portfolio"
            dot={false}
            strokeWidth={2}
          />
          {benchmarkIncluded && (
            <Line
              type="monotone"
              dataKey="benchmark"
              stroke="#10B981"
              name="Benchmark"
              dot={false}
              strokeWidth={2}
              strokeDasharray="5 5"
            />
          )}
        </LineChart>
      </ResponsiveContainer>
    </div>
  );
};
```

### Drawdown Chart Component

```typescript
// components/backtest/results/DrawdownChart.tsx
import React, { useState } from 'react';
import {
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  ReferenceLine,
} from 'recharts';
import { DrawdownPoint } from '@/types/backtestResults';
import { format } from 'date-fns';

interface DrawdownChartProps {
  data: DrawdownPoint[];
}

export const DrawdownChart: React.FC<DrawdownChartProps> = ({ data }) => {
  const [viewMode, setViewMode] = useState<'percent' | 'dollar'>('percent');

  const maxDrawdown = Math.min(...data.map((d) => d.drawdown));
  const maxDrawdownPoint = data.find((d) => d.drawdown === maxDrawdown);

  const CustomTooltip = ({ active, payload, label }: any) => {
    if (active && payload && payload.length) {
      const point = payload[0].payload;
      return (
        <div className="bg-white p-4 border border-gray-200 rounded shadow-lg">
          <p className="font-medium">{format(new Date(label), 'MMM dd, yyyy')}</p>
          <p className="text-red-600">
            Drawdown: {viewMode === 'percent'
              ? `${(point.drawdown * 100).toFixed(2)}%`
              : `$${point.drawdownDollar.toLocaleString()}`}
          </p>
        </div>
      );
    }
    return null;
  };

  return (
    <div>
      <div className="flex justify-between items-center mb-4">
        <div>
          <h3 className="text-lg font-medium">Drawdown</h3>
          <p className="text-sm text-gray-600">
            Max Drawdown: {(maxDrawdown * 100).toFixed(2)}%
            {maxDrawdownPoint && ` on ${format(new Date(maxDrawdownPoint.date), 'MMM dd, yyyy')}`}
          </p>
        </div>
        <div className="flex gap-2">
          <button
            onClick={() => setViewMode('percent')}
            className={`px-3 py-1 rounded ${
              viewMode === 'percent'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-gray-700'
            }`}
          >
            Percentage
          </button>
          <button
            onClick={() => setViewMode('dollar')}
            className={`px-3 py-1 rounded ${
              viewMode === 'dollar'
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-gray-700'
            }`}
          >
            Dollar
          </button>
        </div>
      </div>

      <ResponsiveContainer width="100%" height={300}>
        <AreaChart data={data}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis
            dataKey="date"
            tickFormatter={(value) => format(new Date(value), 'MMM yyyy')}
          />
          <YAxis
            tickFormatter={(value) =>
              viewMode === 'percent'
                ? `${(value * 100).toFixed(0)}%`
                : `$${(value / 1000).toFixed(0)}k`
            }
          />
          <Tooltip content={<CustomTooltip />} />
          <ReferenceLine y={0} stroke="#000" strokeDasharray="3 3" />
          <Area
            type="monotone"
            dataKey={viewMode === 'percent' ? 'drawdown' : 'drawdownDollar'}
            stroke="#EF4444"
            fill="#FEE2E2"
          />
        </AreaChart>
      </ResponsiveContainer>
    </div>
  );
};
```

### Returns Heatmap Component

```typescript
// components/backtest/results/ReturnsHeatmap.tsx
import React from 'react';
import { scaleLinear } from 'd3-scale';
import { MonthlyReturn } from '@/types/backtestResults';

interface ReturnsHeatmapProps {
  data: MonthlyReturn[];
}

export const ReturnsHeatmap: React.FC<ReturnsHeatmapProps> = ({ data }) => {
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const monthKeys = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];

  // Find min/max for color scale
  const allReturns = data.flatMap((year) =>
    monthKeys.map((key) => year[key as keyof MonthlyReturn] as number).filter((r) => r !== undefined)
  );
  const minReturn = Math.min(...allReturns);
  const maxReturn = Math.max(...allReturns);

  // Color scale: red (negative) -> white (0) -> green (positive)
  const colorScale = scaleLinear<string>()
    .domain([minReturn, 0, maxReturn])
    .range(['#FCA5A5', '#FFFFFF', '#86EFAC']);

  const formatReturn = (value: number | undefined) => {
    if (value === undefined) return '-';
    return `${(value * 100).toFixed(1)}%`;
  };

  return (
    <div>
      <h3 className="text-lg font-medium mb-4">Monthly Returns Heatmap</h3>

      <div className="overflow-x-auto">
        <table className="min-w-full border-collapse">
          <thead>
            <tr>
              <th className="border border-gray-300 px-4 py-2 bg-gray-50">Year</th>
              {months.map((month) => (
                <th key={month} className="border border-gray-300 px-4 py-2 bg-gray-50 text-sm">
                  {month}
                </th>
              ))}
              <th className="border border-gray-300 px-4 py-2 bg-gray-50">Total</th>
            </tr>
          </thead>
          <tbody>
            {data.map((yearData) => (
              <tr key={yearData.year}>
                <td className="border border-gray-300 px-4 py-2 font-medium text-center">
                  {yearData.year}
                </td>
                {monthKeys.map((monthKey, idx) => {
                  const value = yearData[monthKey as keyof MonthlyReturn] as number | undefined;
                  return (
                    <td
                      key={monthKey}
                      className="border border-gray-300 px-4 py-2 text-center text-sm"
                      style={{
                        backgroundColor: value !== undefined ? colorScale(value) : '#F3F4F6',
                      }}
                      title={value !== undefined ? formatReturn(value) : 'No data'}
                    >
                      {formatReturn(value)}
                    </td>
                  );
                })}
                <td
                  className="border border-gray-300 px-4 py-2 text-center font-medium"
                  style={{ backgroundColor: colorScale(yearData.yearTotal) }}
                >
                  {formatReturn(yearData.yearTotal)}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* Legend */}
      <div className="mt-4 flex items-center gap-4 text-sm">
        <span>Color scale:</span>
        <div className="flex items-center gap-2">
          <div className="w-8 h-4 bg-red-300"></div>
          <span>Negative</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-8 h-4 bg-white border border-gray-300"></div>
          <span>Zero</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-8 h-4 bg-green-300"></div>
          <span>Positive</span>
        </div>
      </div>
    </div>
  );
};
```

### Export Functionality

```typescript
// components/backtest/results/ExportButtons.tsx
import React, { useState } from 'react';
import { jsPDF } from 'jspdf';
import autoTable from 'jspdf-autotable';
import * as XLSX from 'xlsx';
import { BacktestResults } from '@/types/backtestResults';
import { format } from 'date-fns';

interface ExportButtonsProps {
  results: BacktestResults;
}

export const ExportButtons: React.FC<ExportButtonsProps> = ({ results }) => {
  const [exporting, setExporting] = useState(false);

  const exportToPDF = async () => {
    setExporting(true);
    try {
      const doc = new jsPDF();

      // Title
      doc.setFontSize(20);
      doc.text('Backtest Results Report', 14, 20);

      // Summary Metrics
      doc.setFontSize(14);
      doc.text('Performance Summary', 14, 35);

      const metricsData = [
        ['Metric', 'Value'],
        ['Total Return', `${(results.metrics.totalReturn * 100).toFixed(2)}%`],
        ['CAGR', `${(results.metrics.cagr * 100).toFixed(2)}%`],
        ['Sharpe Ratio', results.metrics.sharpeRatio.toFixed(2)],
        ['Sortino Ratio', results.metrics.sortinoRatio.toFixed(2)],
        ['Max Drawdown', `${(results.metrics.maxDrawdown * 100).toFixed(2)}%`],
        ['Win Rate', `${(results.metrics.winRate * 100).toFixed(2)}%`],
        ['Total Trades', results.metrics.totalTrades.toString()],
      ];

      autoTable(doc, {
        startY: 40,
        head: [metricsData[0]],
        body: metricsData.slice(1),
      });

      // Trade History
      doc.addPage();
      doc.setFontSize(14);
      doc.text('Trade History', 14, 20);

      const tradesData = results.trades.map((trade) => [
        trade.symbol,
        format(new Date(trade.entryDate), 'yyyy-MM-dd'),
        trade.exitDate ? format(new Date(trade.exitDate), 'yyyy-MM-dd') : '-',
        trade.quantity.toString(),
        trade.pnl ? `$${trade.pnl.toFixed(2)}` : '-',
        trade.pnlPercent ? `${(trade.pnlPercent * 100).toFixed(2)}%` : '-',
      ]);

      autoTable(doc, {
        startY: 25,
        head: [['Symbol', 'Entry Date', 'Exit Date', 'Quantity', 'P/L ($)', 'P/L (%)']],
        body: tradesData,
      });

      doc.save(`backtest-${results.taskId}.pdf`);
    } catch (error) {
      console.error('PDF export failed:', error);
    } finally {
      setExporting(false);
    }
  };

  const exportToExcel = () => {
    setExporting(true);
    try {
      const workbook = XLSX.utils.book_new();

      // Metrics sheet
      const metricsSheet = XLSX.utils.json_to_sheet([
        {
          Metric: 'Total Return',
          Value: `${(results.metrics.totalReturn * 100).toFixed(2)}%`,
        },
        { Metric: 'CAGR', Value: `${(results.metrics.cagr * 100).toFixed(2)}%` },
        { Metric: 'Sharpe Ratio', Value: results.metrics.sharpeRatio.toFixed(2) },
        { Metric: 'Sortino Ratio', Value: results.metrics.sortinoRatio.toFixed(2) },
        { Metric: 'Max Drawdown', Value: `${(results.metrics.maxDrawdown * 100).toFixed(2)}%` },
        { Metric: 'Win Rate', Value: `${(results.metrics.winRate * 100).toFixed(2)}%` },
        { Metric: 'Total Trades', Value: results.metrics.totalTrades },
      ]);
      XLSX.utils.book_append_sheet(workbook, metricsSheet, 'Metrics');

      // Trades sheet
      const tradesData = results.trades.map((trade) => ({
        Symbol: trade.symbol,
        'Entry Date': trade.entryDate,
        'Entry Price': trade.entryPrice,
        'Exit Date': trade.exitDate || '-',
        'Exit Price': trade.exitPrice || '-',
        Quantity: trade.quantity,
        'P/L': trade.pnl || '-',
        'P/L %': trade.pnlPercent ? `${(trade.pnlPercent * 100).toFixed(2)}%` : '-',
      }));
      const tradesSheet = XLSX.utils.json_to_sheet(tradesData);
      XLSX.utils.book_append_sheet(workbook, tradesSheet, 'Trades');

      // Equity curve sheet
      const equityData = results.equityCurve.map((point) => ({
        Date: point.date,
        Equity: point.equity,
        Benchmark: point.benchmark || '-',
      }));
      const equitySheet = XLSX.utils.json_to_sheet(equityData);
      XLSX.utils.book_append_sheet(workbook, equitySheet, 'Equity Curve');

      XLSX.writeFile(workbook, `backtest-${results.taskId}.xlsx`);
    } catch (error) {
      console.error('Excel export failed:', error);
    } finally {
      setExporting(false);
    }
  };

  const exportToCSV = () => {
    setExporting(true);
    try {
      const csv = results.trades
        .map((trade) =>
          [
            trade.symbol,
            trade.entryDate,
            trade.entryPrice,
            trade.exitDate || '',
            trade.exitPrice || '',
            trade.quantity,
            trade.pnl || '',
            trade.pnlPercent || '',
          ].join(',')
        )
        .join('\n');

      const header = 'Symbol,Entry Date,Entry Price,Exit Date,Exit Price,Quantity,P/L,P/L %\n';
      const blob = new Blob([header + csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `backtest-trades-${results.taskId}.csv`;
      link.click();
      URL.revokeObjectURL(url);
    } catch (error) {
      console.error('CSV export failed:', error);
    } finally {
      setExporting(false);
    }
  };

  return (
    <div className="flex gap-2">
      <button
        onClick={exportToPDF}
        disabled={exporting}
        className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50"
      >
        Export PDF
      </button>
      <button
        onClick={exportToExcel}
        disabled={exporting}
        className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
      >
        Export Excel
      </button>
      <button
        onClick={exportToCSV}
        disabled={exporting}
        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
      >
        Export CSV
      </button>
    </div>
  );
};
```

## Testing Strategy

### Unit Tests

```typescript
// tests/utils/chartHelpers.test.ts
import { transformEquityData, calculateDrawdownSeries } from '@/utils/chartHelpers';

describe('Chart Helpers', () => {
  it('transforms equity data correctly', () => {
    const rawData = [
      { date: '2023-01-01', value: 100000 },
      { date: '2023-01-02', value: 101000 },
    ];

    const transformed = transformEquityData(rawData);

    expect(transformed).toHaveLength(2);
    expect(transformed[0].equity).toBe(100000);
  });

  it('calculates drawdown series', () => {
    const equityData = [
      { date: '2023-01-01', equity: 100000 },
      { date: '2023-01-02', equity: 95000 },
      { date: '2023-01-03', equity: 98000 },
    ];

    const drawdowns = calculateDrawdownSeries(equityData);

    expect(drawdowns[1].drawdown).toBe(-0.05); // 5% drawdown
  });
});
```

### Component Tests

```typescript
// tests/components/EquityCurveChart.test.tsx
import { render, screen } from '@testing-library/react';
import { EquityCurveChart } from '@/components/backtest/results/EquityCurveChart';

describe('EquityCurveChart', () => {
  const mockData = [
    { date: '2023-01-01', equity: 100000, benchmark: 100000 },
    { date: '2023-02-01', equity: 105000, benchmark: 102000 },
  ];

  it('renders chart with data', () => {
    render(<EquityCurveChart data={mockData} benchmarkIncluded={true} />);

    expect(screen.getByText('Equity Curve')).toBeInTheDocument();
    expect(screen.getByText('Linear')).toBeInTheDocument();
    expect(screen.getByText('Log')).toBeInTheDocument();
  });

  it('toggles scale mode', async () => {
    const { getByText } = render(
      <EquityCurveChart data={mockData} benchmarkIncluded={true} />
    );

    const logButton = getByText('Log');
    fireEvent.click(logButton);

    // Verify log scale is applied (would need to check chart props)
  });
});
```

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Chart rendering performance with large datasets | High | Medium | Implement data sampling (max 1000 points), virtualization, progressive loading |
| PDF/Excel export memory issues | Medium | Medium | Stream large exports, chunk data, implement size limits |
| Browser compatibility (older versions) | Low | Low | Use polyfills, test on target browsers, graceful degradation |
| Color accessibility issues | Medium | Medium | Use colorblind-friendly palettes, add patterns/textures, test with accessibility tools |
| Mobile chart interaction difficulties | High | Medium | Implement touch-friendly controls, simplify mobile layouts, provide table fallback |
| Export format compatibility | Low | Low | Test with common tools (Excel, PDF readers), validate output format |
| Data precision loss in calculations | Low | High | Use precise decimal library, validate calculations, add unit tests |
| Large trade history table performance | Medium | Medium | Implement pagination, virtual scrolling, lazy loading |
| Chart tooltip overflow on mobile | Medium | Low | Responsive tooltip positioning, truncate long text, adaptive sizing |
| Time zone display inconsistencies | Medium | Medium | Use consistent UTC/local time, display timezone in UI, format dates carefully |

## Performance Requirements

| Metric | Target | Measurement Method |
|--------|--------|-------------------|
| Initial render time | < 1s | React DevTools Profiler |
| Chart interaction response | < 50ms | Performance API timing |
| Table sorting/filtering | < 200ms | User interaction timing |
| PDF generation time | < 5s for 1000 trades | Export function timing |
| Excel export time | < 3s for 1000 trades | Export function timing |
| Memory usage | < 100MB | Chrome DevTools Memory Profiler |
| Bundle size (charts module) | < 200KB gzipped | webpack-bundle-analyzer |
| Accessibility score | > 90 | Lighthouse, axe DevTools |

## Security Considerations

- Sanitize exported data (remove sensitive info)
- Validate all user inputs for filters
- Implement rate limiting on export functions
- Use secure PDF generation (no code injection)
- Validate chart data before rendering
- Implement CSP for external resources

## Error Handling

```typescript
// Graceful error handling in charts
const SafeChart = ({ data, ChartComponent }) => {
  if (!data || data.length === 0) {
    return (
      <div className="text-center py-12 text-gray-500">
        No data available to display
      </div>
    );
  }

  try {
    return <ChartComponent data={data} />;
  } catch (error) {
    console.error('Chart rendering error:', error);
    return (
      <div className="text-center py-12 text-red-500">
        Failed to render chart. Please try refreshing.
      </div>
    );
  }
};
```

## Progress

**0% - Not started**

## Notes

### Implementation Priority

1. **Phase 1**: Metrics dashboard and basic equity curve
2. **Phase 2**: Drawdown chart and heatmap
3. **Phase 3**: Trade history table with filters
4. **Phase 4**: Export functionality

### Dependencies

- **BT-004a**: Requires configuration UI completion
- **BT-003**: Requires API endpoints for data fetching
- **Recharts**: Primary charting library

### Technical Decisions

1. **Why Recharts over Chart.js?**
   - Better React integration
   - Declarative API
   - Built-in responsiveness
   - TypeScript support

2. **Why jsPDF for PDF generation?**
   - Client-side generation
   - No server dependency
   - Good table support with autoTable
   - Mature library

3. **Why XLSX library?**
   - Comprehensive Excel support
   - Works client-side
   - Good performance
   - Active maintenance

### Chart Optimizations

- Sample data to max 1000 points for large datasets
- Use React.memo for chart components
- Debounce chart updates on zoom/pan
- Lazy load chart libraries
- Cache processed chart data

### Future Enhancements

- **Interactive chart annotations**: Add notes to specific dates
- **Comparison mode**: Compare multiple backtests
- **Custom chart builder**: User-defined metrics charts
- **Real-time collaboration**: Share live backtest sessions
- **AI insights**: Automated performance analysis
- **Video export**: Export chart animations
