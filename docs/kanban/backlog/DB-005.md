# [DB-005] Order Book Schema and Storage

## Metadata
- **Status**: TODO
- **Priority**: Medium
- **Assignee**: TBD
- **Estimated Time**: 8 hours
- **Sprint**: Sprint 2 (Week 4)
- **Tags**: #database #schema #order-book #timescale

## Description
Design and implement database schema for storing order book (호가) data with TimescaleDB hypertable for efficient time-series storage and querying.

## Subtasks
- [ ] Schema Design
  - [ ] order_book table definition
  - [ ] Columns for 10-level bid/ask data
  - [ ] Timestamp and stock code
  - [ ] Spread calculation
  - [ ] Total volume aggregates
- [ ] Migration Script
  - [ ] database/migrations/06_order_book.sql
  - [ ] CREATE TABLE order_book
  - [ ] Convert to hypertable
  - [ ] Set up compression policy
  - [ ] Set up retention policy
- [ ] Indexes
  - [ ] Primary key (stock_code, timestamp)
  - [ ] Index on timestamp DESC
  - [ ] Partial index for recent data (last 7 days)
- [ ] TimescaleDB Setup
  - [ ] Create hypertable with 1-day chunks
  - [ ] Compression after 7 days
  - [ ] Retention 90 days (configurable)
  - [ ] Continuous aggregates for analytics
- [ ] Materialized Views
  - [ ] order_book_latest (latest for each stock)
  - [ ] order_book_spread_history (spread over time)
  - [ ] order_book_volume_summary (volume by hour)
- [ ] Database Functions
  - [ ] get_latest_order_book(stock_code)
  - [ ] calculate_order_imbalance(stock_code)
  - [ ] get_spread_history(stock_code, from_time, to_time)
- [ ] Data Validation
  - [ ] Check constraints (prices > 0, volumes >= 0)
  - [ ] Ensure ask >= bid (spread >= 0)
  - [ ] Validate data completeness
- [ ] Cleanup Procedures
  - [ ] Archive old data (> 90 days)
  - [ ] Vacuum and analyze schedule
  - [ ] Monitor table size

## Acceptance Criteria
- [ ] **Table Creation**
  - [ ] order_book table created successfully
  - [ ] Hypertable conversion successful
  - [ ] All indexes created
  - [ ] Constraints working correctly
- [ ] **Data Storage**
  - [ ] Can store 10-level bid/ask data
  - [ ] Timestamp accuracy to milliseconds
  - [ ] No duplicate records
  - [ ] Data types appropriate
- [ ] **Query Performance**
  - [ ] Latest order book query < 10ms
  - [ ] Historical query < 100ms
  - [ ] Spread calculation < 50ms
  - [ ] Aggregate queries < 500ms
- [ ] **Compression**
  - [ ] Data compressed after 7 days
  - [ ] Compression ratio > 10:1
  - [ ] Query performance maintained
- [ ] **Materialized Views**
  - [ ] order_book_latest shows current data
  - [ ] Refresh completes < 1 second
  - [ ] Views used in queries (EXPLAIN)
- [ ] **Functions**
  - [ ] get_latest_order_book() returns correct data
  - [ ] calculate_order_imbalance() accurate
  - [ ] Functions execute < 100ms
- [ ] **Data Integrity**
  - [ ] No NULL values in required fields
  - [ ] Ask prices >= bid prices
  - [ ] Volumes non-negative
  - [ ] Spread calculated correctly

## Dependencies
- **Depends on**: DB-001, DB-002
- **Blocks**: DP-004, BE-006, FE-005

## References
- **SDS.md**: Section 4.6 Order Book Schema (to be added)
- **database/migrations/06_order_book.sql** (to be created)
- [TimescaleDB Compression](https://docs.timescale.com/use-timescale/latest/compression/)
- [TimescaleDB Retention](https://docs.timescale.com/use-timescale/latest/data-retention/)

## Progress
- **0%** - Not started

## Notes
- Order book data is high-frequency (updates every second)
- Use TimescaleDB compression to save storage (90% reduction)
- Retention policy: keep 90 days, archive older data
- Consider partitioning by stock code if needed
- Monitor insert rate (should handle 1000+ inserts/sec)
- Use COPY or batch inserts for better performance
- Add trigger to update order_book_latest view
