# [DP-003] Indicator Calculation DAG Implementation

## Metadata
- **Status**: TODO
- **Priority**: Critical
- **Assignee**: TBD
- **Estimated Time**: 16 hours
- **Sprint**: Sprint 2 (Week 3-4)
- **Tags**: #data-pipeline #indicators #calculations

## Description
Implement Airflow DAG to calculate 200+ financial and technical indicators for all stocks. This enables the core screening functionality.

## Subtasks
- [ ] Indicator Calculator Class
  - [ ] data_pipeline/plugins/indicator_calculator.py
  - [ ] __init__(pg_hook) - database connection
  - [ ] calculate_all_indicators(stock_code, date) - main method
  - [ ] _get_price_history(stock_code, days=252)
  - [ ] _get_latest_financials(stock_code)
- [ ] Valuation Indicators
  - [ ] _calculate_valuation()
    - [ ] PER (Price-to-Earnings Ratio)
    - [ ] PBR (Price-to-Book Ratio)
    - [ ] PSR (Price-to-Sales Ratio)
    - [ ] PCR (Price-to-Cash Flow Ratio)
    - [ ] EV/EBITDA
    - [ ] Dividend Yield
    - [ ] Payout Ratio
- [ ] Profitability Indicators
  - [ ] _calculate_profitability()
    - [ ] ROE (Return on Equity)
    - [ ] ROA (Return on Assets)
    - [ ] ROIC (Return on Invested Capital)
    - [ ] Gross Margin
    - [ ] Operating Margin
    - [ ] Net Margin
    - [ ] EBITDA Margin
    - [ ] FCF Margin
- [ ] Growth Indicators
  - [ ] _calculate_growth()
    - [ ] Revenue Growth YoY
    - [ ] Profit Growth YoY
    - [ ] EPS Growth YoY
    - [ ] Revenue Growth QoQ
    - [ ] Profit Growth QoQ
    - [ ] Revenue CAGR (3Y, 5Y)
    - [ ] EPS CAGR (3Y, 5Y)
- [ ] Stability Indicators
  - [ ] _calculate_stability()
    - [ ] Debt-to-Equity Ratio
    - [ ] Debt-to-Assets Ratio
    - [ ] Interest Coverage Ratio
    - [ ] Current Ratio
    - [ ] Quick Ratio
    - [ ] Cash Ratio
    - [ ] Altman Z-Score
    - [ ] Piotroski F-Score
- [ ] Technical Indicators
  - [ ] _calculate_technical()
    - [ ] Price changes (1D, 1W, 1M, 3M, 6M, 1Y)
    - [ ] Volume surge percentage
    - [ ] Moving averages (MA20, MA60, MA120, MA200)
    - [ ] RSI (Relative Strength Index)
    - [ ] MACD (Moving Average Convergence Divergence)
- [ ] Composite Scores
  - [ ] _calculate_composite_scores()
    - [ ] Quality Score (0-100)
    - [ ] Value Score (0-100)
    - [ ] Growth Score (0-100)
    - [ ] Overall Score (0-100)
- [ ] DAG Definition
  - [ ] data_pipeline/dags/indicator_calculation_dag.py
  - [ ] Schedule: Triggered by daily_price_ingestion DAG
  - [ ] max_active_runs=1
  - [ ] execution_timeout=30 minutes
- [ ] Task 1: Calculate Indicators
  - [ ] PythonOperator: calculate_indicators
  - [ ] Loop through all active stocks
  - [ ] Call calculator.calculate_all_indicators()
  - [ ] UPSERT to calculated_indicators table
  - [ ] Batch commits (100 stocks)
  - [ ] Log progress every 100 stocks
  - [ ] Continue on individual stock errors
- [ ] Task 2: Refresh Materialized Views
  - [ ] PostgresOperator: refresh_materialized_views
  - [ ] Call refresh_all_materialized_views() function
  - [ ] REFRESH CONCURRENTLY stock_screening_view
  - [ ] REFRESH sector_performance view
- [ ] Task 3: Log Calculation Status
  - [ ] PostgresOperator: log_calculation_status
  - [ ] INSERT into data_ingestion_log
  - [ ] Record calculated/failed counts
- [ ] Error Handling
  - [ ] Continue processing if individual stock fails
  - [ ] Log failed stocks
  - [ ] Email alert if > 5% stocks fail
- [ ] Performance Optimization
  - [ ] Database connection pooling
  - [ ] Batch database operations
  - [ ] Consider parallel processing (Celery)

## Acceptance Criteria
- [ ] **DAG Visibility**
  - [ ] DAG appears in Airflow UI
  - [ ] Triggered successfully by daily_price_ingestion
- [ ] **Calculation Accuracy**
  - [ ] Spot-check 10 stocks, verify calculations manually
  - [ ] PER = Price / EPS ✓
  - [ ] ROE = Net Profit / Equity ✓
  - [ ] All formulas match financial definitions
- [ ] **Data Completeness**
  - [ ] All active stocks have indicators calculated
  - [ ] NULL values only where appropriate (e.g., PER when negative earnings)
- [ ] **Performance**
  - [ ] Full DAG run < 30 minutes for 2,400 stocks
  - [ ] Average < 1 second per stock
- [ ] **Error Handling**
  - [ ] Individual stock failures don't stop entire DAG
  - [ ] Failed stocks logged correctly
  - [ ] Email sent if > 5% failures
- [ ] **Materialized Views**
  - [ ] stock_screening_view refreshed successfully
  - [ ] View contains latest indicator data
  - [ ] View refresh completes in < 2 minutes
- [ ] **Logging**
  - [ ] Calculation status logged
  - [ ] Success/failure counts accurate

## Dependencies
- **Depends on**: DP-001, DP-002, DB-003, DB-004
- **Blocks**: BE-004 (Screening API depends on indicators)

## References
- **SDS.md**: Section 6.2.2 Indicator Calculation DAG
- **SDS.md**: Section 4.2.3 calculated_indicators table
- **data_pipeline/dags/indicator_calculation_dag.py** (implementation)
- **SRS.md**: REQ-DATA-002 Indicator Calculation

## Progress
- **0%** - Not started

## Notes
- **Critical for screening feature** - all 200+ indicators needed
- Formula accuracy is paramount - verify against industry standards
- Consider caching frequently used data (e.g., latest financials)
- Monitor memory usage (2,400 stocks × 200 indicators)
- Composite scores use proprietary logic (not industry standard)
