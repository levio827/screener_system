# KR-004: IPO Analysis

## Metadata

| Field | Value |
|-------|-------|
| **ID** | KR-004 |
| **Title** | Add IPO Analysis Feature |
| **Type** | Feature |
| **Status** | BACKLOG |
| **Priority** | P2 (Medium) |
| **Estimate** | 8 hours |
| **Sprint** | Sprint 8 |
| **Epic** | Korea Market Specialization |
| **Assignee** | TBD |
| **Created** | 2025-11-29 |
| **Tags** | i18n, korean-market, ipo, valuation |
| **Depends On** | KR-001 |

## Description

Implement a comprehensive IPO (Initial Public Offering) analysis feature for Korean stocks. This feature tracks upcoming IPOs, displays book-building results, analyzes offering valuations, and monitors post-listing performance. IPO investing is popular in Korea, and this feature will help users make informed decisions about new listings.

The system will aggregate data from multiple sources including the Korea Exchange, securities firms, and DART disclosures to provide complete IPO information.

## Subtasks

- [ ] **IPO Calendar Integration**
  - [ ] Scrape upcoming IPO schedules from Korea Exchange
  - [ ] Parse IPO registration statements from DART
  - [ ] Extract key dates (registration, book-building, subscription, listing)
  - [ ] Create database schema for IPO calendar
  - [ ] Implement automatic updates (daily sync)
- [ ] **Book-building Data Collection**
  - [ ] Collect book-building results (경쟁률, institutional demand)
  - [ ] Track subscription rates by investor type (기관, 일반)
  - [ ] Store offering price band and final price
  - [ ] Calculate oversubscription ratios
- [ ] **Valuation Analysis**
  - [ ] Extract financial metrics from registration statements
  - [ ] Identify comparable companies (peer group)
  - [ ] Calculate valuation multiples (P/E, P/B, EV/EBITDA)
  - [ ] Compare offering price to peer valuations
  - [ ] Generate valuation fairness assessment
- [ ] **Post-listing Performance Tracking**
  - [ ] Track first-day returns (시초가, 고가, 종가)
  - [ ] Monitor performance vs. offering price (1D, 1W, 1M, 3M)
  - [ ] Calculate lockup period expiration dates
  - [ ] Track insider selling after lockup
- [ ] **User Interface Components**
  - [ ] Upcoming IPO calendar widget
  - [ ] IPO detail page with full analysis
  - [ ] Subscription alert system
  - [ ] Performance comparison charts
- [ ] **Localization**
  - [ ] Korean IPO terminology (공모가, 청약, 상장)
  - [ ] Korean date and number formatting
  - [ ] Proper Hangul rendering

## Features

### Upcoming IPO Calendar
- **Company Information**: Company name (Korean/English), industry, size
- **Schedule**: Registration date, book-building period, subscription period, listing date
- **Offering Details**: Number of shares, offering price range, total offering size
- **Lead Underwriter**: Main underwriter and syndicate members
- **Use of Proceeds**: How the company plans to use raised capital

### Book-building Results
- **Institutional Demand**: Oversubscription ratio for institutional investors
- **Public Demand**: Oversubscription ratio for retail investors
- **Final Price**: Determined offering price within the price band
- **Allocation**: Share allocation breakdown by investor type

### Comparable Company Valuation
- **Peer Group**: Similar companies in same industry/size
- **Valuation Multiples**: P/E, P/B, P/S, EV/EBITDA comparisons
- **Growth Metrics**: Revenue growth, profit margin comparisons
- **Fairness Assessment**: Whether offering price is fair relative to peers

### Post-listing Tracking
- **First Day Performance**: Opening, high, low, closing prices
- **Returns**: Performance vs. offering price (%, multiples)
- **Volume Analysis**: Trading volume trends
- **Lockup Calendar**: Insider lockup expiration dates

## Implementation Details

### Database Schema

```sql
-- IPO calendar table
CREATE TABLE ipos (
    id SERIAL PRIMARY KEY,
    stock_code VARCHAR(20),  -- NULL before listing
    company_name_ko VARCHAR(200) NOT NULL,
    company_name_en VARCHAR(200),
    industry VARCHAR(100),
    market_type VARCHAR(20),  -- KOSPI, KOSDAQ, KONEX

    -- Schedule
    registration_date DATE,
    bookbuilding_start_date DATE,
    bookbuilding_end_date DATE,
    subscription_start_date DATE,
    subscription_end_date DATE,
    listing_date DATE,

    -- Offering details
    shares_offered BIGINT,
    offering_price_low INTEGER,
    offering_price_high INTEGER,
    final_offering_price INTEGER,
    total_offering_amount BIGINT,  -- KRW

    -- Book-building results
    institutional_competition_ratio DECIMAL(10, 2),
    retail_competition_ratio DECIMAL(10, 2),

    -- Lead underwriter
    lead_underwriter VARCHAR(200),

    -- Status
    status VARCHAR(20) DEFAULT 'scheduled',  -- scheduled, subscribed, listed, cancelled

    -- Additional info
    use_of_proceeds TEXT,
    company_description TEXT,
    dart_rcept_no VARCHAR(20),

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- IPO comparable companies
CREATE TABLE ipo_comparables (
    id SERIAL PRIMARY KEY,
    ipo_id INTEGER NOT NULL,
    comparable_stock_code VARCHAR(20) NOT NULL,
    comparable_company_name VARCHAR(200),

    -- Valuation metrics at IPO time
    pe_ratio DECIMAL(10, 2),
    pb_ratio DECIMAL(10, 2),
    ps_ratio DECIMAL(10, 2),
    ev_ebitda DECIMAL(10, 2),

    market_cap BIGINT,
    revenue_growth_yoy DECIMAL(10, 2),

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_ipo FOREIGN KEY (ipo_id)
        REFERENCES ipos(id) ON DELETE CASCADE
);

-- IPO post-listing performance
CREATE TABLE ipo_performance (
    id SERIAL PRIMARY KEY,
    ipo_id INTEGER NOT NULL,

    -- First day performance
    first_day_open INTEGER,
    first_day_high INTEGER,
    first_day_low INTEGER,
    first_day_close INTEGER,
    first_day_volume BIGINT,

    -- Returns vs offering price
    return_1d DECIMAL(10, 2),
    return_1w DECIMAL(10, 2),
    return_1m DECIMAL(10, 2),
    return_3m DECIMAL(10, 2),

    -- Lockup info
    lockup_expiration_date DATE,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_ipo FOREIGN KEY (ipo_id)
        REFERENCES ipos(id) ON DELETE CASCADE
);

-- Indexes
CREATE INDEX idx_ipos_listing_date ON ipos(listing_date DESC);
CREATE INDEX idx_ipos_status ON ipos(status);
CREATE INDEX idx_ipos_stock_code ON ipos(stock_code);
CREATE INDEX idx_ipo_comparables_ipo ON ipo_comparables(ipo_id);
```

### IPO Valuation Analyzer

```python
from typing import List, Dict, Optional
from dataclasses import dataclass
from decimal import Decimal
from datetime import date

@dataclass
class IPOValuation:
    """IPO valuation analysis result"""
    ipo_id: int
    company_name: str
    offering_price: int
    implied_market_cap: int
    implied_pe: Optional[Decimal]
    implied_pb: Optional[Decimal]
    peer_avg_pe: Optional[Decimal]
    peer_avg_pb: Optional[Decimal]
    valuation_assessment: str  # undervalued, fairly_valued, overvalued
    confidence: str  # high, medium, low

class IPOAnalyzer:
    """Analyze IPO valuations"""

    def __init__(self, session: AsyncSession):
        self.session = session

    async def analyze_ipo_valuation(self, ipo_id: int) -> IPOValuation:
        """
        Analyze IPO valuation against comparable companies
        """
        # Get IPO details
        ipo = await self.session.get(IPO, ipo_id)
        if not ipo:
            raise ValueError(f"IPO {ipo_id} not found")

        # Calculate implied metrics
        implied_market_cap = ipo.final_offering_price * ipo.shares_offered

        # Get financial data from registration statement
        financials = await self._get_ipo_financials(ipo_id)

        implied_pe = None
        implied_pb = None
        if financials:
            if financials['net_income'] and financials['net_income'] > 0:
                implied_pe = Decimal(implied_market_cap) / financials['net_income']
            if financials['book_value'] and financials['book_value'] > 0:
                implied_pb = Decimal(implied_market_cap) / financials['book_value']

        # Get comparable company valuations
        comparables = await self._get_comparable_valuations(ipo_id)

        peer_avg_pe = None
        peer_avg_pb = None
        if comparables:
            valid_pes = [c['pe_ratio'] for c in comparables if c['pe_ratio']]
            valid_pbs = [c['pb_ratio'] for c in comparables if c['pb_ratio']]

            if valid_pes:
                peer_avg_pe = sum(valid_pes) / len(valid_pes)
            if valid_pbs:
                peer_avg_pb = sum(valid_pbs) / len(valid_pbs)

        # Determine valuation assessment
        assessment, confidence = self._assess_valuation(
            implied_pe, implied_pb, peer_avg_pe, peer_avg_pb
        )

        return IPOValuation(
            ipo_id=ipo_id,
            company_name=ipo.company_name_ko,
            offering_price=ipo.final_offering_price,
            implied_market_cap=implied_market_cap,
            implied_pe=implied_pe,
            implied_pb=implied_pb,
            peer_avg_pe=peer_avg_pe,
            peer_avg_pb=peer_avg_pb,
            valuation_assessment=assessment,
            confidence=confidence
        )

    def _assess_valuation(
        self,
        implied_pe: Optional[Decimal],
        implied_pb: Optional[Decimal],
        peer_avg_pe: Optional[Decimal],
        peer_avg_pb: Optional[Decimal]
    ) -> tuple[str, str]:
        """
        Assess IPO valuation fairness

        Returns: (assessment, confidence)
        """
        if not implied_pe or not peer_avg_pe:
            return ("unknown", "low")

        pe_discount = ((peer_avg_pe - implied_pe) / peer_avg_pe) * 100

        # Simple assessment logic
        if pe_discount > 20:
            assessment = "undervalued"
        elif pe_discount < -20:
            assessment = "overvalued"
        else:
            assessment = "fairly_valued"

        # Confidence based on availability of metrics
        if implied_pe and implied_pb and peer_avg_pe and peer_avg_pb:
            confidence = "high"
        elif implied_pe and peer_avg_pe:
            confidence = "medium"
        else:
            confidence = "low"

        return (assessment, confidence)

    async def track_post_listing_performance(self, ipo_id: int) -> Dict:
        """
        Track IPO performance after listing
        """
        ipo = await self.session.get(IPO, ipo_id)
        if not ipo or not ipo.stock_code:
            raise ValueError(f"IPO {ipo_id} not listed yet")

        # Get price data
        today = date.today()

        # First day
        first_day_query = select(StockPrice).where(
            StockPrice.stock_code == ipo.stock_code,
            StockPrice.date == ipo.listing_date
        )
        first_day = (await self.session.execute(first_day_query)).scalar_one_or_none()

        # Calculate returns
        offering_price = ipo.final_offering_price
        returns = {}

        if first_day:
            returns['1d'] = ((first_day.close - offering_price) / offering_price) * 100

        # Get current price for other periods
        current_price_query = select(StockPrice).where(
            StockPrice.stock_code == ipo.stock_code,
            StockPrice.date <= today
        ).order_by(StockPrice.date.desc()).limit(1)

        current = (await self.session.execute(current_price_query)).scalar_one_or_none()

        if current:
            current_return = ((current.close - offering_price) / offering_price) * 100
            days_since_listing = (current.date - ipo.listing_date).days

            if days_since_listing >= 7:
                returns['1w'] = current_return
            if days_since_listing >= 30:
                returns['1m'] = current_return
            if days_since_listing >= 90:
                returns['3m'] = current_return

        return {
            'ipo_id': ipo_id,
            'stock_code': ipo.stock_code,
            'listing_date': ipo.listing_date,
            'offering_price': offering_price,
            'current_price': current.close if current else None,
            'returns': returns,
            'first_day_data': {
                'open': first_day.open,
                'high': first_day.high,
                'low': first_day.low,
                'close': first_day.close,
                'volume': first_day.volume
            } if first_day else None
        }
```

## Acceptance Criteria

- [ ] **Upcoming IPO Calendar**
  - Display all scheduled IPOs with key dates
  - Show offering details (price range, size)
  - Update automatically from Korea Exchange and DART
  - Support filtering by industry and market type

- [ ] **Book-building Results Display**
  - Show institutional and retail competition ratios
  - Display final offering price determination
  - Historical book-building data for comparison
  - Highlight hot IPOs (high competition ratios)

- [ ] **Offering Price Band Information**
  - Display price range for book-building
  - Show price per share and total offering size
  - Calculate market cap at different price points
  - Display use of proceeds

- [ ] **Comparable Company Valuation Comparison**
  - Identify 3-5 comparable companies
  - Calculate and compare valuation multiples
  - Provide valuation fairness assessment
  - Display with Korean financial terminology

- [ ] **Listing Day Alerts**
  - Alert users on listing day morning
  - Send notifications for watched IPOs
  - Provide quick stats (offering price, expected opening)
  - Link to live stock page after listing

- [ ] **Post-listing Return Tracking**
  - Track first-day performance (opening to close)
  - Calculate returns vs. offering price (1D, 1W, 1M, 3M)
  - Display performance charts
  - Compare to market index performance

## Testing Strategy

### Unit Tests

```python
@pytest.mark.asyncio
async def test_ipo_valuation_analysis():
    """Test IPO valuation calculation"""
    analyzer = IPOAnalyzer(mock_session)

    valuation = await analyzer.analyze_ipo_valuation(ipo_id=1)

    assert isinstance(valuation, IPOValuation)
    assert valuation.offering_price > 0
    assert valuation.valuation_assessment in ['undervalued', 'fairly_valued', 'overvalued', 'unknown']

def test_valuation_assessment():
    """Test valuation fairness assessment logic"""
    analyzer = IPOAnalyzer(mock_session)

    # Test undervalued case
    assessment, conf = analyzer._assess_valuation(
        implied_pe=Decimal('10.0'),
        implied_pb=Decimal('1.5'),
        peer_avg_pe=Decimal('15.0'),
        peer_avg_pb=Decimal('2.0')
    )
    assert assessment == 'undervalued'
```

### Integration Tests

```python
@pytest.mark.integration
async def test_ipo_calendar_sync():
    """Test IPO calendar data sync"""
    # Simulate scraping IPO data
    ipo_data = {
        'company_name_ko': '테스트주식회사',
        'listing_date': date(2025, 3, 15),
        'offering_price_low': 10000,
        'offering_price_high': 12000,
    }

    async with AsyncSession() as session:
        ipo = IPO(**ipo_data)
        session.add(ipo)
        await session.commit()

        # Verify
        query = select(IPO).where(IPO.company_name_ko == '테스트주식회사')
        result = await session.execute(query)
        saved_ipo = result.scalar_one()

        assert saved_ipo.listing_date == date(2025, 3, 15)
```

### E2E Tests

```typescript
describe('IPO Analysis Features', () => {
  it('should display upcoming IPO calendar', async () => {
    await page.goto('/ipos');

    // Check Korean title
    expect(await page.textContent('h1')).toContain('공모주 일정');

    // Verify IPO items
    const ipos = await page.locator('[data-testid="ipo-item"]').all();
    expect(ipos.length).toBeGreaterThan(0);

    // Check date formatting
    const firstDate = await ipos[0].locator('.listing-date').textContent();
    expect(firstDate).toMatch(/\d{4}년 \d{1,2}월 \d{1,2}일/);
  });
});
```

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Data source unavailability (Korea Exchange) | Medium | High | Implement multiple data sources, cache recent data, manual entry option |
| IPO schedule changes or cancellations | High | Medium | Monitor DART for amendments, display status updates, send change notifications |
| Valuation model accuracy | Medium | Medium | Disclose methodology, show confidence levels, include disclaimer |
| Delayed or incorrect book-building data | Low | Medium | Verify against multiple sources, add data freshness indicators |

## Performance Requirements

- **IPO Calendar Load**: < 500ms for upcoming IPOs (next 3 months)
- **Valuation Analysis**: < 2 seconds per IPO
- **Post-listing Tracking**: < 300ms per IPO
- **Data Sync**: Complete daily sync within 10 minutes
- **Alert Delivery**: Within 30 minutes of listing day

## Security Considerations

- **Data Integrity**: Validate all scraped data before storing
- **Rate Limiting**: Limit scraping frequency to respect source ToS
- **Access Control**: Public IPO data, but track usage for abuse detection

## Error Handling

```python
async def sync_ipo_calendar_safe() -> bool:
    """Safely sync IPO calendar with error handling"""
    try:
        ipo_data = await scrape_korea_exchange_ipos()

        async with AsyncSession() as session:
            for data in ipo_data:
                try:
                    ipo = IPO(**data)
                    session.add(ipo)
                except Exception as e:
                    logger.error(f"Failed to add IPO {data.get('company_name_ko')}: {e}")
                    continue

            await session.commit()
            logger.info(f"Synced {len(ipo_data)} IPOs")
            return True

    except Exception as e:
        logger.exception(f"IPO calendar sync failed: {e}")
        return False
```

## Dependencies

- Backend: FastAPI, SQLAlchemy, BeautifulSoup (web scraping)
- Frontend: React, react-intl, Ant Design, recharts
- Infrastructure: PostgreSQL, Redis (caching)
- External: Korea Exchange website, DART API
- Internal: KR-001 (DART integration)

## References

- [IMPROVEMENT_TICKETS.md](../../IMPROVEMENT_TICKETS.md) - Epic 8: Korea Market Specialization
- [KR-001: DART Integration](KR-001.md)
- [Korea Exchange IPO Information](http://www.krx.co.kr)

## Notes

- IPO data often requires manual verification due to frequent changes
- Consider partnerships with securities firms for more accurate book-building data
- Lockup periods vary by company (typically 6-12 months for executives)
- IPO investment advice requires regulatory compliance (financial advisory license)

## Progress

**0% - Not started**
