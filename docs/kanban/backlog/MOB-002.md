# MOB-002: Core Navigation & Auth

## Metadata

| Field | Value |
|-------|-------|
| **ID** | MOB-002 |
| **Title** | Implement Navigation and Authentication |
| **Type** | Feature |
| **Status** | BACKLOG |
| **Priority** | P0 (Critical) |
| **Estimate** | 12 hours |
| **Sprint** | Sprint 5 |
| **Epic** | Mobile Application |
| **Assignee** | TBD |
| **Depends On** | MOB-001 |
| **Blocks** | MOB-003, MOB-004, MOB-005, MOB-006 |
| **Created** | 2025-11-29 |
| **Tags** | #mobile #navigation #authentication #security |

## Description

Implement the core navigation architecture using React Navigation 6 (or Expo Router) with a tab-based main interface and stack-based detail screens. Integrate complete authentication flow including email/password login, social authentication (Google, Kakao), secure token storage, and automatic token refresh mechanisms.

## Subtasks

### Navigation Setup
- [ ] Configure root navigation structure
  - [ ] Set up `NavigationContainer` with theme support
  - [ ] Configure deep linking scheme (`screener://`)
  - [ ] Set up navigation state persistence for development
- [ ] Implement Tab Navigator
  - [ ] Home tab with dashboard overview
  - [ ] Screener tab for stock filtering
  - [ ] Portfolio tab for holdings management
  - [ ] Alerts tab for price notifications
  - [ ] Settings tab for user preferences
  - [ ] Configure tab bar icons (custom SVG or icon library)
  - [ ] Implement badge indicators for alerts
- [ ] Implement Stack Navigator per tab
  - [ ] Stock detail screen stack
  - [ ] Filter configuration stack
  - [ ] Portfolio detail stack
  - [ ] Alert creation/edit stack
- [ ] Set up Modal Navigator
  - [ ] Filter selection modal
  - [ ] Sort options modal
  - [ ] Quick actions modal

### Authentication Flow
- [ ] Create authentication screens
  - [ ] Login screen with email/password
  - [ ] Register screen with validation
  - [ ] Forgot password screen
  - [ ] Email verification screen
  - [ ] Welcome/Onboarding screens
- [ ] Implement email/password authentication
  - [ ] Form validation with react-hook-form
  - [ ] Error message display
  - [ ] Loading states during API calls
  - [ ] Success/failure feedback (haptics)
- [ ] Implement social authentication
  - [ ] Google Sign-In with `expo-auth-session`
  - [ ] Kakao Login integration
  - [ ] Apple Sign-In (iOS required)
  - [ ] Handle OAuth callback deep links
- [ ] Secure token management
  - [ ] Store access token in `expo-secure-store`
  - [ ] Store refresh token separately
  - [ ] Implement token encryption
- [ ] Token refresh mechanism
  - [ ] Automatic refresh before expiration
  - [ ] Handle 401 responses with retry
  - [ ] Implement refresh queue to prevent race conditions
- [ ] Auto-login on app launch
  - [ ] Check for valid stored tokens
  - [ ] Validate token with backend
  - [ ] Navigate to appropriate screen

### Authentication State Management
- [ ] Create auth Zustand store
  - [ ] User state (profile, preferences)
  - [ ] Authentication status
  - [ ] Login/logout actions
  - [ ] Token refresh action
- [ ] Implement auth context/provider
  - [ ] Protected route wrapper
  - [ ] Auth loading state
  - [ ] Redirect logic

## Implementation Details

### Navigation Structure
```typescript
// src/navigation/types.ts
export type RootStackParamList = {
  Auth: NavigatorScreenParams<AuthStackParamList>;
  Main: NavigatorScreenParams<MainTabParamList>;
  Modal: NavigatorScreenParams<ModalStackParamList>;
};

export type AuthStackParamList = {
  Welcome: undefined;
  Login: undefined;
  Register: undefined;
  ForgotPassword: undefined;
  EmailVerification: { email: string };
};

export type MainTabParamList = {
  Home: undefined;
  Screener: undefined;
  Portfolio: undefined;
  Alerts: undefined;
  Settings: undefined;
};

export type HomeStackParamList = {
  Dashboard: undefined;
  StockDetail: { stockCode: string };
  News: { newsId: string };
};
```

### Tab Navigator Implementation
```typescript
// src/navigation/MainTabNavigator.tsx
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { useTheme } from '@react-navigation/native';
import Ionicons from '@expo/vector-icons/Ionicons';

const Tab = createBottomTabNavigator<MainTabParamList>();

export function MainTabNavigator() {
  const { colors } = useTheme();

  return (
    <Tab.Navigator
      screenOptions={({ route }) => ({
        tabBarIcon: ({ focused, color, size }) => {
          const icons: Record<string, keyof typeof Ionicons.glyphMap> = {
            Home: focused ? 'home' : 'home-outline',
            Screener: focused ? 'search' : 'search-outline',
            Portfolio: focused ? 'pie-chart' : 'pie-chart-outline',
            Alerts: focused ? 'notifications' : 'notifications-outline',
            Settings: focused ? 'settings' : 'settings-outline',
          };
          return <Ionicons name={icons[route.name]} size={size} color={color} />;
        },
        tabBarActiveTintColor: colors.primary,
        tabBarInactiveTintColor: colors.text,
        headerShown: false,
      })}
    >
      <Tab.Screen name="Home" component={HomeStack} />
      <Tab.Screen name="Screener" component={ScreenerStack} />
      <Tab.Screen name="Portfolio" component={PortfolioStack} />
      <Tab.Screen
        name="Alerts"
        component={AlertsStack}
        options={{
          tabBarBadge: unreadAlerts > 0 ? unreadAlerts : undefined,
        }}
      />
      <Tab.Screen name="Settings" component={SettingsStack} />
    </Tab.Navigator>
  );
}
```

### Secure Token Storage
```typescript
// src/services/secureStorage.ts
import * as SecureStore from 'expo-secure-store';

const ACCESS_TOKEN_KEY = 'auth_access_token';
const REFRESH_TOKEN_KEY = 'auth_refresh_token';
const USER_DATA_KEY = 'auth_user_data';

export const secureStorage = {
  async setTokens(accessToken: string, refreshToken: string): Promise<void> {
    await Promise.all([
      SecureStore.setItemAsync(ACCESS_TOKEN_KEY, accessToken),
      SecureStore.setItemAsync(REFRESH_TOKEN_KEY, refreshToken),
    ]);
  },

  async getAccessToken(): Promise<string | null> {
    return SecureStore.getItemAsync(ACCESS_TOKEN_KEY);
  },

  async getRefreshToken(): Promise<string | null> {
    return SecureStore.getItemAsync(REFRESH_TOKEN_KEY);
  },

  async clearTokens(): Promise<void> {
    await Promise.all([
      SecureStore.deleteItemAsync(ACCESS_TOKEN_KEY),
      SecureStore.deleteItemAsync(REFRESH_TOKEN_KEY),
      SecureStore.deleteItemAsync(USER_DATA_KEY),
    ]);
  },

  async setUserData(user: User): Promise<void> {
    await SecureStore.setItemAsync(USER_DATA_KEY, JSON.stringify(user));
  },

  async getUserData(): Promise<User | null> {
    const data = await SecureStore.getItemAsync(USER_DATA_KEY);
    return data ? JSON.parse(data) : null;
  },
};
```

### Auth Store with Token Refresh
```typescript
// src/store/authStore.ts
import { create } from 'zustand';
import { secureStorage } from '../services/secureStorage';
import { authApi } from '../services/api';

interface AuthState {
  user: User | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  login: (email: string, password: string) => Promise<void>;
  loginWithGoogle: () => Promise<void>;
  loginWithKakao: () => Promise<void>;
  logout: () => Promise<void>;
  refreshToken: () => Promise<boolean>;
  checkAuth: () => Promise<void>;
}

export const useAuthStore = create<AuthState>((set, get) => ({
  user: null,
  isAuthenticated: false,
  isLoading: true,

  login: async (email, password) => {
    const response = await authApi.login({ email, password });
    await secureStorage.setTokens(response.accessToken, response.refreshToken);
    await secureStorage.setUserData(response.user);
    set({ user: response.user, isAuthenticated: true });
  },

  loginWithGoogle: async () => {
    // OAuth flow with expo-auth-session
    const { accessToken, refreshToken, user } = await authApi.googleAuth();
    await secureStorage.setTokens(accessToken, refreshToken);
    await secureStorage.setUserData(user);
    set({ user, isAuthenticated: true });
  },

  logout: async () => {
    await secureStorage.clearTokens();
    set({ user: null, isAuthenticated: false });
  },

  refreshToken: async () => {
    try {
      const refreshToken = await secureStorage.getRefreshToken();
      if (!refreshToken) return false;

      const response = await authApi.refresh(refreshToken);
      await secureStorage.setTokens(response.accessToken, response.refreshToken);
      return true;
    } catch {
      await get().logout();
      return false;
    }
  },

  checkAuth: async () => {
    try {
      const [accessToken, userData] = await Promise.all([
        secureStorage.getAccessToken(),
        secureStorage.getUserData(),
      ]);

      if (accessToken && userData) {
        // Verify token with backend
        const isValid = await authApi.verifyToken(accessToken);
        if (isValid) {
          set({ user: userData, isAuthenticated: true, isLoading: false });
          return;
        }
        // Try refresh if access token expired
        const refreshed = await get().refreshToken();
        if (refreshed) {
          set({ user: userData, isAuthenticated: true, isLoading: false });
          return;
        }
      }
      set({ isLoading: false });
    } catch {
      set({ isLoading: false });
    }
  },
}));
```

### Social Login Implementation
```typescript
// src/services/socialAuth.ts
import * as AuthSession from 'expo-auth-session';
import * as Google from 'expo-auth-session/providers/google';
import * as WebBrowser from 'expo-web-browser';

WebBrowser.maybeCompleteAuthSession();

export function useGoogleAuth() {
  const [request, response, promptAsync] = Google.useAuthRequest({
    expoClientId: process.env.EXPO_GOOGLE_CLIENT_ID,
    iosClientId: process.env.IOS_GOOGLE_CLIENT_ID,
    androidClientId: process.env.ANDROID_GOOGLE_CLIENT_ID,
  });

  useEffect(() => {
    if (response?.type === 'success') {
      const { authentication } = response;
      // Exchange Google token with backend
      handleGoogleToken(authentication.accessToken);
    }
  }, [response]);

  return { request, promptAsync };
}

// Kakao Login
export async function loginWithKakao(): Promise<AuthResult> {
  const redirectUri = AuthSession.makeRedirectUri({
    scheme: 'screener',
    path: 'auth/kakao',
  });

  const authUrl = `https://kauth.kakao.com/oauth/authorize?client_id=${
    process.env.KAKAO_CLIENT_ID
  }&redirect_uri=${redirectUri}&response_type=code`;

  const result = await AuthSession.startAsync({ authUrl });

  if (result.type === 'success') {
    return authApi.kakaoAuth(result.params.code);
  }
  throw new Error('Kakao login cancelled');
}
```

## Acceptance Criteria

- [ ] Tab navigation works with smooth transitions
- [ ] Deep linking opens correct screens (`screener://stock/005930`)
- [ ] Login with email/password works correctly
- [ ] Login with Google redirects and authenticates
- [ ] Login with Kakao redirects and authenticates
- [ ] Apple Sign-In works on iOS devices
- [ ] Tokens are stored securely (not in AsyncStorage)
- [ ] Auto-login works after app restart
- [ ] Token refresh happens automatically before expiration
- [ ] 401 errors trigger token refresh and retry
- [ ] Logout clears all stored credentials
- [ ] Protected routes redirect to login when unauthenticated
- [ ] Loading states show during authentication
- [ ] Error messages display for failed login attempts

## Testing Strategy

### Unit Tests
- [ ] Auth store actions (login, logout, refresh)
- [ ] Secure storage operations
- [ ] Token validation logic
- [ ] Navigation state management

### Integration Tests
- [ ] Full login flow with mock API
- [ ] Token refresh flow
- [ ] Social auth callback handling
- [ ] Deep link navigation

### E2E Tests (Detox)
- [ ] Complete login journey
- [ ] Tab navigation flows
- [ ] Protected route redirects
- [ ] Auto-login after app restart

### Manual Testing
- [ ] Test on physical iOS device (Apple Sign-In)
- [ ] Test on physical Android device
- [ ] Test deep links from external apps
- [ ] Test auth state across app backgrounding

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| OAuth callback failures | Medium | High | Thorough deep link testing, error handling |
| Token storage security breach | Low | Critical | Use expo-secure-store, regular security audits |
| Social login SDK compatibility | Medium | Medium | Pin SDK versions, test updates in staging |
| Race conditions in token refresh | Medium | High | Implement refresh queue with mutex |
| Session hijacking | Low | Critical | Implement refresh token rotation |

## Performance Requirements

- Navigation transition: < 300ms
- Login API response handling: < 100ms (client-side)
- Token refresh: Background, non-blocking
- App launch to home screen (with auto-login): < 2 seconds
- Secure store read/write: < 50ms

## Security Considerations

- [ ] Use `expo-secure-store` for all tokens (Keychain on iOS, EncryptedSharedPreferences on Android)
- [ ] Implement certificate pinning for auth endpoints
- [ ] Validate all OAuth redirect URIs server-side
- [ ] Implement refresh token rotation
- [ ] Add rate limiting awareness for login attempts
- [ ] Never log tokens or sensitive auth data
- [ ] Implement biometric authentication option for re-login
- [ ] Clear credentials on logout completely

## Error Handling

### Authentication Errors
```typescript
// src/utils/authErrors.ts
export const AUTH_ERRORS = {
  INVALID_CREDENTIALS: '이메일 또는 비밀번호가 올바르지 않습니다.',
  NETWORK_ERROR: '네트워크 연결을 확인해주세요.',
  TOKEN_EXPIRED: '세션이 만료되었습니다. 다시 로그인해주세요.',
  SOCIAL_AUTH_CANCELLED: '소셜 로그인이 취소되었습니다.',
  SOCIAL_AUTH_FAILED: '소셜 로그인에 실패했습니다. 다시 시도해주세요.',
  ACCOUNT_LOCKED: '계정이 잠겼습니다. 고객센터에 문의해주세요.',
};

export function handleAuthError(error: unknown): string {
  if (error instanceof ApiError) {
    switch (error.code) {
      case 'AUTH001': return AUTH_ERRORS.INVALID_CREDENTIALS;
      case 'AUTH002': return AUTH_ERRORS.TOKEN_EXPIRED;
      case 'AUTH003': return AUTH_ERRORS.ACCOUNT_LOCKED;
      default: return error.message;
    }
  }
  if (error instanceof NetworkError) {
    return AUTH_ERRORS.NETWORK_ERROR;
  }
  return '알 수 없는 오류가 발생했습니다.';
}
```

## Dependencies

- **Depends On**: MOB-001 (Mobile Project Setup)
- **Blocks**: MOB-003, MOB-004, MOB-005, MOB-006
- **External**:
  - Backend authentication endpoints
  - Google OAuth credentials
  - Kakao OAuth credentials
  - Apple Developer account (for Sign in with Apple)

## References

- **SDS.md**: Section 4.2 Mobile Authentication Flow
- [React Navigation Documentation](https://reactnavigation.org/docs/getting-started)
- [Expo SecureStore](https://docs.expo.dev/versions/latest/sdk/securestore/)
- [Expo AuthSession](https://docs.expo.dev/versions/latest/sdk/auth-session/)
- [Apple Sign In with Expo](https://docs.expo.dev/versions/latest/sdk/apple-authentication/)
- [IMPROVEMENT_TICKETS.md](../../IMPROVEMENT_TICKETS.md) - Epic 3: Mobile Application

## Progress

- **0%** - Not started

## Notes

- Apple Sign-In is mandatory for iOS apps with social login options
- Consider biometric re-authentication for sensitive operations
- Implement "Remember me" option for persistent sessions
- Test OAuth flows on actual devices (simulator limitations)
- Keep login form simple - avoid requiring too many fields on mobile
- Implement proper keyboard handling on login screens
