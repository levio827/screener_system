# MOB-004: Stock Detail Screen

## Metadata

| Field | Value |
|-------|-------|
| **ID** | MOB-004 |
| **Title** | Build Stock Detail Screen |
| **Type** | Feature |
| **Status** | BACKLOG |
| **Priority** | P0 (Critical) |
| **Estimate** | 16 hours |
| **Sprint** | Sprint 6 |
| **Epic** | Mobile Application |
| **Assignee** | TBD |
| **Depends On** | MOB-002 |
| **Blocks** | MOB-006 |
| **Created** | 2025-11-29 |
| **Tags** | #mobile #stock-detail #charts #financials |

## Description

Build a comprehensive stock detail screen optimized for mobile viewing, featuring interactive price charts, key financial metrics, financial statement data, news/disclosures, and quick action buttons. The screen should provide all essential information investors need to make decisions while maintaining excellent performance and usability on mobile devices.

## Subtasks

### Header Section
- [ ] Create stock info header
  - [ ] Stock name (Korean)
  - [ ] Stock code and market (KOSPI/KOSDAQ)
  - [ ] Current price with real-time updates
  - [ ] Price change amount and percentage
  - [ ] Change direction indicator (arrow + color)
  - [ ] Market status indicator (open/closed/pre-market)
- [ ] Implement header actions
  - [ ] Add to watchlist button (star icon)
  - [ ] Share button (native share sheet)
  - [ ] Set alert button
  - [ ] Back navigation

### Interactive Chart
- [ ] Implement price chart
  - [ ] Use `react-native-wagmi-charts` or similar
  - [ ] Line chart with gradient fill
  - [ ] Touch to see specific price points
  - [ ] Crosshair with price/date tooltip
- [ ] Period selection tabs
  - [ ] 1D (1 minute intervals)
  - [ ] 1W (15 minute intervals)
  - [ ] 1M (daily)
  - [ ] 3M (daily)
  - [ ] 1Y (daily)
  - [ ] All (weekly)
- [ ] Chart interactions
  - [ ] Pinch to zoom (optional)
  - [ ] Pan to scroll historical data
  - [ ] Double tap to reset view
- [ ] Technical indicators (optional)
  - [ ] Moving averages overlay
  - [ ] Volume bars below chart

### Key Metrics Cards
- [ ] Create metrics card grid
  - [ ] Market Cap (시가총액)
  - [ ] P/E Ratio (PER)
  - [ ] P/B Ratio (PBR)
  - [ ] EPS (주당순이익)
  - [ ] Dividend Yield (배당수익률)
  - [ ] 52-Week High/Low
  - [ ] Volume (거래량)
  - [ ] Beta (베타)
- [ ] Implement metric details
  - [ ] Tap to see historical comparison
  - [ ] Industry average comparison
  - [ ] Tooltip explanations

### Tabbed Content Section
- [ ] Create tab navigator
  - [ ] Overview (개요)
  - [ ] Financials (재무제표)
  - [ ] News (뉴스)
  - [ ] Disclosure (공시)
- [ ] Overview tab
  - [ ] Company description
  - [ ] Industry/Sector information
  - [ ] Key executives
  - [ ] Contact information
- [ ] Financials tab
  - [ ] Income statement summary
  - [ ] Balance sheet summary
  - [ ] Cash flow summary
  - [ ] YoY/QoQ comparison
  - [ ] Expandable detailed view
- [ ] News tab
  - [ ] Latest news list
  - [ ] News source and timestamp
  - [ ] Tap to open in browser
  - [ ] Infinite scroll
- [ ] Disclosure tab
  - [ ] DART disclosures list
  - [ ] Disclosure type badges
  - [ ] Tap to open official document

### Action Buttons
- [ ] Implement floating action area
  - [ ] "Add to Watchlist" primary action
  - [ ] "Create Alert" secondary action
  - [ ] "Add to Portfolio" action
- [ ] Implement share functionality
  - [ ] Native share sheet
  - [ ] Generate shareable link
  - [ ] Share with chart screenshot (optional)

## Implementation Details

### Stock Detail Screen Structure
```typescript
// src/screens/StockDetailScreen.tsx
import { useRoute, useNavigation } from '@react-navigation/native';
import { useQuery } from '@tanstack/react-query';
import Animated, { useAnimatedScrollHandler, useSharedValue } from 'react-native-reanimated';

export function StockDetailScreen() {
  const route = useRoute<StockDetailRouteProp>();
  const { stockCode } = route.params;
  const navigation = useNavigation();

  const scrollY = useSharedValue(0);

  const { data: stock, isLoading, error } = useQuery({
    queryKey: ['stock', stockCode],
    queryFn: () => stockApi.getDetail(stockCode),
  });

  const scrollHandler = useAnimatedScrollHandler({
    onScroll: (event) => {
      scrollY.value = event.contentOffset.y;
    },
  });

  if (isLoading) return <StockDetailSkeleton />;
  if (error) return <ErrorView error={error} onRetry={refetch} />;

  return (
    <View style={styles.container}>
      <AnimatedHeader stock={stock} scrollY={scrollY} />
      <Animated.ScrollView
        onScroll={scrollHandler}
        scrollEventThrottle={16}
        showsVerticalScrollIndicator={false}
      >
        <StockInfoHeader stock={stock} />
        <PriceChart stockCode={stockCode} />
        <MetricsGrid metrics={stock.metrics} />
        <ContentTabs stockCode={stockCode} />
      </Animated.ScrollView>
      <ActionButtons stock={stock} />
    </View>
  );
}
```

### Interactive Price Chart
```typescript
// src/components/stock/PriceChart.tsx
import { LineChart } from 'react-native-wagmi-charts';
import { useState, useMemo } from 'react';

interface PriceChartProps {
  stockCode: string;
}

const PERIODS = [
  { key: '1D', label: '1일', interval: '1m' },
  { key: '1W', label: '1주', interval: '15m' },
  { key: '1M', label: '1개월', interval: '1d' },
  { key: '3M', label: '3개월', interval: '1d' },
  { key: '1Y', label: '1년', interval: '1d' },
  { key: 'ALL', label: '전체', interval: '1w' },
] as const;

export function PriceChart({ stockCode }: PriceChartProps) {
  const [selectedPeriod, setSelectedPeriod] = useState<string>('1M');

  const { data: priceData, isLoading } = useQuery({
    queryKey: ['stockPrice', stockCode, selectedPeriod],
    queryFn: () => stockApi.getPriceHistory(stockCode, selectedPeriod),
    staleTime: selectedPeriod === '1D' ? 60 * 1000 : 5 * 60 * 1000,
  });

  const chartData = useMemo(
    () =>
      priceData?.map((point) => ({
        timestamp: new Date(point.date).getTime(),
        value: point.close,
      })) ?? [],
    [priceData]
  );

  const priceChange = useMemo(() => {
    if (!priceData || priceData.length < 2) return { value: 0, percent: 0 };
    const first = priceData[0].close;
    const last = priceData[priceData.length - 1].close;
    return {
      value: last - first,
      percent: ((last - first) / first) * 100,
    };
  }, [priceData]);

  const isPositive = priceChange.percent >= 0;

  return (
    <View style={styles.chartContainer}>
      {isLoading ? (
        <ChartSkeleton />
      ) : (
        <LineChart.Provider data={chartData}>
          <LineChart height={200}>
            <LineChart.Path color={isPositive ? colors.positive : colors.negative}>
              <LineChart.Gradient />
            </LineChart.Path>
            <LineChart.CursorCrosshair>
              <LineChart.Tooltip />
            </LineChart.CursorCrosshair>
          </LineChart>
          <LineChart.DatetimeText />
          <LineChart.PriceText />
        </LineChart.Provider>
      )}

      <View style={styles.periodSelector}>
        {PERIODS.map((period) => (
          <TouchableOpacity
            key={period.key}
            style={[
              styles.periodButton,
              selectedPeriod === period.key && styles.periodButtonActive,
            ]}
            onPress={() => setSelectedPeriod(period.key)}
          >
            <Text
              style={[
                styles.periodText,
                selectedPeriod === period.key && styles.periodTextActive,
              ]}
            >
              {period.label}
            </Text>
          </TouchableOpacity>
        ))}
      </View>
    </View>
  );
}
```

### Metrics Grid Component
```typescript
// src/components/stock/MetricsGrid.tsx
interface MetricItem {
  key: string;
  label: string;
  value: string | number | null;
  format: 'number' | 'currency' | 'percent' | 'ratio';
  comparison?: {
    industryAvg: number;
    isGood: boolean;
  };
}

export function MetricsGrid({ metrics }: { metrics: StockMetrics }) {
  const metricItems: MetricItem[] = [
    { key: 'marketCap', label: '시가총액', value: metrics.marketCap, format: 'currency' },
    { key: 'per', label: 'PER', value: metrics.per, format: 'ratio' },
    { key: 'pbr', label: 'PBR', value: metrics.pbr, format: 'ratio' },
    { key: 'eps', label: 'EPS', value: metrics.eps, format: 'currency' },
    { key: 'dividendYield', label: '배당수익률', value: metrics.dividendYield, format: 'percent' },
    { key: 'volume', label: '거래량', value: metrics.volume, format: 'number' },
    { key: 'high52w', label: '52주 최고', value: metrics.high52Week, format: 'currency' },
    { key: 'low52w', label: '52주 최저', value: metrics.low52Week, format: 'currency' },
  ];

  return (
    <View style={styles.grid}>
      {metricItems.map((item) => (
        <MetricCard key={item.key} item={item} />
      ))}
    </View>
  );
}

function MetricCard({ item }: { item: MetricItem }) {
  const [showTooltip, setShowTooltip] = useState(false);

  return (
    <TouchableOpacity
      style={styles.metricCard}
      onPress={() => setShowTooltip(true)}
      onLongPress={() => showDetailModal(item)}
    >
      <Text style={styles.metricLabel}>{item.label}</Text>
      <Text style={styles.metricValue}>
        {item.value !== null ? formatMetric(item.value, item.format) : '-'}
      </Text>
      {item.comparison && (
        <Text
          style={[
            styles.comparison,
            item.comparison.isGood ? styles.positive : styles.negative,
          ]}
        >
          업종 평균: {formatMetric(item.comparison.industryAvg, item.format)}
        </Text>
      )}
    </TouchableOpacity>
  );
}
```

### Tabbed Content Section
```typescript
// src/components/stock/ContentTabs.tsx
import { createMaterialTopTabNavigator } from '@react-navigation/material-top-tabs';

const Tab = createMaterialTopTabNavigator();

export function ContentTabs({ stockCode }: { stockCode: string }) {
  return (
    <Tab.Navigator
      screenOptions={{
        tabBarScrollEnabled: true,
        tabBarLabelStyle: styles.tabLabel,
        tabBarIndicatorStyle: styles.tabIndicator,
        tabBarStyle: styles.tabBar,
        lazy: true,
      }}
    >
      <Tab.Screen name="Overview" options={{ title: '개요' }}>
        {() => <OverviewTab stockCode={stockCode} />}
      </Tab.Screen>
      <Tab.Screen name="Financials" options={{ title: '재무' }}>
        {() => <FinancialsTab stockCode={stockCode} />}
      </Tab.Screen>
      <Tab.Screen name="News" options={{ title: '뉴스' }}>
        {() => <NewsTab stockCode={stockCode} />}
      </Tab.Screen>
      <Tab.Screen name="Disclosure" options={{ title: '공시' }}>
        {() => <DisclosureTab stockCode={stockCode} />}
      </Tab.Screen>
    </Tab.Navigator>
  );
}

// Financials Tab with expandable sections
function FinancialsTab({ stockCode }: { stockCode: string }) {
  const { data: financials, isLoading } = useQuery({
    queryKey: ['financials', stockCode],
    queryFn: () => stockApi.getFinancials(stockCode),
  });

  if (isLoading) return <FinancialsSkeleton />;

  return (
    <ScrollView style={styles.tabContent}>
      <ExpandableSection title="손익계산서" defaultOpen>
        <FinancialTable
          data={financials.incomeStatement}
          columns={['매출액', '영업이익', '당기순이익']}
        />
      </ExpandableSection>
      <ExpandableSection title="재무상태표">
        <FinancialTable
          data={financials.balanceSheet}
          columns={['자산총계', '부채총계', '자본총계']}
        />
      </ExpandableSection>
      <ExpandableSection title="현금흐름표">
        <FinancialTable
          data={financials.cashFlow}
          columns={['영업활동', '투자활동', '재무활동']}
        />
      </ExpandableSection>
    </ScrollView>
  );
}
```

### Share Functionality
```typescript
// src/utils/share.ts
import { Share, Platform } from 'react-native';
import ViewShot from 'react-native-view-shot';

export async function shareStock(stock: Stock, chartRef?: React.RefObject<ViewShot>) {
  const message = `${stock.name} (${stock.code})\n` +
    `현재가: ${formatPrice(stock.price)}\n` +
    `등락률: ${formatPercent(stock.changePercent)}\n\n` +
    `Stock Screener 앱에서 확인하세요!`;

  const url = `https://screener.app/stock/${stock.code}`;

  try {
    if (chartRef?.current && Platform.OS === 'ios') {
      // Capture chart as image for iOS
      const uri = await chartRef.current.capture();
      await Share.share({
        message,
        url,
      });
    } else {
      await Share.share({
        message: `${message}\n${url}`,
      });
    }
  } catch (error) {
    console.error('Share failed:', error);
  }
}
```

## Acceptance Criteria

- [ ] Stock header displays correct information with real-time price updates
- [ ] Price chart renders smoothly with touch interactions
- [ ] Period selection changes chart data correctly
- [ ] Chart tooltip shows accurate price/date on touch
- [ ] All metric cards display correct values
- [ ] Tabs switch content without lag
- [ ] News tab loads and displays latest news
- [ ] Disclosure tab shows DART filings
- [ ] Financials tab shows income/balance/cash flow
- [ ] Add to watchlist button works (toggle state)
- [ ] Share functionality opens native share sheet
- [ ] Deep link `screener://stock/005930` opens correct stock
- [ ] Back navigation returns to previous screen
- [ ] Loading skeletons show during data fetch
- [ ] Error states display with retry option

## Testing Strategy

### Unit Tests
- [ ] Metric formatting functions
- [ ] Chart data transformation
- [ ] Share message generation
- [ ] Period selection logic

### Integration Tests
- [ ] Stock data fetching with mock API
- [ ] Chart rendering with test data
- [ ] Tab navigation and lazy loading
- [ ] Watchlist toggle persistence

### Performance Tests
- [ ] Chart rendering performance (complex data)
- [ ] Tab switch animation smoothness
- [ ] Memory usage during extended viewing

### Manual Testing
- [ ] Test with real stock data (various types)
- [ ] Test chart touch interactions
- [ ] Test share on both platforms
- [ ] Test deep linking from external apps

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Chart library performance issues | Medium | High | Evaluate alternatives, optimize data |
| Real-time price update battery drain | Low | Medium | Throttle updates, pause in background |
| Large financial data load time | Medium | Medium | Pagination, lazy loading |
| Share screenshot quality | Low | Low | Test on various devices |

## Performance Requirements

- Initial screen render: < 500ms (with cached data)
- Chart render with 365 data points: < 300ms
- Tab switch: < 100ms
- Price update latency: < 1 second
- Memory usage: < 80MB for full screen

## Security Considerations

- [ ] Validate stock code format before API calls
- [ ] Sanitize external news content
- [ ] Secure WebView for external links
- [ ] Prevent screenshot in sensitive areas (if needed)

## Error Handling

```typescript
// src/components/stock/StockDetailErrorBoundary.tsx
const ERROR_STATES = {
  STOCK_NOT_FOUND: {
    icon: 'search-outline',
    title: '종목을 찾을 수 없습니다',
    message: '종목 코드를 확인해주세요.',
    action: 'goBack',
  },
  NETWORK_ERROR: {
    icon: 'wifi-outline',
    title: '네트워크 오류',
    message: '인터넷 연결을 확인해주세요.',
    action: 'retry',
  },
  DATA_ERROR: {
    icon: 'alert-circle-outline',
    title: '데이터 로드 실패',
    message: '일시적인 오류입니다. 다시 시도해주세요.',
    action: 'retry',
  },
};
```

## Dependencies

- **Depends On**: MOB-002 (Navigation & Auth)
- **Blocks**: MOB-006 (Portfolio & Watchlist)
- **External**:
  - Backend stock detail API
  - `react-native-wagmi-charts` or similar
  - `@react-navigation/material-top-tabs`
  - `react-native-view-shot` (for share screenshots)

## References

- **SDS.md**: Section 4.4 Stock Detail Screen Design
- [React Native Wagmi Charts](https://github.com/coinjar/react-native-wagmi-charts)
- [Material Top Tabs](https://reactnavigation.org/docs/material-top-tab-navigator/)
- [IMPROVEMENT_TICKETS.md](../../IMPROVEMENT_TICKETS.md) - Epic 3: Mobile Application

## Progress

- **0%** - Not started

## Notes

- Consider WebSocket for real-time price updates during market hours
- Cache financial data more aggressively (less frequent updates)
- Implement offline mode for basic stock info
- Add accessibility labels for all interactive elements
- Consider landscape mode for better chart viewing
- Monitor chart library bundle size impact
