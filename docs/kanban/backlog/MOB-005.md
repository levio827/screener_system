# MOB-005: Push Notifications

## Metadata

| Field | Value |
|-------|-------|
| **ID** | MOB-005 |
| **Title** | Implement Push Notification System |
| **Type** | Feature |
| **Status** | BACKLOG |
| **Priority** | P1 (High) |
| **Estimate** | 12 hours |
| **Sprint** | Sprint 6 |
| **Epic** | Mobile Application |
| **Assignee** | TBD |
| **Depends On** | MOB-002 |
| **Created** | 2025-11-29 |
| **Tags** | #mobile #notifications #alerts #firebase #apns |

## Description

Implement a comprehensive push notification system for price alerts, volume alerts, and news notifications. The system should integrate with Expo Notifications, Firebase Cloud Messaging (FCM) for Android, and Apple Push Notification service (APNs) for iOS. Include a notification settings screen for granular control over notification preferences and a notification history feature.

## Subtasks

### Notification Infrastructure Setup
- [ ] Configure Expo Notifications
  - [ ] Install and configure `expo-notifications`
  - [ ] Set up notification channels (Android)
  - [ ] Configure notification categories (iOS)
  - [ ] Handle notification permissions
- [ ] Firebase Cloud Messaging setup
  - [ ] Create Firebase project
  - [ ] Add google-services.json (Android)
  - [ ] Configure FCM in Expo
  - [ ] Test FCM token generation
- [ ] APNs setup
  - [ ] Generate APNs key in Apple Developer Console
  - [ ] Configure APNs in Expo
  - [ ] Test APNs in development/production
- [ ] Backend notification service
  - [ ] Create notification service endpoint
  - [ ] Implement device token registration
  - [ ] Build notification queue system
  - [ ] Set up scheduled notification jobs

### Notification Types Implementation
- [ ] Price alerts
  - [ ] Target price reached (above/below)
  - [ ] Percentage change threshold
  - [ ] Daily price summary
- [ ] Volume alerts
  - [ ] Unusual volume detection
  - [ ] Volume spike notifications
- [ ] News alerts
  - [ ] Breaking news for watched stocks
  - [ ] Disclosure notifications
  - [ ] Earnings announcements
- [ ] System notifications
  - [ ] Account security alerts
  - [ ] App updates
  - [ ] Subscription status

### Notification Settings Screen
- [ ] Create settings UI
  - [ ] Master notification toggle
  - [ ] Category-based toggles
  - [ ] Quiet hours configuration
  - [ ] Notification sound selection
- [ ] Implement per-category settings
  - [ ] Price alerts toggle + sound
  - [ ] Volume alerts toggle + sound
  - [ ] News alerts toggle + sound
  - [ ] System alerts (always on for security)
- [ ] Quiet hours feature
  - [ ] Start/end time picker
  - [ ] Day of week selection
  - [ ] Override for critical alerts
- [ ] Sync settings with backend
  - [ ] Save preferences to server
  - [ ] Sync across devices

### Notification History Screen
- [ ] Create history list UI
  - [ ] Grouped by date
  - [ ] Notification type icons
  - [ ] Read/unread status
  - [ ] Swipe to delete
- [ ] Implement history functionality
  - [ ] Store notifications locally
  - [ ] Mark as read on tap
  - [ ] Clear all option
  - [ ] Filter by type

### Rich Notifications
- [ ] Implement rich notification content
  - [ ] Stock chart preview image
  - [ ] Quick action buttons
  - [ ] Expandable notification (Android)
- [ ] Interactive actions
  - [ ] "View Stock" action
  - [ ] "Dismiss Alert" action
  - [ ] "Snooze" action

### Notification Handling
- [ ] Foreground notification handling
  - [ ] In-app notification banner
  - [ ] Badge count update
  - [ ] Sound/vibration
- [ ] Background notification handling
  - [ ] Navigate to relevant screen on tap
  - [ ] Update app state
- [ ] Killed state handling
  - [ ] Cold start navigation
  - [ ] Data parsing

## Implementation Details

### Notification Setup
```typescript
// src/services/notifications.ts
import * as Notifications from 'expo-notifications';
import * as Device from 'expo-device';
import { Platform } from 'react-native';

Notifications.setNotificationHandler({
  handleNotification: async () => ({
    shouldShowAlert: true,
    shouldPlaySound: true,
    shouldSetBadge: true,
  }),
});

export async function registerForPushNotifications(): Promise<string | null> {
  let token: string | null = null;

  if (!Device.isDevice) {
    console.warn('Push notifications require a physical device');
    return null;
  }

  const { status: existingStatus } = await Notifications.getPermissionsAsync();
  let finalStatus = existingStatus;

  if (existingStatus !== 'granted') {
    const { status } = await Notifications.requestPermissionsAsync();
    finalStatus = status;
  }

  if (finalStatus !== 'granted') {
    console.warn('Push notification permission not granted');
    return null;
  }

  token = (await Notifications.getExpoPushTokenAsync({
    projectId: process.env.EXPO_PROJECT_ID,
  })).data;

  if (Platform.OS === 'android') {
    await setupAndroidChannels();
  }

  return token;
}

async function setupAndroidChannels() {
  await Notifications.setNotificationChannelAsync('price-alerts', {
    name: '가격 알림',
    importance: Notifications.AndroidImportance.HIGH,
    vibrationPattern: [0, 250, 250, 250],
    lightColor: '#FF0000',
    sound: 'price_alert.wav',
  });

  await Notifications.setNotificationChannelAsync('volume-alerts', {
    name: '거래량 알림',
    importance: Notifications.AndroidImportance.DEFAULT,
    sound: 'volume_alert.wav',
  });

  await Notifications.setNotificationChannelAsync('news', {
    name: '뉴스 알림',
    importance: Notifications.AndroidImportance.DEFAULT,
  });

  await Notifications.setNotificationChannelAsync('system', {
    name: '시스템 알림',
    importance: Notifications.AndroidImportance.HIGH,
    lockscreenVisibility: Notifications.AndroidNotificationVisibility.PUBLIC,
  });
}
```

### Notification Handlers
```typescript
// src/hooks/useNotifications.ts
import { useEffect, useRef } from 'react';
import * as Notifications from 'expo-notifications';
import { useNavigation } from '@react-navigation/native';

export function useNotifications() {
  const navigation = useNavigation();
  const notificationListener = useRef<Notifications.Subscription>();
  const responseListener = useRef<Notifications.Subscription>();

  useEffect(() => {
    // Handle notifications received while app is foregrounded
    notificationListener.current = Notifications.addNotificationReceivedListener(
      (notification) => {
        const { type, data } = notification.request.content.data as NotificationData;
        handleForegroundNotification(type, data);
      }
    );

    // Handle notification taps
    responseListener.current = Notifications.addNotificationResponseReceivedListener(
      (response) => {
        const { type, data } = response.notification.request.content.data as NotificationData;
        handleNotificationTap(type, data, navigation);
      }
    );

    // Check for notification that launched the app
    Notifications.getLastNotificationResponseAsync().then((response) => {
      if (response) {
        const { type, data } = response.notification.request.content.data as NotificationData;
        handleNotificationTap(type, data, navigation);
      }
    });

    return () => {
      notificationListener.current?.remove();
      responseListener.current?.remove();
    };
  }, [navigation]);
}

function handleNotificationTap(
  type: NotificationType,
  data: NotificationPayload,
  navigation: NavigationProp
) {
  switch (type) {
    case 'price_alert':
    case 'volume_alert':
      navigation.navigate('StockDetail', { stockCode: data.stockCode });
      break;
    case 'news':
      navigation.navigate('NewsDetail', { newsId: data.newsId });
      break;
    case 'disclosure':
      Linking.openURL(data.disclosureUrl);
      break;
    default:
      navigation.navigate('Home');
  }
}

function handleForegroundNotification(type: NotificationType, data: NotificationPayload) {
  // Show in-app notification banner
  showInAppNotification({
    title: data.title,
    message: data.body,
    type,
    onPress: () => handleNotificationTap(type, data, navigation),
  });
}
```

### Backend Token Registration
```typescript
// src/services/api/notifications.ts
export const notificationApi = {
  async registerDevice(token: string): Promise<void> {
    await apiClient.post('/v1/notifications/devices', {
      token,
      platform: Platform.OS,
      deviceId: await getDeviceId(),
    });
  },

  async unregisterDevice(): Promise<void> {
    const deviceId = await getDeviceId();
    await apiClient.delete(`/v1/notifications/devices/${deviceId}`);
  },

  async updatePreferences(preferences: NotificationPreferences): Promise<void> {
    await apiClient.put('/v1/notifications/preferences', preferences);
  },

  async getPreferences(): Promise<NotificationPreferences> {
    const response = await apiClient.get('/v1/notifications/preferences');
    return response.data;
  },
};
```

### Notification Settings Screen
```typescript
// src/screens/NotificationSettingsScreen.tsx
export function NotificationSettingsScreen() {
  const { preferences, updatePreference, isLoading } = useNotificationPreferences();

  if (isLoading) return <SettingsSkeleton />;

  return (
    <ScrollView style={styles.container}>
      <SettingsSection title="알림 설정">
        <ToggleSetting
          label="전체 알림"
          value={preferences.enabled}
          onChange={(value) => updatePreference('enabled', value)}
        />
      </SettingsSection>

      <SettingsSection title="알림 유형" disabled={!preferences.enabled}>
        <ToggleSetting
          label="가격 알림"
          description="설정한 목표가 도달 시 알림"
          value={preferences.priceAlerts}
          onChange={(value) => updatePreference('priceAlerts', value)}
        />
        <ToggleSetting
          label="거래량 알림"
          description="이상 거래량 감지 시 알림"
          value={preferences.volumeAlerts}
          onChange={(value) => updatePreference('volumeAlerts', value)}
        />
        <ToggleSetting
          label="뉴스 알림"
          description="관심 종목 뉴스 및 공시"
          value={preferences.newsAlerts}
          onChange={(value) => updatePreference('newsAlerts', value)}
        />
      </SettingsSection>

      <SettingsSection title="방해 금지">
        <ToggleSetting
          label="방해 금지 모드"
          value={preferences.quietHours.enabled}
          onChange={(value) => updatePreference('quietHours.enabled', value)}
        />
        {preferences.quietHours.enabled && (
          <>
            <TimePickerSetting
              label="시작 시간"
              value={preferences.quietHours.start}
              onChange={(value) => updatePreference('quietHours.start', value)}
            />
            <TimePickerSetting
              label="종료 시간"
              value={preferences.quietHours.end}
              onChange={(value) => updatePreference('quietHours.end', value)}
            />
          </>
        )}
      </SettingsSection>

      <SettingsSection title="알림음">
        <SoundPickerSetting
          label="가격 알림음"
          value={preferences.sounds.priceAlert}
          options={ALERT_SOUNDS}
          onChange={(value) => updatePreference('sounds.priceAlert', value)}
        />
      </SettingsSection>
    </ScrollView>
  );
}
```

### Notification History
```typescript
// src/screens/NotificationHistoryScreen.tsx
import { useInfiniteQuery } from '@tanstack/react-query';
import { SectionList } from 'react-native';

export function NotificationHistoryScreen() {
  const {
    data,
    fetchNextPage,
    hasNextPage,
    isLoading,
  } = useInfiniteQuery({
    queryKey: ['notificationHistory'],
    queryFn: ({ pageParam = 1 }) =>
      notificationApi.getHistory({ page: pageParam, limit: 20 }),
    getNextPageParam: (lastPage) =>
      lastPage.hasMore ? lastPage.page + 1 : undefined,
  });

  const sections = useMemo(() => {
    const allNotifications = data?.pages.flatMap((page) => page.items) ?? [];
    return groupByDate(allNotifications);
  }, [data]);

  const renderItem = useCallback(
    ({ item }: { item: NotificationHistoryItem }) => (
      <Swipeable
        renderRightActions={() => (
          <DeleteAction onPress={() => deleteNotification(item.id)} />
        )}
      >
        <NotificationHistoryItem
          notification={item}
          onPress={() => handleNotificationTap(item)}
        />
      </Swipeable>
    ),
    []
  );

  return (
    <SectionList
      sections={sections}
      renderItem={renderItem}
      renderSectionHeader={({ section }) => (
        <Text style={styles.sectionHeader}>{section.title}</Text>
      )}
      onEndReached={() => hasNextPage && fetchNextPage()}
      ListEmptyComponent={<EmptyState message="알림 내역이 없습니다" />}
    />
  );
}
```

## Acceptance Criteria

- [ ] Push notification permission request shows on first launch
- [ ] Device token is registered with backend after permission granted
- [ ] Price alerts trigger notifications when conditions are met
- [ ] Volume alerts work for unusual trading activity
- [ ] News notifications appear for watched stocks
- [ ] Tapping notification opens relevant screen
- [ ] Notification settings save and sync correctly
- [ ] Quiet hours prevent notifications during set times
- [ ] Notification history shows all received notifications
- [ ] Swipe to delete works in history
- [ ] Badge count updates correctly
- [ ] Rich notifications show stock info/chart on Android
- [ ] Notifications work when app is in background/killed

## Testing Strategy

### Unit Tests
- [ ] Notification payload parsing
- [ ] Settings preference management
- [ ] History grouping logic
- [ ] Quiet hours calculation

### Integration Tests
- [ ] Token registration flow
- [ ] Notification tap navigation
- [ ] Settings sync with backend
- [ ] History pagination

### E2E Tests
- [ ] Permission request flow
- [ ] Notification delivery (with test backend)
- [ ] Full alert creation to notification flow

### Manual Testing
- [ ] Test on iOS physical device
- [ ] Test on Android physical device
- [ ] Test background/killed state handling
- [ ] Test notification sounds
- [ ] Test quiet hours functionality

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Push notification delivery failures | Medium | High | Implement delivery receipts, retry logic |
| Token refresh issues | Medium | Medium | Handle token refresh, re-registration |
| Platform-specific behavior differences | High | Medium | Thorough testing on both platforms |
| Battery drain from frequent notifications | Low | Medium | Batch notifications, respect quiet hours |
| Notification spam complaints | Low | High | Smart notification throttling, clear settings |

## Performance Requirements

- Notification delivery latency: < 5 seconds (from trigger)
- Token registration: < 2 seconds
- Settings screen load: < 300ms
- History screen load: < 500ms
- Notification tap to screen: < 500ms

## Security Considerations

- [ ] Secure token storage
- [ ] Validate notification payloads
- [ ] Don't include sensitive data in notification content
- [ ] Implement notification signing/verification
- [ ] Rate limit notification triggers per user
- [ ] Audit notification permissions usage

## Error Handling

```typescript
// src/utils/notificationErrors.ts
export const NOTIFICATION_ERRORS = {
  PERMISSION_DENIED: '알림 권한이 거부되었습니다. 설정에서 권한을 허용해주세요.',
  REGISTRATION_FAILED: '알림 등록에 실패했습니다. 다시 시도해주세요.',
  INVALID_TOKEN: '알림 토큰이 유효하지 않습니다. 앱을 재시작해주세요.',
  DELIVERY_FAILED: '알림 전송에 실패했습니다.',
};

export async function handleNotificationError(error: unknown): Promise<void> {
  if (error instanceof NotificationPermissionError) {
    Alert.alert(
      '알림 권한 필요',
      NOTIFICATION_ERRORS.PERMISSION_DENIED,
      [
        { text: '취소', style: 'cancel' },
        { text: '설정으로 이동', onPress: () => Linking.openSettings() },
      ]
    );
  }
  // ... handle other errors
}
```

## Dependencies

- **Depends On**: MOB-002 (Navigation & Auth)
- **External**:
  - Backend notification service
  - Firebase Cloud Messaging
  - Apple Push Notification service
  - `expo-notifications`
  - `expo-device`

## References

- **SDS.md**: Section 4.5 Push Notification Architecture
- [Expo Notifications](https://docs.expo.dev/versions/latest/sdk/notifications/)
- [Firebase Cloud Messaging](https://firebase.google.com/docs/cloud-messaging)
- [APNs Documentation](https://developer.apple.com/documentation/usernotifications)
- [IMPROVEMENT_TICKETS.md](../../IMPROVEMENT_TICKETS.md) - Epic 3: Mobile Application

## Progress

- **0%** - Not started

## Notes

- Consider implementing notification grouping for multiple alerts
- Test delivery reliability with different network conditions
- Implement analytics for notification engagement
- Consider time-sensitive notifications for iOS 15+
- Plan for notification content localization
- Monitor FCM/APNs quotas and limits
