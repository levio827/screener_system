# UX-001: Market Heatmap

## Metadata

| Field | Value |
|-------|-------|
| **ID** | UX-001 |
| **Title** | Implement Market Heatmap Visualization |
| **Type** | Feature |
| **Status** | BACKLOG |
| **Priority** | P1 (High) |
| **Estimate** | 12 hours |
| **Sprint** | Sprint 6 |
| **Epic** | UX/UI Enhancements |
| **Assignee** | TBD |
| **Created** | 2025-11-29 |
| **Updated** | 2025-11-30 |
| **Tags** | `visualization`, `d3.js`, `canvas`, `performance`, `ui/ux` |
| **Blocks** | None |
| **Blocked By** | None |
| **Related** | UX-002 (Dark Mode theme integration) |

## Description

Implement a Finviz-style market heatmap visualization that provides an intuitive overview of market performance. The heatmap will use treemap layout to display stocks grouped by sector/industry, with size representing market capitalization and color representing price change percentage.

## Progress

**0% - Not started**

## Acceptance Criteria

- [ ] Sector/industry grouping
- [ ] Market cap based sizing
- [ ] Change rate based coloring (red/green gradient)
- [ ] Zoom/panning interaction
- [ ] Navigate to detail page on stock click
- [ ] Tooltip (stock name, change rate, volume)
- [ ] Period selection (today, 1W, 1M)

## Detailed Subtasks

### 1. Data Structure & API Integration
- [ ] Design heatmap data model
  - [ ] Define TypeScript interfaces for hierarchical data
  - [ ] Map sector → industry → stock relationships
  - [ ] Calculate relative sizes based on market cap
- [ ] Create API endpoint for heatmap data
  - [ ] Implement `/api/market/heatmap` endpoint
  - [ ] Add query parameters for period selection
  - [ ] Include caching strategy (5-minute intervals)
- [ ] Data transformation utilities
  - [ ] Convert flat stock list to hierarchical structure
  - [ ] Calculate color values from price change percentage
  - [ ] Handle missing or invalid data gracefully

### 2. D3.js Treemap Implementation
- [ ] Set up D3.js treemap layout
  - [ ] Install and configure D3.js (`d3-hierarchy`, `d3-scale`)
  - [ ] Create treemap generator with proper padding
  - [ ] Implement responsive sizing logic
- [ ] Render hierarchical structure
  - [ ] Draw sector containers (parent nodes)
  - [ ] Draw stock rectangles (leaf nodes)
  - [ ] Apply market cap-based sizing algorithm
- [ ] Color gradient system
  - [ ] Define red-to-green gradient scale (-10% to +10%)
  - [ ] Handle extreme values (>10%, <-10%)
  - [ ] Ensure WCAG AA contrast compliance

### 3. Canvas Rendering Optimization
- [ ] Replace SVG with Canvas rendering
  - [ ] Create canvas context manager
  - [ ] Implement efficient redraw mechanism
  - [ ] Add requestAnimationFrame for smooth updates
- [ ] Performance optimizations
  - [ ] Implement virtual rendering for off-screen elements
  - [ ] Use Web Workers for data processing
  - [ ] Add debouncing for resize events (250ms)
- [ ] Memory management
  - [ ] Clear canvas on unmount
  - [ ] Release event listeners properly
  - [ ] Monitor memory usage with Performance API

### 4. User Interactions
- [ ] Zoom and pan functionality
  - [ ] Implement mouse wheel zoom (1.0x - 3.0x range)
  - [ ] Add drag-to-pan with momentum
  - [ ] Include pinch-to-zoom for touch devices
- [ ] Click navigation
  - [ ] Detect stock rectangle clicks
  - [ ] Navigate to stock detail page with transition
  - [ ] Add visual feedback (hover state, cursor change)
- [ ] Tooltip system
  - [ ] Position tooltip near cursor without overflow
  - [ ] Display: symbol, name, price, change %, volume
  - [ ] Add 100ms delay before showing tooltip

### 5. Period Selection Controls
- [ ] Implement period selector UI
  - [ ] Create tab-based selector (Today, 1W, 1M, 3M, YTD)
  - [ ] Add loading state during data fetch
  - [ ] Preserve selection in URL query params
- [ ] Data refresh logic
  - [ ] Fetch new data on period change
  - [ ] Animate transition between datasets
  - [ ] Cache previous periods for quick switching

### 6. Accessibility & Responsive Design
- [ ] Keyboard navigation
  - [ ] Tab through stocks in reading order
  - [ ] Enter key to navigate to detail page
  - [ ] Arrow keys for focus movement
- [ ] Screen reader support
  - [ ] Add ARIA labels for all interactive elements
  - [ ] Provide text alternative for visual data
  - [ ] Announce period changes
- [ ] Responsive breakpoints
  - [ ] Desktop: Full treemap with all features
  - [ ] Tablet: Simplified grouping
  - [ ] Mobile: List fallback with color indicators

## Implementation Details

### TypeScript Interfaces

```typescript
// src/types/heatmap.ts

export interface HeatmapStock {
  symbol: string;
  name: string;
  price: number;
  changePercent: number;
  volume: number;
  marketCap: number;
  sector: string;
  industry: string;
}

export interface HeatmapNode {
  name: string;
  value?: number; // Market cap for leaf nodes
  changePercent?: number; // For color calculation
  children?: HeatmapNode[];
  data?: HeatmapStock; // Original stock data
}

export interface HeatmapConfig {
  width: number;
  height: number;
  padding: number;
  minCellSize: number;
  colorScale: {
    domain: [number, number, number]; // [negative, zero, positive]
    range: [string, string, string]; // [red, neutral, green]
  };
}

export type HeatmapPeriod = 'today' | '1W' | '1M' | '3M' | 'YTD';
```

### React Component Structure

```typescript
// src/components/MarketHeatmap/MarketHeatmap.tsx

import React, { useEffect, useRef, useState, useCallback } from 'react';
import { hierarchy, treemap } from 'd3-hierarchy';
import { scaleLinear } from 'd3-scale';
import { HeatmapNode, HeatmapPeriod, HeatmapStock } from '@/types/heatmap';
import { useHeatmapData } from '@/hooks/useHeatmapData';
import { HeatmapTooltip } from './HeatmapTooltip';
import { PeriodSelector } from './PeriodSelector';

interface MarketHeatmapProps {
  defaultPeriod?: HeatmapPeriod;
  onStockClick?: (symbol: string) => void;
}

export const MarketHeatmap: React.FC<MarketHeatmapProps> = ({
  defaultPeriod = 'today',
  onStockClick
}) => {
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  const [period, setPeriod] = useState<HeatmapPeriod>(defaultPeriod);
  const [dimensions, setDimensions] = useState({ width: 0, height: 0 });
  const [hoveredStock, setHoveredStock] = useState<HeatmapStock | null>(null);
  const [tooltipPosition, setTooltipPosition] = useState({ x: 0, y: 0 });

  const { data, loading, error } = useHeatmapData(period);

  // Handle canvas resize
  useEffect(() => {
    if (!containerRef.current) return;

    const resizeObserver = new ResizeObserver((entries) => {
      const { width, height } = entries[0].contentRect;
      setDimensions({ width, height });
    });

    resizeObserver.observe(containerRef.current);
    return () => resizeObserver.disconnect();
  }, []);

  // Render heatmap
  useEffect(() => {
    if (!canvasRef.current || !data || dimensions.width === 0) return;

    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    // Set canvas resolution for retina displays
    const dpr = window.devicePixelRatio || 1;
    canvas.width = dimensions.width * dpr;
    canvas.height = dimensions.height * dpr;
    canvas.style.width = `${dimensions.width}px`;
    canvas.style.height = `${dimensions.height}px`;
    ctx.scale(dpr, dpr);

    // Create treemap layout
    const root = hierarchy<HeatmapNode>(data)
      .sum(d => d.value || 0)
      .sort((a, b) => (b.value || 0) - (a.value || 0));

    const treemapLayout = treemap<HeatmapNode>()
      .size([dimensions.width, dimensions.height])
      .padding(2)
      .round(true);

    treemapLayout(root);

    // Color scale for change percentage
    const colorScale = scaleLinear<string>()
      .domain([-10, 0, 10])
      .range(['#ef4444', '#6b7280', '#10b981'])
      .clamp(true);

    // Clear canvas
    ctx.clearRect(0, 0, dimensions.width, dimensions.height);

    // Draw cells
    root.leaves().forEach(node => {
      const { x0, y0, x1, y1, data } = node;

      if (!data.changePercent) return;

      // Fill rectangle
      ctx.fillStyle = colorScale(data.changePercent);
      ctx.fillRect(x0, y0, x1 - x0, y1 - y0);

      // Draw border
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 1;
      ctx.strokeRect(x0, y0, x1 - x0, y1 - y0);

      // Draw text if space available
      const width = x1 - x0;
      const height = y1 - y0;
      if (width > 60 && height > 30) {
        ctx.fillStyle = '#ffffff';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(data.name, (x0 + x1) / 2, (y0 + y1) / 2 - 6);

        ctx.font = 'bold 14px sans-serif';
        const sign = data.changePercent >= 0 ? '+' : '';
        ctx.fillText(
          `${sign}${data.changePercent.toFixed(2)}%`,
          (x0 + x1) / 2,
          (y0 + y1) / 2 + 8
        );
      }
    });
  }, [data, dimensions]);

  // Handle mouse move for tooltip
  const handleMouseMove = useCallback((e: React.MouseEvent<HTMLCanvasElement>) => {
    if (!canvasRef.current || !data) return;

    const rect = canvasRef.current.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    // Find hovered cell (implement hit detection)
    // This is simplified - actual implementation would use treemap coordinates
    setTooltipPosition({ x: e.clientX, y: e.clientY });

    // Set hovered stock based on mouse position
    // Implementation would traverse treemap nodes to find match
  }, [data]);

  const handleClick = useCallback((e: React.MouseEvent<HTMLCanvasElement>) => {
    if (!hoveredStock || !onStockClick) return;
    onStockClick(hoveredStock.symbol);
  }, [hoveredStock, onStockClick]);

  return (
    <div ref={containerRef} className="market-heatmap-container">
      <PeriodSelector
        value={period}
        onChange={setPeriod}
        disabled={loading}
      />

      {loading && <div className="loading-overlay">Loading...</div>}
      {error && <div className="error-message">{error}</div>}

      <canvas
        ref={canvasRef}
        onMouseMove={handleMouseMove}
        onClick={handleClick}
        style={{ cursor: hoveredStock ? 'pointer' : 'default' }}
      />

      {hoveredStock && (
        <HeatmapTooltip
          stock={hoveredStock}
          position={tooltipPosition}
        />
      )}
    </div>
  );
};
```

### Custom Hook for Data Fetching

```typescript
// src/hooks/useHeatmapData.ts

import { useState, useEffect } from 'react';
import { HeatmapNode, HeatmapPeriod, HeatmapStock } from '@/types/heatmap';

export const useHeatmapData = (period: HeatmapPeriod) => {
  const [data, setData] = useState<HeatmapNode | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);
      setError(null);

      try {
        const response = await fetch(`/api/market/heatmap?period=${period}`);

        if (!response.ok) {
          throw new Error(`Failed to fetch heatmap data: ${response.statusText}`);
        }

        const stocks: HeatmapStock[] = await response.json();

        // Transform flat array to hierarchical structure
        const hierarchicalData = transformToHierarchy(stocks);
        setData(hierarchicalData);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Unknown error');
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [period]);

  return { data, loading, error };
};

function transformToHierarchy(stocks: HeatmapStock[]): HeatmapNode {
  const root: HeatmapNode = {
    name: 'Market',
    children: []
  };

  // Group by sector
  const sectors = new Map<string, HeatmapStock[]>();
  stocks.forEach(stock => {
    if (!sectors.has(stock.sector)) {
      sectors.set(stock.sector, []);
    }
    sectors.get(stock.sector)!.push(stock);
  });

  // Build hierarchy
  sectors.forEach((sectorStocks, sectorName) => {
    const industries = new Map<string, HeatmapStock[]>();

    sectorStocks.forEach(stock => {
      if (!industries.has(stock.industry)) {
        industries.set(stock.industry, []);
      }
      industries.get(stock.industry)!.push(stock);
    });

    const sectorNode: HeatmapNode = {
      name: sectorName,
      children: []
    };

    industries.forEach((industryStocks, industryName) => {
      const industryNode: HeatmapNode = {
        name: industryName,
        children: industryStocks.map(stock => ({
          name: stock.symbol,
          value: stock.marketCap,
          changePercent: stock.changePercent,
          data: stock
        }))
      };
      sectorNode.children!.push(industryNode);
    });

    root.children!.push(sectorNode);
  });

  return root;
}
```

### API Endpoint

```typescript
// src/pages/api/market/heatmap.ts

import type { NextApiRequest, NextApiResponse } from 'next';
import { HeatmapStock } from '@/types/heatmap';
import { getMarketData } from '@/lib/market-data';

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse<HeatmapStock[] | { error: string }>
) {
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { period = 'today' } = req.query;

  try {
    // Set cache headers (5 minutes)
    res.setHeader('Cache-Control', 'public, s-maxage=300, stale-while-revalidate=600');

    const stocks = await getMarketData({
      period: period as string,
      minMarketCap: 1_000_000_000, // $1B minimum
      limit: 500 // Top 500 stocks
    });

    return res.status(200).json(stocks);
  } catch (error) {
    console.error('Heatmap API error:', error);
    return res.status(500).json({ error: 'Failed to fetch market data' });
  }
}
```

## Testing Strategy

### Unit Tests

```typescript
// __tests__/components/MarketHeatmap.test.tsx

import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { MarketHeatmap } from '@/components/MarketHeatmap/MarketHeatmap';
import { useHeatmapData } from '@/hooks/useHeatmapData';

jest.mock('@/hooks/useHeatmapData');

describe('MarketHeatmap', () => {
  const mockData = {
    name: 'Market',
    children: [
      {
        name: 'Technology',
        children: [
          {
            name: 'AAPL',
            value: 3000000000000,
            changePercent: 2.5,
            data: {
              symbol: 'AAPL',
              name: 'Apple Inc.',
              price: 175.5,
              changePercent: 2.5,
              volume: 50000000,
              marketCap: 3000000000000,
              sector: 'Technology',
              industry: 'Consumer Electronics'
            }
          }
        ]
      }
    ]
  };

  beforeEach(() => {
    (useHeatmapData as jest.Mock).mockReturnValue({
      data: mockData,
      loading: false,
      error: null
    });
  });

  it('renders canvas element', () => {
    render(<MarketHeatmap />);
    expect(screen.getByRole('img')).toBeInTheDocument(); // Canvas has implicit img role
  });

  it('displays loading state', () => {
    (useHeatmapData as jest.Mock).mockReturnValue({
      data: null,
      loading: true,
      error: null
    });

    render(<MarketHeatmap />);
    expect(screen.getByText('Loading...')).toBeInTheDocument();
  });

  it('handles period change', async () => {
    render(<MarketHeatmap />);

    const weekButton = screen.getByRole('button', { name: '1W' });
    fireEvent.click(weekButton);

    await waitFor(() => {
      expect(useHeatmapData).toHaveBeenCalledWith('1W');
    });
  });

  it('calls onStockClick when cell is clicked', () => {
    const handleClick = jest.fn();
    render(<MarketHeatmap onStockClick={handleClick} />);

    // Simulate click on canvas
    const canvas = screen.getByRole('img');
    fireEvent.click(canvas);

    // Verify click handler was called (implementation dependent)
  });
});
```

### Integration Tests

```typescript
// __tests__/integration/heatmap-flow.test.tsx

import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { rest } from 'msw';
import { setupServer } from 'msw/node';
import { MarketHeatmap } from '@/components/MarketHeatmap/MarketHeatmap';

const server = setupServer(
  rest.get('/api/market/heatmap', (req, res, ctx) => {
    return res(
      ctx.json([
        {
          symbol: 'AAPL',
          name: 'Apple Inc.',
          price: 175.5,
          changePercent: 2.5,
          volume: 50000000,
          marketCap: 3000000000000,
          sector: 'Technology',
          industry: 'Consumer Electronics'
        }
      ])
    );
  })
);

beforeAll(() => server.listen());
afterEach(() => server.resetHandlers());
afterAll(() => server.close());

describe('Heatmap Integration', () => {
  it('fetches and renders market data', async () => {
    render(<MarketHeatmap />);

    await waitFor(() => {
      expect(screen.queryByText('Loading...')).not.toBeInTheDocument();
    });

    // Verify canvas is rendered with data
    const canvas = screen.getByRole('img') as HTMLCanvasElement;
    expect(canvas.width).toBeGreaterThan(0);
  });

  it('handles API errors gracefully', async () => {
    server.use(
      rest.get('/api/market/heatmap', (req, res, ctx) => {
        return res(ctx.status(500), ctx.json({ error: 'Server error' }));
      })
    );

    render(<MarketHeatmap />);

    await waitFor(() => {
      expect(screen.getByText(/Failed to fetch/i)).toBeInTheDocument();
    });
  });
});
```

### Performance Tests

```typescript
// __tests__/performance/heatmap-render.test.ts

import { performance } from 'perf_hooks';

describe('Heatmap Performance', () => {
  it('renders 500 stocks within 100ms', async () => {
    const stocks = generateMockStocks(500);

    const start = performance.now();
    const hierarchicalData = transformToHierarchy(stocks);
    // Render simulation
    const end = performance.now();

    expect(end - start).toBeLessThan(100);
  });

  it('handles resize without memory leaks', () => {
    const initialMemory = (performance as any).memory?.usedJSHeapSize || 0;

    // Simulate multiple resizes
    for (let i = 0; i < 100; i++) {
      // Trigger resize event
    }

    const finalMemory = (performance as any).memory?.usedJSHeapSize || 0;
    const memoryIncrease = finalMemory - initialMemory;

    expect(memoryIncrease).toBeLessThan(5_000_000); // Less than 5MB increase
  });
});
```

### E2E Tests

```typescript
// e2e/heatmap.spec.ts

import { test, expect } from '@playwright/test';

test.describe('Market Heatmap', () => {
  test('navigates to stock detail on click', async ({ page }) => {
    await page.goto('/market/heatmap');

    // Wait for heatmap to load
    await page.waitForSelector('canvas');

    // Click on a stock cell
    await page.click('canvas', { position: { x: 100, y: 100 } });

    // Verify navigation to detail page
    await expect(page).toHaveURL(/\/stocks\/\w+/);
  });

  test('shows tooltip on hover', async ({ page }) => {
    await page.goto('/market/heatmap');

    await page.hover('canvas', { position: { x: 100, y: 100 } });

    // Wait for tooltip
    await page.waitForSelector('.heatmap-tooltip', { timeout: 500 });

    // Verify tooltip content
    expect(await page.textContent('.heatmap-tooltip')).toContain('%');
  });

  test('changes period and updates data', async ({ page }) => {
    await page.goto('/market/heatmap');

    // Click 1W button
    await page.click('button:has-text("1W")');

    // Wait for loading state
    await page.waitForSelector('.loading-overlay');

    // Wait for data to load
    await page.waitForSelector('.loading-overlay', { state: 'hidden' });

    // Verify URL query param
    expect(page.url()).toContain('period=1W');
  });
});
```

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation Strategy | Owner |
|------|------------|--------|-------------------|-------|
| **Performance degradation with 500+ stocks** | High | High | Implement canvas rendering, virtual rendering, Web Workers for data processing | Dev Team |
| **Browser compatibility issues (older browsers)** | Medium | Medium | Provide SVG fallback for browsers without canvas support, polyfills for older APIs | QA Team |
| **Data API timeout during market hours** | Medium | High | Implement 5-second timeout, retry logic (3 attempts), show cached data with staleness indicator | Backend Team |
| **Color blindness accessibility concerns** | Medium | Medium | Add pattern overlays (stripes/dots) in addition to color, provide alternative text view | UX Team |
| **Mobile touch interaction limitations** | High | Medium | Implement touch-optimized controls, fallback to list view for small screens (<768px) | Dev Team |
| **Memory leaks from canvas rendering** | Low | High | Proper cleanup in useEffect, monitor with Chrome DevTools, implement memory profiling tests | Dev Team |
| **Incorrect hierarchical data transformation** | Low | High | Comprehensive unit tests for data transformation, validate sector/industry mappings | QA Team |

## Performance Requirements

| Metric | Target | Measurement Method | Acceptance Threshold |
|--------|--------|-------------------|---------------------|
| **Initial Load Time** | < 2 seconds | Lighthouse Performance Score | 90+ |
| **Time to Interactive (TTI)** | < 3 seconds | Web Vitals | < 3.5s |
| **Canvas Render Time** | < 100ms | Performance.now() | < 150ms |
| **Resize Response** | < 50ms | Debounced resize handler | < 100ms |
| **API Response Time** | < 1 second | Server-side monitoring | < 2s (p95) |
| **Memory Usage** | < 50MB | Chrome DevTools Memory Profiler | < 75MB |
| **Frame Rate (interactions)** | 60 FPS | requestAnimationFrame timing | > 55 FPS |
| **Data Fetch Frequency** | 5 minutes | Cache-Control headers | Max 5 min cache |

### Performance Monitoring

```typescript
// src/utils/performance-monitor.ts

export class HeatmapPerformanceMonitor {
  private renderTimes: number[] = [];

  startRender(): number {
    return performance.now();
  }

  endRender(startTime: number): void {
    const duration = performance.now() - startTime;
    this.renderTimes.push(duration);

    if (duration > 150) {
      console.warn(`Slow heatmap render: ${duration.toFixed(2)}ms`);
    }

    // Keep last 100 samples
    if (this.renderTimes.length > 100) {
      this.renderTimes.shift();
    }
  }

  getAverageRenderTime(): number {
    if (this.renderTimes.length === 0) return 0;
    return this.renderTimes.reduce((a, b) => a + b, 0) / this.renderTimes.length;
  }

  getP95RenderTime(): number {
    if (this.renderTimes.length === 0) return 0;
    const sorted = [...this.renderTimes].sort((a, b) => a - b);
    const index = Math.floor(sorted.length * 0.95);
    return sorted[index];
  }
}
```

## Security Considerations

### Input Validation

```typescript
// src/lib/validators/heatmap.ts

import { z } from 'zod';

export const HeatmapQuerySchema = z.object({
  period: z.enum(['today', '1W', '1M', '3M', 'YTD']).default('today'),
  minMarketCap: z.number().min(0).optional(),
  limit: z.number().min(1).max(1000).default(500)
});

export type HeatmapQuery = z.infer<typeof HeatmapQuerySchema>;

export function validateHeatmapQuery(query: unknown): HeatmapQuery {
  return HeatmapQuerySchema.parse(query);
}
```

### API Security

- **Rate Limiting**: 60 requests per minute per IP address
- **CORS**: Whitelist only authorized domains
- **Authentication**: Require API key for production endpoints
- **Data Sanitization**: Escape all user-provided strings before rendering
- **CSP Headers**: Restrict canvas data URLs to same-origin

### XSS Prevention

```typescript
// src/utils/sanitize.ts

export function sanitizeStockName(name: string): string {
  return name
    .replace(/[<>\"']/g, '') // Remove HTML characters
    .substring(0, 100); // Limit length
}

export function sanitizeNumber(value: unknown): number {
  const num = Number(value);
  if (!Number.isFinite(num)) {
    throw new Error('Invalid number');
  }
  return num;
}
```

## Error Handling

### Error Types and Handlers

```typescript
// src/lib/errors/heatmap-errors.ts

export class HeatmapError extends Error {
  constructor(
    message: string,
    public code: string,
    public originalError?: Error
  ) {
    super(message);
    this.name = 'HeatmapError';
  }
}

export class DataFetchError extends HeatmapError {
  constructor(message: string, originalError?: Error) {
    super(message, 'DATA_FETCH_ERROR', originalError);
    this.name = 'DataFetchError';
  }
}

export class RenderError extends HeatmapError {
  constructor(message: string, originalError?: Error) {
    super(message, 'RENDER_ERROR', originalError);
    this.name = 'RenderError';
  }
}

export class ValidationError extends HeatmapError {
  constructor(message: string) {
    super(message, 'VALIDATION_ERROR');
    this.name = 'ValidationError';
  }
}
```

### Error Boundary Component

```typescript
// src/components/MarketHeatmap/HeatmapErrorBoundary.tsx

import React, { Component, ReactNode } from 'react';
import { HeatmapError } from '@/lib/errors/heatmap-errors';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error: Error | null;
}

export class HeatmapErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('Heatmap error:', error, errorInfo);

    // Log to error tracking service (e.g., Sentry)
    if (typeof window !== 'undefined' && (window as any).Sentry) {
      (window as any).Sentry.captureException(error, {
        contexts: {
          react: { componentStack: errorInfo.componentStack }
        }
      });
    }
  }

  render() {
    if (this.state.hasError) {
      if (this.props.fallback) {
        return this.props.fallback;
      }

      return (
        <div className="heatmap-error-container">
          <h3>Unable to load market heatmap</h3>
          <p>We're experiencing technical difficulties. Please try again later.</p>
          <button onClick={() => this.setState({ hasError: false, error: null })}>
            Retry
          </button>
        </div>
      );
    }

    return this.props.children;
  }
}
```

### Graceful Degradation

```typescript
// src/components/MarketHeatmap/HeatmapFallback.tsx

export const HeatmapFallback: React.FC<{ stocks: HeatmapStock[] }> = ({ stocks }) => {
  return (
    <div className="heatmap-fallback">
      <p className="fallback-notice">
        Your browser doesn't support canvas rendering. Here's a list view:
      </p>
      <table className="stock-table">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Name</th>
            <th>Price</th>
            <th>Change</th>
            <th>Market Cap</th>
          </tr>
        </thead>
        <tbody>
          {stocks.map(stock => (
            <tr key={stock.symbol}>
              <td>{stock.symbol}</td>
              <td>{stock.name}</td>
              <td>${stock.price.toFixed(2)}</td>
              <td className={stock.changePercent >= 0 ? 'positive' : 'negative'}>
                {stock.changePercent >= 0 ? '+' : ''}
                {stock.changePercent.toFixed(2)}%
              </td>
              <td>${(stock.marketCap / 1e9).toFixed(2)}B</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
};
```

## Notes

### Design Considerations

- **Color Scheme**: Use deuteranopia-safe colors for red/green gradients
- **Typography**: Ensure minimum 12px font size for stock symbols
- **Spacing**: Maintain 2px padding between cells for visual separation
- **Loading States**: Show skeleton loader during initial data fetch
- **Empty States**: Display helpful message when no data available

### Future Enhancements

1. **Compare Mode**: Side-by-side comparison of different time periods
2. **Custom Grouping**: Allow users to group by custom criteria (e.g., price range)
3. **Export Feature**: Export heatmap as PNG/SVG for reports
4. **Alerts Integration**: Click to set price alerts directly from heatmap
5. **Historical Playback**: Animate heatmap changes over time

### Dependencies

```json
{
  "dependencies": {
    "d3-hierarchy": "^3.1.2",
    "d3-scale": "^4.0.2",
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/d3-hierarchy": "^3.1.6",
    "@types/d3-scale": "^4.0.8",
    "jest": "^29.7.0",
    "@testing-library/react": "^14.1.2",
    "playwright": "^1.40.0"
  }
}
```

### Browser Support

- Chrome 90+ (recommended)
- Firefox 88+
- Safari 14+
- Edge 90+
- Mobile browsers: iOS Safari 14+, Chrome Mobile 90+

### Accessibility Compliance

- **WCAG 2.1 Level AA**: Color contrast ratios ≥ 4.5:1
- **Keyboard Navigation**: Full functionality without mouse
- **Screen Reader**: ARIA labels and live regions for dynamic updates
- **Focus Indicators**: Visible focus outlines (2px solid)

## References

- [IMPROVEMENT_TICKETS.md](../../IMPROVEMENT_TICKETS.md) - Epic 7: UX/UI Enhancements
- [D3.js Treemap Documentation](https://github.com/d3/d3-hierarchy#treemap)
- [Canvas API Reference](https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API)
- [WCAG 2.1 Guidelines](https://www.w3.org/WAI/WCAG21/quickref/)
- [Finviz Heatmap](https://finviz.com/map.ashx) - Design inspiration
