# UX-002: Dark Mode

## Metadata

| Field | Value |
|-------|-------|
| **ID** | UX-002 |
| **Title** | Implement Dark Mode |
| **Type** | Feature |
| **Status** | BACKLOG |
| **Priority** | P1 (High) |
| **Estimate** | 8 hours |
| **Sprint** | Sprint 6 |
| **Epic** | UX/UI Enhancements |
| **Assignee** | TBD |
| **Created** | 2025-11-29 |
| **Updated** | 2025-11-30 |
| **Tags** | `theming`, `ui/ux`, `accessibility`, `css-variables`, `context-api` |
| **Blocks** | None |
| **Blocked By** | None |
| **Related** | UX-001 (Chart colors need theme integration) |

## Description

Implement a comprehensive dark mode with system settings integration and manual toggle. The theme system will use CSS variables for consistent styling and React Context for state management, ensuring all components adapt seamlessly to theme changes.

## Progress

**0% - Not started**

## Acceptance Criteria

- [ ] Dark theme design tokens
- [ ] Auto-detect system settings
- [ ] Manual toggle option
- [ ] Chart color theme integration
- [ ] Settings persistence (localStorage)
- [ ] Transition animation

## Detailed Subtasks

### 1. Design System & Theme Tokens
- [ ] Define color palette for both themes
  - [ ] Create light theme color tokens
  - [ ] Create dark theme color tokens
  - [ ] Define neutral colors (grays)
  - [ ] Define semantic colors (success, error, warning, info)
- [ ] Set up CSS custom properties
  - [ ] Background colors (primary, secondary, tertiary)
  - [ ] Text colors (primary, secondary, disabled)
  - [ ] Border colors and shadows
  - [ ] Chart-specific colors
- [ ] Typography adjustments
  - [ ] Ensure WCAG AA contrast compliance (4.5:1 for text)
  - [ ] Adjust font weights for dark backgrounds
  - [ ] Define link colors for both themes

### 2. Theme Context Implementation
- [ ] Create React Context for theme management
  - [ ] Define ThemeContext with current theme state
  - [ ] Implement ThemeProvider wrapper component
  - [ ] Create useTheme custom hook
- [ ] Theme state management
  - [ ] Initialize theme from localStorage or system preference
  - [ ] Handle theme toggle functionality
  - [ ] Sync theme changes across browser tabs
- [ ] System preference detection
  - [ ] Listen to prefers-color-scheme media query
  - [ ] Auto-switch when system preference changes
  - [ ] Provide option to override system preference

### 3. UI Components Update
- [ ] Update base components
  - [ ] Button (all variants: primary, secondary, outline)
  - [ ] Input fields and form controls
  - [ ] Cards and containers
  - [ ] Modals and dialogs
  - [ ] Navigation and sidebar
- [ ] Update data visualization components
  - [ ] Stock charts (candlestick, line, area)
  - [ ] Heatmap color schemes
  - [ ] Tables and data grids
  - [ ] Indicators and badges
- [ ] Update layout components
  - [ ] Header/navbar
  - [ ] Footer
  - [ ] Dashboard grid
  - [ ] Sidebar panels

### 4. Theme Toggle UI
- [ ] Create toggle component
  - [ ] Design sun/moon icon toggle button
  - [ ] Add to navigation bar
  - [ ] Include in user settings page
- [ ] Accessibility features
  - [ ] Add ARIA labels for screen readers
  - [ ] Keyboard navigation support (Space/Enter)
  - [ ] Focus indicators
- [ ] Visual feedback
  - [ ] Smooth transition animations
  - [ ] Loading state during theme switch
  - [ ] Toast notification (optional)

### 5. Chart Integration
- [ ] Update Lightweight Charts theme
  - [ ] Background and grid colors
  - [ ] Candlestick colors (up/down)
  - [ ] Volume bar colors
  - [ ] Crosshair and watermark colors
- [ ] Update D3.js visualizations
  - [ ] Heatmap color scales
  - [ ] Axis and label colors
  - [ ] Tooltip backgrounds
- [ ] Update recharts/other libraries
  - [ ] Line and area chart colors
  - [ ] Tooltip themes
  - [ ] Legend styling

### 6. Persistence & Synchronization
- [ ] LocalStorage implementation
  - [ ] Save theme preference on change
  - [ ] Load theme on app initialization
  - [ ] Handle localStorage errors gracefully
- [ ] Cross-tab synchronization
  - [ ] Listen to storage events
  - [ ] Update theme when changed in another tab
  - [ ] Prevent infinite update loops
- [ ] Server-side persistence (optional)
  - [ ] Save to user profile in database
  - [ ] Sync across devices
  - [ ] API endpoint for theme preference

### 7. Transition Animations
- [ ] CSS transitions
  - [ ] Smooth color transitions (200-300ms)
  - [ ] Prevent flash of unstyled content (FOUC)
  - [ ] Disable transitions on initial load
- [ ] Performance optimization
  - [ ] Use CSS variables for instant updates
  - [ ] Avoid JavaScript-based animations
  - [ ] Batch DOM updates

## Implementation Details

### Theme Color Tokens

```typescript
// src/styles/theme-tokens.ts

export const lightTheme = {
  // Background colors
  background: {
    primary: '#ffffff',
    secondary: '#f8f9fa',
    tertiary: '#e9ecef',
    elevated: '#ffffff',
    overlay: 'rgba(0, 0, 0, 0.5)',
  },

  // Text colors
  text: {
    primary: '#212529',
    secondary: '#6c757d',
    tertiary: '#adb5bd',
    disabled: '#dee2e6',
    inverse: '#ffffff',
  },

  // Border and divider colors
  border: {
    default: '#dee2e6',
    light: '#e9ecef',
    dark: '#adb5bd',
  },

  // Semantic colors
  semantic: {
    success: '#28a745',
    error: '#dc3545',
    warning: '#ffc107',
    info: '#17a2b8',
  },

  // Chart colors
  chart: {
    bullish: '#10b981',
    bearish: '#ef4444',
    volume: '#6366f1',
    grid: '#e5e7eb',
    crosshair: '#94a3b8',
  },

  // Shadows
  shadow: {
    sm: '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
    md: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
    lg: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
  },
} as const;

export const darkTheme = {
  // Background colors
  background: {
    primary: '#1a1a1a',
    secondary: '#2d2d2d',
    tertiary: '#3d3d3d',
    elevated: '#2d2d2d',
    overlay: 'rgba(0, 0, 0, 0.7)',
  },

  // Text colors
  text: {
    primary: '#f8f9fa',
    secondary: '#adb5bd',
    tertiary: '#6c757d',
    disabled: '#495057',
    inverse: '#212529',
  },

  // Border and divider colors
  border: {
    default: '#495057',
    light: '#3d3d3d',
    dark: '#6c757d',
  },

  // Semantic colors (slightly adjusted for dark backgrounds)
  semantic: {
    success: '#34d399',
    error: '#f87171',
    warning: '#fbbf24',
    info: '#3b82f6',
  },

  // Chart colors
  chart: {
    bullish: '#10b981',
    bearish: '#ef4444',
    volume: '#818cf8',
    grid: '#374151',
    crosshair: '#cbd5e1',
  },

  // Shadows (lighter for dark theme)
  shadow: {
    sm: '0 1px 2px 0 rgba(0, 0, 0, 0.3)',
    md: '0 4px 6px -1px rgba(0, 0, 0, 0.4)',
    lg: '0 10px 15px -3px rgba(0, 0, 0, 0.5)',
  },
} as const;

export type Theme = typeof lightTheme;
export type ThemeName = 'light' | 'dark';
```

### CSS Variables Setup

```css
/* src/styles/theme.css */

:root {
  /* Light theme (default) */
  --bg-primary: #ffffff;
  --bg-secondary: #f8f9fa;
  --bg-tertiary: #e9ecef;
  --bg-elevated: #ffffff;
  --bg-overlay: rgba(0, 0, 0, 0.5);

  --text-primary: #212529;
  --text-secondary: #6c757d;
  --text-tertiary: #adb5bd;
  --text-disabled: #dee2e6;
  --text-inverse: #ffffff;

  --border-default: #dee2e6;
  --border-light: #e9ecef;
  --border-dark: #adb5bd;

  --semantic-success: #28a745;
  --semantic-error: #dc3545;
  --semantic-warning: #ffc107;
  --semantic-info: #17a2b8;

  --chart-bullish: #10b981;
  --chart-bearish: #ef4444;
  --chart-volume: #6366f1;
  --chart-grid: #e5e7eb;
  --chart-crosshair: #94a3b8;

  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);

  /* Transition timing */
  --theme-transition-duration: 200ms;
}

[data-theme='dark'] {
  --bg-primary: #1a1a1a;
  --bg-secondary: #2d2d2d;
  --bg-tertiary: #3d3d3d;
  --bg-elevated: #2d2d2d;
  --bg-overlay: rgba(0, 0, 0, 0.7);

  --text-primary: #f8f9fa;
  --text-secondary: #adb5bd;
  --text-tertiary: #6c757d;
  --text-disabled: #495057;
  --text-inverse: #212529;

  --border-default: #495057;
  --border-light: #3d3d3d;
  --border-dark: #6c757d;

  --semantic-success: #34d399;
  --semantic-error: #f87171;
  --semantic-warning: #fbbf24;
  --semantic-info: #3b82f6;

  --chart-bullish: #10b981;
  --chart-bearish: #ef4444;
  --chart-volume: #818cf8;
  --chart-grid: #374151;
  --chart-crosshair: #cbd5e1;

  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
}

/* Apply transitions to all themed elements */
.theme-transition,
.theme-transition * {
  transition: background-color var(--theme-transition-duration) ease,
              color var(--theme-transition-duration) ease,
              border-color var(--theme-transition-duration) ease,
              box-shadow var(--theme-transition-duration) ease;
}

/* Disable transitions on page load */
.preload-transitions * {
  transition: none !important;
}
```

### Theme Context & Provider

```typescript
// src/contexts/ThemeContext.tsx

import React, { createContext, useContext, useEffect, useState, ReactNode } from 'react';

export type ThemeName = 'light' | 'dark';
export type ThemeMode = 'light' | 'dark' | 'system';

interface ThemeContextValue {
  theme: ThemeName;
  themeMode: ThemeMode;
  setThemeMode: (mode: ThemeMode) => void;
  toggleTheme: () => void;
}

const ThemeContext = createContext<ThemeContextValue | undefined>(undefined);

interface ThemeProviderProps {
  children: ReactNode;
  defaultMode?: ThemeMode;
}

const STORAGE_KEY = 'theme-preference';

export const ThemeProvider: React.FC<ThemeProviderProps> = ({
  children,
  defaultMode = 'system'
}) => {
  const [themeMode, setThemeModeState] = useState<ThemeMode>(defaultMode);
  const [theme, setTheme] = useState<ThemeName>('light');

  // Get system preference
  const getSystemTheme = (): ThemeName => {
    if (typeof window === 'undefined') return 'light';
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  };

  // Calculate actual theme based on mode
  const calculateTheme = (mode: ThemeMode): ThemeName => {
    if (mode === 'system') {
      return getSystemTheme();
    }
    return mode;
  };

  // Initialize theme from localStorage or default
  useEffect(() => {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored && ['light', 'dark', 'system'].includes(stored)) {
        setThemeModeState(stored as ThemeMode);
      }
    } catch (error) {
      console.error('Failed to load theme preference:', error);
    }

    // Remove preload class after initialization
    document.documentElement.classList.remove('preload-transitions');
  }, []);

  // Update theme when mode changes
  useEffect(() => {
    const newTheme = calculateTheme(themeMode);
    setTheme(newTheme);
    document.documentElement.setAttribute('data-theme', newTheme);

    // Add transition class
    document.documentElement.classList.add('theme-transition');
  }, [themeMode]);

  // Listen to system preference changes
  useEffect(() => {
    if (themeMode !== 'system') return;

    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

    const handleChange = (e: MediaQueryListEvent) => {
      setTheme(e.matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
    };

    mediaQuery.addEventListener('change', handleChange);
    return () => mediaQuery.removeEventListener('change', handleChange);
  }, [themeMode]);

  // Listen to storage events for cross-tab sync
  useEffect(() => {
    const handleStorageChange = (e: StorageEvent) => {
      if (e.key === STORAGE_KEY && e.newValue) {
        setThemeModeState(e.newValue as ThemeMode);
      }
    };

    window.addEventListener('storage', handleStorageChange);
    return () => window.removeEventListener('storage', handleStorageChange);
  }, []);

  const setThemeMode = (mode: ThemeMode) => {
    setThemeModeState(mode);
    try {
      localStorage.setItem(STORAGE_KEY, mode);
    } catch (error) {
      console.error('Failed to save theme preference:', error);
    }
  };

  const toggleTheme = () => {
    const newMode = theme === 'light' ? 'dark' : 'light';
    setThemeMode(newMode);
  };

  return (
    <ThemeContext.Provider value={{ theme, themeMode, setThemeMode, toggleTheme }}>
      {children}
    </ThemeContext.Provider>
  );
};

export const useTheme = (): ThemeContextValue => {
  const context = useContext(ThemeContext);
  if (!context) {
    throw new Error('useTheme must be used within ThemeProvider');
  }
  return context;
};
```

### Theme Toggle Component

```typescript
// src/components/ThemeToggle/ThemeToggle.tsx

import React from 'react';
import { useTheme } from '@/contexts/ThemeContext';
import { SunIcon, MoonIcon } from '@/components/Icons';
import styles from './ThemeToggle.module.css';

interface ThemeToggleProps {
  showLabel?: boolean;
  className?: string;
}

export const ThemeToggle: React.FC<ThemeToggleProps> = ({
  showLabel = false,
  className = ''
}) => {
  const { theme, toggleTheme } = useTheme();

  return (
    <button
      onClick={toggleTheme}
      className={`${styles.toggleButton} ${className}`}
      aria-label={`Switch to ${theme === 'light' ? 'dark' : 'light'} mode`}
      title={`Switch to ${theme === 'light' ? 'dark' : 'light'} mode`}
    >
      <span className={styles.iconWrapper}>
        {theme === 'light' ? (
          <MoonIcon className={styles.icon} />
        ) : (
          <SunIcon className={styles.icon} />
        )}
      </span>
      {showLabel && (
        <span className={styles.label}>
          {theme === 'light' ? 'Dark' : 'Light'} Mode
        </span>
      )}
    </button>
  );
};
```

```css
/* src/components/ThemeToggle/ThemeToggle.module.css */

.toggleButton {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border-default);
  border-radius: 0.375rem;
  cursor: pointer;
  transition: all 150ms ease;
}

.toggleButton:hover {
  background: var(--bg-tertiary);
  border-color: var(--border-dark);
}

.toggleButton:focus-visible {
  outline: 2px solid var(--semantic-info);
  outline-offset: 2px;
}

.iconWrapper {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 1.25rem;
  height: 1.25rem;
}

.icon {
  width: 100%;
  height: 100%;
  color: var(--text-primary);
}

.label {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-primary);
}
```

### Chart Theme Integration

```typescript
// src/utils/chart-theme.ts

import { DeepPartial, ChartOptions } from 'lightweight-charts';
import { ThemeName } from '@/contexts/ThemeContext';

export function getChartTheme(theme: ThemeName): DeepPartial<ChartOptions> {
  const isDark = theme === 'dark';

  return {
    layout: {
      background: {
        color: isDark ? '#1a1a1a' : '#ffffff',
      },
      textColor: isDark ? '#f8f9fa' : '#212529',
    },
    grid: {
      vertLines: {
        color: isDark ? '#374151' : '#e5e7eb',
      },
      horzLines: {
        color: isDark ? '#374151' : '#e5e7eb',
      },
    },
    crosshair: {
      vertLine: {
        color: isDark ? '#cbd5e1' : '#94a3b8',
        labelBackgroundColor: isDark ? '#2d2d2d' : '#f8f9fa',
      },
      horzLine: {
        color: isDark ? '#cbd5e1' : '#94a3b8',
        labelBackgroundColor: isDark ? '#2d2d2d' : '#f8f9fa',
      },
    },
    watermark: {
      color: isDark ? 'rgba(248, 249, 250, 0.1)' : 'rgba(33, 37, 41, 0.1)',
    },
  };
}

export function getCandlestickColors(theme: ThemeName) {
  return {
    upColor: '#10b981',
    downColor: '#ef4444',
    wickUpColor: '#10b981',
    wickDownColor: '#ef4444',
    borderUpColor: '#10b981',
    borderDownColor: '#ef4444',
  };
}

export function getVolumeColors(theme: ThemeName) {
  const isDark = theme === 'dark';
  return {
    upColor: isDark ? 'rgba(129, 140, 248, 0.5)' : 'rgba(99, 102, 241, 0.5)',
    downColor: isDark ? 'rgba(248, 113, 113, 0.5)' : 'rgba(239, 68, 68, 0.5)',
  };
}
```

### Application Wrapper

```typescript
// src/pages/_app.tsx

import { AppProps } from 'next/app';
import { ThemeProvider } from '@/contexts/ThemeContext';
import '@/styles/theme.css';
import '@/styles/globals.css';

function MyApp({ Component, pageProps }: AppProps) {
  return (
    <ThemeProvider defaultMode="system">
      <Component {...pageProps} />
    </ThemeProvider>
  );
}

export default MyApp;
```

## Testing Strategy

### Unit Tests

```typescript
// __tests__/contexts/ThemeContext.test.tsx

import { renderHook, act } from '@testing-library/react';
import { ThemeProvider, useTheme } from '@/contexts/ThemeContext';

describe('ThemeContext', () => {
  beforeEach(() => {
    localStorage.clear();
    document.documentElement.removeAttribute('data-theme');
  });

  it('initializes with light theme by default', () => {
    const { result } = renderHook(() => useTheme(), {
      wrapper: ThemeProvider
    });

    expect(result.current.theme).toBe('light');
    expect(result.current.themeMode).toBe('system');
  });

  it('toggles theme correctly', () => {
    const { result } = renderHook(() => useTheme(), {
      wrapper: ThemeProvider
    });

    act(() => {
      result.current.toggleTheme();
    });

    expect(result.current.theme).toBe('dark');
    expect(document.documentElement.getAttribute('data-theme')).toBe('dark');
  });

  it('persists theme to localStorage', () => {
    const { result } = renderHook(() => useTheme(), {
      wrapper: ThemeProvider
    });

    act(() => {
      result.current.setThemeMode('dark');
    });

    expect(localStorage.getItem('theme-preference')).toBe('dark');
  });

  it('loads theme from localStorage on mount', () => {
    localStorage.setItem('theme-preference', 'dark');

    const { result } = renderHook(() => useTheme(), {
      wrapper: ThemeProvider
    });

    expect(result.current.themeMode).toBe('dark');
  });

  it('respects system preference when mode is system', () => {
    const matchMediaMock = jest.fn().mockImplementation(query => ({
      matches: query === '(prefers-color-scheme: dark)',
      media: query,
      addEventListener: jest.fn(),
      removeEventListener: jest.fn(),
    }));

    window.matchMedia = matchMediaMock;

    const { result } = renderHook(() => useTheme(), {
      wrapper: ThemeProvider
    });

    expect(result.current.theme).toBe('dark');
  });
});
```

### Component Tests

```typescript
// __tests__/components/ThemeToggle.test.tsx

import { render, screen, fireEvent } from '@testing-library/react';
import { ThemeToggle } from '@/components/ThemeToggle/ThemeToggle';
import { ThemeProvider } from '@/contexts/ThemeContext';

describe('ThemeToggle', () => {
  it('renders toggle button', () => {
    render(
      <ThemeProvider>
        <ThemeToggle />
      </ThemeProvider>
    );

    expect(screen.getByRole('button')).toBeInTheDocument();
  });

  it('shows correct icon for current theme', () => {
    render(
      <ThemeProvider>
        <ThemeToggle showLabel />
      </ThemeProvider>
    );

    // Initial theme is light, so should show dark mode option
    expect(screen.getByText(/Dark Mode/i)).toBeInTheDocument();
  });

  it('toggles theme on click', () => {
    render(
      <ThemeProvider>
        <ThemeToggle showLabel />
      </ThemeProvider>
    );

    const button = screen.getByRole('button');
    fireEvent.click(button);

    expect(screen.getByText(/Light Mode/i)).toBeInTheDocument();
  });

  it('has proper accessibility attributes', () => {
    render(
      <ThemeProvider>
        <ThemeToggle />
      </ThemeProvider>
    );

    const button = screen.getByRole('button');
    expect(button).toHaveAttribute('aria-label');
    expect(button).toHaveAttribute('title');
  });
});
```

### Integration Tests

```typescript
// __tests__/integration/theme-persistence.test.tsx

import { render, screen, fireEvent } from '@testing-library/react';
import { ThemeProvider, useTheme } from '@/contexts/ThemeContext';

const TestComponent = () => {
  const { theme, toggleTheme } = useTheme();
  return (
    <div>
      <div data-testid="theme">{theme}</div>
      <button onClick={toggleTheme}>Toggle</button>
    </div>
  );
};

describe('Theme Persistence', () => {
  beforeEach(() => {
    localStorage.clear();
  });

  it('persists theme across component remounts', () => {
    const { unmount, rerender } = render(
      <ThemeProvider>
        <TestComponent />
      </ThemeProvider>
    );

    // Toggle to dark
    fireEvent.click(screen.getByText('Toggle'));
    expect(screen.getByTestId('theme')).toHaveTextContent('dark');

    // Unmount and remount
    unmount();
    rerender(
      <ThemeProvider>
        <TestComponent />
      </ThemeProvider>
    );

    // Should still be dark
    expect(screen.getByTestId('theme')).toHaveTextContent('dark');
  });

  it('syncs theme across storage events', () => {
    render(
      <ThemeProvider>
        <TestComponent />
      </ThemeProvider>
    );

    // Simulate storage event from another tab
    const storageEvent = new StorageEvent('storage', {
      key: 'theme-preference',
      newValue: 'dark',
      oldValue: 'light',
    });

    window.dispatchEvent(storageEvent);

    expect(screen.getByTestId('theme')).toHaveTextContent('dark');
  });
});
```

### E2E Tests

```typescript
// e2e/theme.spec.ts

import { test, expect } from '@playwright/test';

test.describe('Dark Mode', () => {
  test('toggles theme via UI', async ({ page }) => {
    await page.goto('/');

    // Get initial background color
    const initialBg = await page.evaluate(() => {
      return getComputedStyle(document.body).backgroundColor;
    });

    // Click theme toggle
    await page.click('[aria-label*="Switch to"]');

    // Wait for transition
    await page.waitForTimeout(300);

    // Verify background color changed
    const newBg = await page.evaluate(() => {
      return getComputedStyle(document.body).backgroundColor;
    });

    expect(newBg).not.toBe(initialBg);
  });

  test('persists theme preference', async ({ page }) => {
    await page.goto('/');

    // Toggle to dark mode
    await page.click('[aria-label*="dark mode"]');

    // Reload page
    await page.reload();

    // Verify dark mode persisted
    const theme = await page.getAttribute('html', 'data-theme');
    expect(theme).toBe('dark');
  });

  test('respects system preference', async ({ page, context }) => {
    // Set dark mode preference
    await context.emulateMedia({ colorScheme: 'dark' });

    await page.goto('/');

    const theme = await page.getAttribute('html', 'data-theme');
    expect(theme).toBe('dark');
  });

  test('updates charts when theme changes', async ({ page }) => {
    await page.goto('/stocks/AAPL');

    // Wait for chart to load
    await page.waitForSelector('canvas');

    // Toggle theme
    await page.click('[aria-label*="Switch to"]');

    // Wait for chart update
    await page.waitForTimeout(500);

    // Verify chart background changed (implementation-specific)
    const canvasDataUrl = await page.evaluate(() => {
      const canvas = document.querySelector('canvas') as HTMLCanvasElement;
      return canvas.toDataURL();
    });

    expect(canvasDataUrl).toBeTruthy();
  });
});
```

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation Strategy | Owner |
|------|------------|--------|-------------------|-------|
| **FOUC (Flash of Unstyled Content)** | High | Medium | Add inline script in HTML head to set theme before render, use preload-transitions class | Dev Team |
| **localStorage quota exceeded** | Low | Low | Wrap localStorage calls in try-catch, provide fallback to sessionStorage | Dev Team |
| **System preference not supported (older browsers)** | Medium | Low | Graceful degradation, default to light theme, provide manual toggle | Dev Team |
| **Color contrast issues in dark mode** | Medium | High | Run automated WCAG tests, manual review with contrast checkers, use proven color palettes | UX/QA Team |
| **Chart library theme incompatibility** | Medium | Medium | Test all chart libraries thoroughly, provide custom theme adapters if needed | Dev Team |
| **Performance impact of CSS variables** | Low | Low | Benchmark render performance, use will-change hints sparingly | Dev Team |
| **Cross-tab sync causing infinite loops** | Low | Medium | Implement loop prevention logic, debounce storage event handlers | Dev Team |

## Performance Requirements

| Metric | Target | Measurement Method | Acceptance Threshold |
|--------|--------|-------------------|---------------------|
| **Theme Toggle Response** | < 50ms | Performance.now() | < 100ms |
| **CSS Variable Update** | Instant | Browser DevTools Timeline | < 16ms (1 frame) |
| **Transition Duration** | 200-300ms | CSS timing functions | 200-300ms |
| **Initial Load Impact** | < 10ms | Lighthouse Performance | No regression |
| **LocalStorage Read/Write** | < 5ms | Performance.now() | < 10ms |
| **Chart Theme Update** | < 200ms | Custom performance marker | < 300ms |
| **Cross-tab Sync Delay** | < 100ms | Storage event handler timing | < 200ms |

## Security Considerations

### XSS Prevention

```typescript
// src/utils/theme-security.ts

export function validateThemeMode(value: unknown): ThemeMode | null {
  if (typeof value !== 'string') return null;

  const validModes: ThemeMode[] = ['light', 'dark', 'system'];
  return validModes.includes(value as ThemeMode) ? (value as ThemeMode) : null;
}

export function sanitizeStorageValue(value: string | null): ThemeMode | null {
  if (!value) return null;

  // Only allow specific values
  const validated = validateThemeMode(value);
  return validated;
}
```

### Content Security Policy

```typescript
// next.config.js

const securityHeaders = [
  {
    key: 'Content-Security-Policy',
    value: [
      "default-src 'self'",
      "style-src 'self' 'unsafe-inline'", // CSS variables require inline styles
      "script-src 'self'",
    ].join('; ')
  }
];
```

### Safe localStorage Access

```typescript
// src/utils/safe-storage.ts

export class SafeStorage {
  static getItem(key: string): string | null {
    try {
      return localStorage.getItem(key);
    } catch (error) {
      console.error('localStorage.getItem failed:', error);
      return null;
    }
  }

  static setItem(key: string, value: string): boolean {
    try {
      localStorage.setItem(key, value);
      return true;
    } catch (error) {
      if (error instanceof DOMException && error.name === 'QuotaExceededError') {
        console.error('localStorage quota exceeded');
        // Attempt to clear old data
        this.clearOldData();
        try {
          localStorage.setItem(key, value);
          return true;
        } catch {
          return false;
        }
      }
      return false;
    }
  }

  private static clearOldData(): void {
    // Implementation to clear non-essential cached data
  }
}
```

## Error Handling

### Error Boundary for Theme

```typescript
// src/components/ThemeErrorBoundary.tsx

import React, { Component, ReactNode } from 'react';

interface Props {
  children: ReactNode;
}

interface State {
  hasError: boolean;
}

export class ThemeErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(): State {
    return { hasError: true };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('Theme error:', error, errorInfo);

    // Reset to light theme as fallback
    document.documentElement.setAttribute('data-theme', 'light');
    localStorage.removeItem('theme-preference');
  }

  render() {
    if (this.state.hasError) {
      return (
        <div style={{ padding: '20px', textAlign: 'center' }}>
          <h2>Theme system encountered an error</h2>
          <p>Falling back to light theme. Please refresh the page.</p>
          <button onClick={() => window.location.reload()}>
            Refresh Page
          </button>
        </div>
      );
    }

    return this.props.children;
  }
}
```

### Graceful Degradation

```typescript
// src/contexts/ThemeContext.tsx (enhanced)

const initializeTheme = (): ThemeMode => {
  try {
    // Try localStorage
    const stored = SafeStorage.getItem(STORAGE_KEY);
    const validated = sanitizeStorageValue(stored);
    if (validated) return validated;

    // Try system preference
    if (typeof window !== 'undefined' && window.matchMedia) {
      return 'system';
    }

    // Fallback to light
    return 'light';
  } catch (error) {
    console.error('Theme initialization failed:', error);
    return 'light';
  }
};
```

## Notes

### Design Considerations

- **Transition Timing**: Use 200ms for optimal perceived performance
- **Color Selection**: Ensure 4.5:1 contrast ratio for WCAG AA compliance
- **Chart Colors**: Maintain consistent bullish/bearish colors across themes
- **Loading Experience**: Prevent FOUC with inline theme script
- **Mobile Experience**: Respect system preference by default

### Future Enhancements

1. **Custom Themes**: Allow users to create custom color schemes
2. **Scheduled Switching**: Auto-switch based on time of day
3. **Per-page Themes**: Different themes for different sections
4. **High Contrast Mode**: Enhanced accessibility option
5. **Theme Marketplace**: Share and download community themes

### Dependencies

```json
{
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.0",
    "@testing-library/react": "^14.1.2",
    "jest": "^29.7.0",
    "playwright": "^1.40.0"
  }
}
```

### Browser Support

- Chrome 76+ (CSS variables support)
- Firefox 62+
- Safari 12.1+
- Edge 79+
- Mobile browsers: iOS Safari 12.2+, Chrome Mobile 76+

### Accessibility Compliance

- **WCAG 2.1 Level AA**: All color contrasts meet 4.5:1 minimum
- **Keyboard Navigation**: Theme toggle accessible via keyboard
- **Screen Reader**: Announces theme changes
- **Reduced Motion**: Respects prefers-reduced-motion
- **High Contrast**: Compatible with Windows High Contrast mode

### Performance Best Practices

1. Use CSS variables instead of JavaScript for theme switching
2. Disable transitions on initial page load
3. Debounce storage event handlers (50ms)
4. Cache system preference query result
5. Minimize DOM manipulation during theme switch

## References

- [IMPROVEMENT_TICKETS.md](../../IMPROVEMENT_TICKETS.md) - Epic 7: UX/UI Enhancements
- [CSS Custom Properties (MDN)](https://developer.mozilla.org/en-US/docs/Web/CSS/--*)
- [prefers-color-scheme (MDN)](https://developer.mozilla.org/en-US/docs/Web/CSS/@media/prefers-color-scheme)
- [WCAG 2.1 Contrast Guidelines](https://www.w3.org/WAI/WCAG21/Understanding/contrast-minimum.html)
- [React Context API](https://react.dev/reference/react/useContext)
