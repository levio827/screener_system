# UX-003: Keyboard Shortcuts

## Metadata

| Field | Value |
|-------|-------|
| **ID** | UX-003 |
| **Title** | Add Keyboard Navigation |
| **Type** | Feature |
| **Status** | BACKLOG |
| **Priority** | P2 (Medium) |
| **Estimate** | 8 hours |
| **Sprint** | Sprint 7 |
| **Epic** | UX/UI Enhancements |
| **Assignee** | TBD |
| **Created** | 2025-11-29 |
| **Updated** | 2025-11-30 |
| **Tags** | `accessibility`, `ux`, `keyboard-navigation`, `hotkeys`, `a11y` |
| **Blocks** | None |
| **Blocked By** | None |
| **Related** | None |

## Description

Implement comprehensive keyboard shortcuts for power users to navigate and control the application without using a mouse. The system will include a command palette, customizable shortcuts, and a help modal showing all available shortcuts.

## Progress

**0% - Not started**

## Acceptance Criteria

- [ ] Global shortcut handler
- [ ] Shortcuts help modal
- [ ] Conflict prevention (disable when input focused)
- [ ] Customization in settings

## Shortcuts

```
/       - Focus stock search
g + h   - Go to Home
g + s   - Go to Screener
g + p   - Go to Portfolio
g + w   - Go to Watchlist
j / k   - Move up/down in list
Enter   - Open selected item
Esc     - Close modal/search
?       - Shortcuts help
```

## Detailed Subtasks

### 1. Hotkey Library Integration
- [ ] Research and select hotkey library
  - [ ] Evaluate options (react-hotkeys-hook, hotkeys-js, tinykeys)
  - [ ] Install chosen library (recommend: react-hotkeys-hook)
  - [ ] Set up TypeScript definitions
- [ ] Create keyboard event manager
  - [ ] Implement global event listener
  - [ ] Handle key combination sequences
  - [ ] Manage hotkey registration/unregistration
- [ ] Add conflict detection
  - [ ] Detect input field focus
  - [ ] Disable shortcuts in textarea/contenteditable
  - [ ] Handle modal/dialog focus traps

### 2. Navigation Shortcuts
- [ ] Implement global navigation (g + key)
  - [ ] g + h → Navigate to Home page
  - [ ] g + s → Navigate to Screener
  - [ ] g + p → Navigate to Portfolio
  - [ ] g + w → Navigate to Watchlist
  - [ ] g + m → Navigate to Market Heatmap
- [ ] Implement focus management
  - [ ] / → Focus search input
  - [ ] Esc → Blur current input/close modal
  - [ ] Tab → Standard focus flow
  - [ ] Shift + Tab → Reverse focus flow

### 3. List Navigation
- [ ] Implement list traversal
  - [ ] j / Down Arrow → Move down in list
  - [ ] k / Up Arrow → Move up in list
  - [ ] Home → Jump to first item
  - [ ] End → Jump to last item
- [ ] Implement item selection
  - [ ] Enter → Open/activate selected item
  - [ ] Space → Toggle selection (multi-select)
  - [ ] Ctrl/Cmd + A → Select all
- [ ] Visual feedback
  - [ ] Highlight focused item
  - [ ] Scroll focused item into view
  - [ ] Show selection count

### 4. Command Palette
- [ ] Create command palette component
  - [ ] Build searchable command list
  - [ ] Implement fuzzy search
  - [ ] Display keyboard shortcuts inline
- [ ] Implement palette shortcuts
  - [ ] Ctrl/Cmd + K → Open command palette
  - [ ] Type to filter commands
  - [ ] Arrow keys to navigate results
  - [ ] Enter to execute command
- [ ] Command categories
  - [ ] Navigation commands
  - [ ] Action commands (add to watchlist, etc.)
  - [ ] View commands (change chart type, etc.)
  - [ ] Settings commands

### 5. Help Modal
- [ ] Design shortcuts help UI
  - [ ] Group shortcuts by category
  - [ ] Show key combinations visually
  - [ ] Include search functionality
- [ ] Implement help modal
  - [ ] ? → Open help modal
  - [ ] Display all available shortcuts
  - [ ] Filter by category or search
  - [ ] Print-friendly format
- [ ] Accessibility features
  - [ ] Screen reader announcements
  - [ ] Keyboard navigation within modal
  - [ ] High contrast mode support

### 6. Customization System
- [ ] Build shortcut customization UI
  - [ ] Settings page for shortcuts
  - [ ] Visual key binding editor
  - [ ] Conflict warning display
  - [ ] Reset to defaults button
- [ ] Persistence layer
  - [ ] Save custom shortcuts to localStorage
  - [ ] Optional server-side sync
  - [ ] Import/export configuration
- [ ] Validation
  - [ ] Prevent reserved key conflicts
  - [ ] Warn about OS/browser conflicts
  - [ ] Ensure unique key combinations

### 7. Accessibility & Context Awareness
- [ ] Smart context detection
  - [ ] Disable shortcuts in input fields
  - [ ] Different shortcuts in modals
  - [ ] Page-specific shortcuts
- [ ] Screen reader integration
  - [ ] Announce shortcut activation
  - [ ] Provide text alternatives
  - [ ] ARIA live regions for feedback
- [ ] Platform compatibility
  - [ ] Detect OS (Mac vs Windows/Linux)
  - [ ] Use appropriate modifier keys
  - [ ] Handle browser-specific quirks

## Implementation Details

### Hotkey Manager Hook

```typescript
// src/hooks/useHotkeys.ts

import { useEffect, useCallback, useRef } from 'react';
import { useRouter } from 'next/router';

export type ModifierKey = 'ctrl' | 'alt' | 'shift' | 'meta';
export type HotkeyHandler = (event: KeyboardEvent) => void;

export interface HotkeyConfig {
  key: string;
  modifiers?: ModifierKey[];
  description: string;
  category?: string;
  global?: boolean;
  enabled?: boolean;
}

interface HotkeyOptions {
  enabled?: boolean;
  preventDefault?: boolean;
  enableInInput?: boolean;
}

const isInputElement = (element: EventTarget | null): boolean => {
  if (!element || !(element instanceof HTMLElement)) return false;

  const tagName = element.tagName.toLowerCase();
  const isEditable = element.isContentEditable;

  return (
    ['input', 'textarea', 'select'].includes(tagName) ||
    isEditable
  );
};

const matchesModifiers = (
  event: KeyboardEvent,
  modifiers: ModifierKey[] = []
): boolean => {
  const pressedModifiers = {
    ctrl: event.ctrlKey,
    alt: event.altKey,
    shift: event.shiftKey,
    meta: event.metaKey,
  };

  // Check all required modifiers are pressed
  const requiredPressed = modifiers.every(mod => pressedModifiers[mod]);

  // Check no extra modifiers are pressed (except shift for uppercase letters)
  const extraPressed = Object.entries(pressedModifiers)
    .filter(([key, pressed]) => pressed && !modifiers.includes(key as ModifierKey))
    .length > 0;

  return requiredPressed && !extraPressed;
};

export const useHotkey = (
  config: HotkeyConfig,
  handler: HotkeyHandler,
  options: HotkeyOptions = {}
) => {
  const {
    enabled = true,
    preventDefault = true,
    enableInInput = false,
  } = options;

  const handlerRef = useRef(handler);
  handlerRef.current = handler;

  useEffect(() => {
    if (!enabled) return;

    const handleKeyDown = (event: KeyboardEvent) => {
      // Skip if in input and not explicitly enabled
      if (!enableInInput && isInputElement(event.target)) {
        return;
      }

      // Check if key matches
      const key = event.key.toLowerCase();
      const configKey = config.key.toLowerCase();

      if (key !== configKey) return;

      // Check modifiers
      if (!matchesModifiers(event, config.modifiers)) return;

      // Execute handler
      if (preventDefault) {
        event.preventDefault();
      }

      handlerRef.current(event);
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [enabled, preventDefault, enableInInput, config.key, config.modifiers]);
};

// Hook for sequential key combinations (e.g., g + h)
export const useSequentialHotkey = (
  sequence: string[],
  handler: HotkeyHandler,
  options: HotkeyOptions = {}
) => {
  const sequenceRef = useRef<string[]>([]);
  const timeoutRef = useRef<NodeJS.Timeout>();

  const { enabled = true, preventDefault = true } = options;
  const handlerRef = useRef(handler);
  handlerRef.current = handler;

  useEffect(() => {
    if (!enabled) return;

    const handleKeyDown = (event: KeyboardEvent) => {
      if (isInputElement(event.target)) return;

      const key = event.key.toLowerCase();

      // Add to sequence
      sequenceRef.current.push(key);

      // Clear timeout and set new one
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }

      timeoutRef.current = setTimeout(() => {
        sequenceRef.current = [];
      }, 1000); // Reset after 1 second

      // Check if sequence matches
      if (sequenceRef.current.length === sequence.length) {
        const matches = sequence.every(
          (key, index) => key.toLowerCase() === sequenceRef.current[index]
        );

        if (matches) {
          if (preventDefault) {
            event.preventDefault();
          }
          handlerRef.current(event);
          sequenceRef.current = [];
        }
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => {
      window.removeEventListener('keydown', handleKeyDown);
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, [enabled, preventDefault, sequence]);
};
```

### Global Keyboard Shortcuts Component

```typescript
// src/components/GlobalHotkeys/GlobalHotkeys.tsx

import React, { useState, useCallback } from 'react';
import { useRouter } from 'next/router';
import { useHotkey, useSequentialHotkey } from '@/hooks/useHotkeys';
import { CommandPalette } from './CommandPalette';
import { ShortcutsHelpModal } from './ShortcutsHelpModal';

export const GlobalHotkeys: React.FC = () => {
  const router = useRouter();
  const [isCommandPaletteOpen, setCommandPaletteOpen] = useState(false);
  const [isHelpModalOpen, setHelpModalOpen] = useState(false);

  // Command Palette
  useHotkey(
    { key: 'k', modifiers: ['meta'], description: 'Open command palette' },
    () => setCommandPaletteOpen(true)
  );

  useHotkey(
    { key: 'k', modifiers: ['ctrl'], description: 'Open command palette' },
    () => setCommandPaletteOpen(true)
  );

  // Help Modal
  useHotkey(
    { key: '?', description: 'Show keyboard shortcuts help' },
    () => setHelpModalOpen(true)
  );

  // Search Focus
  useHotkey(
    { key: '/', description: 'Focus search input' },
    () => {
      const searchInput = document.querySelector<HTMLInputElement>(
        'input[type="search"], input[placeholder*="Search"]'
      );
      searchInput?.focus();
    },
    { preventDefault: true }
  );

  // Navigation Shortcuts (g + key)
  useSequentialHotkey(['g', 'h'], () => router.push('/'));
  useSequentialHotkey(['g', 's'], () => router.push('/screener'));
  useSequentialHotkey(['g', 'p'], () => router.push('/portfolio'));
  useSequentialHotkey(['g', 'w'], () => router.push('/watchlist'));
  useSequentialHotkey(['g', 'm'], () => router.push('/market/heatmap'));

  // Close Modal/Search
  useHotkey(
    { key: 'Escape', description: 'Close modal or clear search' },
    () => {
      const activeElement = document.activeElement as HTMLElement;
      if (activeElement && isInputElement(activeElement)) {
        activeElement.blur();
      }
    }
  );

  return (
    <>
      {isCommandPaletteOpen && (
        <CommandPalette onClose={() => setCommandPaletteOpen(false)} />
      )}

      {isHelpModalOpen && (
        <ShortcutsHelpModal onClose={() => setHelpModalOpen(false)} />
      )}
    </>
  );
};

function isInputElement(element: HTMLElement): boolean {
  const tagName = element.tagName.toLowerCase();
  return ['input', 'textarea', 'select'].includes(tagName) || element.isContentEditable;
}
```

### Command Palette

```typescript
// src/components/GlobalHotkeys/CommandPalette.tsx

import React, { useState, useEffect, useRef } from 'react';
import { useRouter } from 'next/router';
import { useHotkey } from '@/hooks/useHotkeys';
import styles from './CommandPalette.module.css';

interface Command {
  id: string;
  label: string;
  description?: string;
  shortcut?: string;
  category: 'navigation' | 'action' | 'view' | 'settings';
  action: () => void;
  keywords?: string[];
}

interface CommandPaletteProps {
  onClose: () => void;
}

export const CommandPalette: React.FC<CommandPaletteProps> = ({ onClose }) => {
  const router = useRouter();
  const [query, setQuery] = useState('');
  const [selectedIndex, setSelectedIndex] = useState(0);
  const inputRef = useRef<HTMLInputElement>(null);

  const commands: Command[] = [
    {
      id: 'nav-home',
      label: 'Go to Home',
      shortcut: 'g h',
      category: 'navigation',
      action: () => router.push('/'),
      keywords: ['home', 'dashboard'],
    },
    {
      id: 'nav-screener',
      label: 'Go to Screener',
      shortcut: 'g s',
      category: 'navigation',
      action: () => router.push('/screener'),
      keywords: ['screener', 'filter', 'search'],
    },
    {
      id: 'nav-portfolio',
      label: 'Go to Portfolio',
      shortcut: 'g p',
      category: 'navigation',
      action: () => router.push('/portfolio'),
      keywords: ['portfolio', 'holdings'],
    },
    {
      id: 'nav-watchlist',
      label: 'Go to Watchlist',
      shortcut: 'g w',
      category: 'navigation',
      action: () => router.push('/watchlist'),
      keywords: ['watchlist', 'favorites'],
    },
    {
      id: 'nav-heatmap',
      label: 'Go to Market Heatmap',
      shortcut: 'g m',
      category: 'navigation',
      action: () => router.push('/market/heatmap'),
      keywords: ['heatmap', 'market', 'overview'],
    },
    // Add more commands...
  ];

  // Filter commands based on query
  const filteredCommands = commands.filter(cmd => {
    const searchText = query.toLowerCase();
    return (
      cmd.label.toLowerCase().includes(searchText) ||
      cmd.description?.toLowerCase().includes(searchText) ||
      cmd.keywords?.some(kw => kw.includes(searchText))
    );
  });

  // Focus input on mount
  useEffect(() => {
    inputRef.current?.focus();
  }, []);

  // Reset selected index when results change
  useEffect(() => {
    setSelectedIndex(0);
  }, [query]);

  // Handle keyboard navigation
  useHotkey(
    { key: 'ArrowDown', description: 'Next command' },
    () => {
      setSelectedIndex(prev =>
        prev < filteredCommands.length - 1 ? prev + 1 : prev
      );
    },
    { enableInInput: true, preventDefault: true }
  );

  useHotkey(
    { key: 'ArrowUp', description: 'Previous command' },
    () => {
      setSelectedIndex(prev => (prev > 0 ? prev - 1 : prev));
    },
    { enableInInput: true, preventDefault: true }
  );

  useHotkey(
    { key: 'Enter', description: 'Execute command' },
    () => {
      const selectedCommand = filteredCommands[selectedIndex];
      if (selectedCommand) {
        selectedCommand.action();
        onClose();
      }
    },
    { enableInInput: true, preventDefault: true }
  );

  useHotkey(
    { key: 'Escape', description: 'Close palette' },
    onClose,
    { enableInInput: true }
  );

  return (
    <div className={styles.overlay} onClick={onClose}>
      <div className={styles.palette} onClick={e => e.stopPropagation()}>
        <input
          ref={inputRef}
          type="text"
          className={styles.input}
          placeholder="Type a command or search..."
          value={query}
          onChange={e => setQuery(e.target.value)}
        />

        <div className={styles.results}>
          {filteredCommands.length === 0 ? (
            <div className={styles.noResults}>No commands found</div>
          ) : (
            filteredCommands.map((cmd, index) => (
              <button
                key={cmd.id}
                className={`${styles.command} ${
                  index === selectedIndex ? styles.selected : ''
                }`}
                onClick={() => {
                  cmd.action();
                  onClose();
                }}
                onMouseEnter={() => setSelectedIndex(index)}
              >
                <div className={styles.commandInfo}>
                  <div className={styles.label}>{cmd.label}</div>
                  {cmd.description && (
                    <div className={styles.description}>{cmd.description}</div>
                  )}
                </div>
                {cmd.shortcut && (
                  <kbd className={styles.shortcut}>{cmd.shortcut}</kbd>
                )}
              </button>
            ))
          )}
        </div>
      </div>
    </div>
  );
};
```

### Shortcuts Help Modal

```typescript
// src/components/GlobalHotkeys/ShortcutsHelpModal.tsx

import React from 'react';
import { useHotkey } from '@/hooks/useHotkeys';
import styles from './ShortcutsHelpModal.module.css';

interface ShortcutsHelpModalProps {
  onClose: () => void;
}

interface ShortcutGroup {
  title: string;
  shortcuts: Array<{
    keys: string;
    description: string;
  }>;
}

export const ShortcutsHelpModal: React.FC<ShortcutsHelpModalProps> = ({ onClose }) => {
  useHotkey({ key: 'Escape', description: 'Close help' }, onClose);

  const shortcutGroups: ShortcutGroup[] = [
    {
      title: 'Navigation',
      shortcuts: [
        { keys: 'g h', description: 'Go to Home' },
        { keys: 'g s', description: 'Go to Screener' },
        { keys: 'g p', description: 'Go to Portfolio' },
        { keys: 'g w', description: 'Go to Watchlist' },
        { keys: 'g m', description: 'Go to Market Heatmap' },
      ],
    },
    {
      title: 'Search & Actions',
      shortcuts: [
        { keys: '/', description: 'Focus search input' },
        { keys: '⌘ K or Ctrl K', description: 'Open command palette' },
        { keys: 'Esc', description: 'Close modal or clear focus' },
      ],
    },
    {
      title: 'List Navigation',
      shortcuts: [
        { keys: 'j or ↓', description: 'Move down in list' },
        { keys: 'k or ↑', description: 'Move up in list' },
        { keys: 'Enter', description: 'Open selected item' },
        { keys: 'Space', description: 'Toggle selection' },
        { keys: 'Home', description: 'Jump to first item' },
        { keys: 'End', description: 'Jump to last item' },
      ],
    },
    {
      title: 'General',
      shortcuts: [
        { keys: '?', description: 'Show this help dialog' },
        { keys: 'Tab', description: 'Next element' },
        { keys: 'Shift Tab', description: 'Previous element' },
      ],
    },
  ];

  return (
    <div className={styles.overlay} onClick={onClose}>
      <div className={styles.modal} onClick={e => e.stopPropagation()}>
        <div className={styles.header}>
          <h2>Keyboard Shortcuts</h2>
          <button className={styles.closeButton} onClick={onClose}>
            ✕
          </button>
        </div>

        <div className={styles.content}>
          {shortcutGroups.map(group => (
            <div key={group.title} className={styles.group}>
              <h3 className={styles.groupTitle}>{group.title}</h3>
              <div className={styles.shortcuts}>
                {group.shortcuts.map(shortcut => (
                  <div key={shortcut.keys} className={styles.shortcut}>
                    <kbd className={styles.keys}>{shortcut.keys}</kbd>
                    <span className={styles.description}>{shortcut.description}</span>
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>

        <div className={styles.footer}>
          <p>Press <kbd>Esc</kbd> to close this dialog</p>
        </div>
      </div>
    </div>
  );
};
```

### List Navigation Hook

```typescript
// src/hooks/useListNavigation.ts

import { useState, useEffect, useCallback, useRef } from 'react';
import { useHotkey } from './useHotkeys';

interface UseListNavigationOptions<T> {
  items: T[];
  onSelect?: (item: T, index: number) => void;
  initialIndex?: number;
  loop?: boolean;
  enabled?: boolean;
}

export const useListNavigation = <T>({
  items,
  onSelect,
  initialIndex = -1,
  loop = true,
  enabled = true,
}: UseListNavigationOptions<T>) => {
  const [selectedIndex, setSelectedIndex] = useState(initialIndex);
  const listRef = useRef<HTMLElement | null>(null);

  const selectedItem = selectedIndex >= 0 ? items[selectedIndex] : null;

  // Move down (j or Arrow Down)
  const moveDown = useCallback(() => {
    setSelectedIndex(prev => {
      if (prev < items.length - 1) {
        return prev + 1;
      }
      return loop ? 0 : prev;
    });
  }, [items.length, loop]);

  // Move up (k or Arrow Up)
  const moveUp = useCallback(() => {
    setSelectedIndex(prev => {
      if (prev > 0) {
        return prev - 1;
      }
      return loop ? items.length - 1 : prev;
    });
  }, [items.length, loop]);

  // Jump to first (Home)
  const jumpToFirst = useCallback(() => {
    setSelectedIndex(0);
  }, []);

  // Jump to last (End)
  const jumpToLast = useCallback(() => {
    setSelectedIndex(items.length - 1);
  }, [items.length]);

  // Select current item (Enter)
  const selectCurrent = useCallback(() => {
    if (selectedIndex >= 0 && onSelect) {
      onSelect(items[selectedIndex], selectedIndex);
    }
  }, [selectedIndex, items, onSelect]);

  // Keyboard shortcuts
  useHotkey({ key: 'j', description: 'Move down' }, moveDown, { enabled });
  useHotkey({ key: 'ArrowDown', description: 'Move down' }, moveDown, { enabled });
  useHotkey({ key: 'k', description: 'Move up' }, moveUp, { enabled });
  useHotkey({ key: 'ArrowUp', description: 'Move up' }, moveUp, { enabled });
  useHotkey({ key: 'Home', description: 'Jump to first' }, jumpToFirst, { enabled });
  useHotkey({ key: 'End', description: 'Jump to last' }, jumpToLast, { enabled });
  useHotkey({ key: 'Enter', description: 'Select item' }, selectCurrent, { enabled });

  // Scroll selected item into view
  useEffect(() => {
    if (selectedIndex >= 0 && listRef.current) {
      const selectedElement = listRef.current.children[selectedIndex] as HTMLElement;
      selectedElement?.scrollIntoView({
        block: 'nearest',
        behavior: 'smooth',
      });
    }
  }, [selectedIndex]);

  return {
    selectedIndex,
    selectedItem,
    setSelectedIndex,
    moveDown,
    moveUp,
    jumpToFirst,
    jumpToLast,
    selectCurrent,
    listRef,
  };
};
```

## Testing Strategy

### Unit Tests

```typescript
// __tests__/hooks/useHotkeys.test.ts

import { renderHook } from '@testing-library/react';
import { useHotkey } from '@/hooks/useHotkeys';

describe('useHotkey', () => {
  it('calls handler when hotkey is pressed', () => {
    const handler = jest.fn();

    renderHook(() =>
      useHotkey({ key: 'k', modifiers: ['meta'], description: 'Test' }, handler)
    );

    // Simulate Cmd+K
    const event = new KeyboardEvent('keydown', { key: 'k', metaKey: true });
    window.dispatchEvent(event);

    expect(handler).toHaveBeenCalled();
  });

  it('does not call handler in input fields by default', () => {
    const handler = jest.fn();

    renderHook(() =>
      useHotkey({ key: 'k', description: 'Test' }, handler)
    );

    // Create input and focus it
    const input = document.createElement('input');
    document.body.appendChild(input);
    input.focus();

    // Simulate key press
    const event = new KeyboardEvent('keydown', { key: 'k' });
    Object.defineProperty(event, 'target', { value: input });
    window.dispatchEvent(event);

    expect(handler).not.toHaveBeenCalled();

    document.body.removeChild(input);
  });

  it('calls handler in input when enableInInput is true', () => {
    const handler = jest.fn();

    renderHook(() =>
      useHotkey({ key: 'k', description: 'Test' }, handler, { enableInInput: true })
    );

    const input = document.createElement('input');
    document.body.appendChild(input);
    input.focus();

    const event = new KeyboardEvent('keydown', { key: 'k' });
    Object.defineProperty(event, 'target', { value: input });
    window.dispatchEvent(event);

    expect(handler).toHaveBeenCalled();

    document.body.removeChild(input);
  });
});
```

### Integration Tests

```typescript
// __tests__/integration/keyboard-navigation.test.tsx

import { render, screen, fireEvent } from '@testing-library/react';
import { GlobalHotkeys } from '@/components/GlobalHotkeys/GlobalHotkeys';
import { useRouter } from 'next/router';

jest.mock('next/router', () => ({
  useRouter: jest.fn(),
}));

describe('Keyboard Navigation', () => {
  const mockPush = jest.fn();

  beforeEach(() => {
    (useRouter as jest.Mock).mockReturnValue({ push: mockPush });
  });

  it('opens command palette with Cmd+K', () => {
    render(<GlobalHotkeys />);

    fireEvent.keyDown(window, { key: 'k', metaKey: true });

    expect(screen.getByPlaceholderText(/command or search/i)).toBeInTheDocument();
  });

  it('navigates to screener with g+s sequence', () => {
    render(<GlobalHotkeys />);

    fireEvent.keyDown(window, { key: 'g' });
    fireEvent.keyDown(window, { key: 's' });

    expect(mockPush).toHaveBeenCalledWith('/screener');
  });

  it('shows help modal with ?', () => {
    render(<GlobalHotkeys />);

    fireEvent.keyDown(window, { key: '?' });

    expect(screen.getByText(/Keyboard Shortcuts/i)).toBeInTheDocument();
  });
});
```

### E2E Tests

```typescript
// e2e/keyboard-shortcuts.spec.ts

import { test, expect } from '@playwright/test';

test.describe('Keyboard Shortcuts', () => {
  test('command palette opens and executes command', async ({ page }) => {
    await page.goto('/');

    // Open command palette
    await page.keyboard.press('Meta+K');

    // Verify palette is visible
    await expect(page.locator('input[placeholder*="command"]')).toBeVisible();

    // Type to filter
    await page.keyboard.type('screener');

    // Press Enter to execute
    await page.keyboard.press('Enter');

    // Verify navigation
    await expect(page).toHaveURL(/\/screener/);
  });

  test('sequential navigation shortcuts work', async ({ page }) => {
    await page.goto('/');

    // Press g then h
    await page.keyboard.press('g');
    await page.keyboard.press('h');

    // Should navigate to home
    await expect(page).toHaveURL('/');
  });

  test('list navigation with j/k keys', async ({ page }) => {
    await page.goto('/watchlist');

    // Press j to move down
    await page.keyboard.press('j');

    // Verify first item is highlighted
    const firstItem = page.locator('[data-list-item]').first();
    await expect(firstItem).toHaveClass(/selected/);

    // Press Enter to open
    await page.keyboard.press('Enter');

    // Verify navigation to detail page
    await expect(page).toHaveURL(/\/stocks\/\w+/);
  });
});
```

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation Strategy | Owner |
|------|------------|--------|-------------------|-------|
| **Browser/OS shortcut conflicts** | High | Medium | Detect platform, use less common combinations, allow customization | Dev Team |
| **Accessibility issues for keyboard-only users** | Medium | High | Thorough testing with keyboard navigation, follow WCAG guidelines | QA/A11y Team |
| **Performance impact of global listeners** | Low | Low | Use event delegation, debounce handlers, cleanup on unmount | Dev Team |
| **Input field interference** | Medium | Medium | Implement robust input detection, whitelist specific shortcuts | Dev Team |
| **User confusion about available shortcuts** | High | Medium | Prominent help button, discoverable command palette, tooltips | UX Team |
| **Custom shortcuts not syncing** | Low | Medium | Implement proper sync logic, conflict resolution, backup to cloud | Dev Team |
| **Modal focus trap conflicts** | Medium | Low | Proper focus management, test with all modals | QA Team |

## Performance Requirements

| Metric | Target | Measurement Method | Acceptance Threshold |
|--------|--------|-------------------|---------------------|
| **Shortcut Response Time** | < 50ms | Performance.now() | < 100ms |
| **Command Palette Load** | < 100ms | Time to interactive | < 200ms |
| **List Navigation FPS** | 60 FPS | requestAnimationFrame | > 55 FPS |
| **Help Modal Load** | < 150ms | Time to render | < 250ms |
| **Memory Usage** | < 5MB | Chrome DevTools | < 10MB |

## Security Considerations

### Input Sanitization

```typescript
// src/utils/shortcut-security.ts

export function sanitizeShortcutInput(input: string): string {
  // Only allow alphanumeric and specific special keys
  const allowedKeys = /^[a-z0-9\-\[\]\\;',./`]$/i;
  return input.trim().toLowerCase().replace(/[^a-z0-9\-]/gi, '');
}

export function isAllowedShortcut(key: string, modifiers: string[]): boolean {
  // Prevent dangerous shortcuts
  const dangerous = [
    { key: 'w', modifiers: ['meta'] }, // Close window
    { key: 'q', modifiers: ['meta'] }, // Quit app
    { key: 'r', modifiers: ['meta'] }, // Refresh (without confirmation)
  ];

  return !dangerous.some(
    d => d.key === key && d.modifiers.every(m => modifiers.includes(m))
  );
}
```

### XSS Prevention

- Sanitize all command labels and descriptions
- Use React's built-in XSS protection
- Validate custom shortcut configurations

## Error Handling

```typescript
// src/utils/hotkey-error-handler.ts

export class HotkeyError extends Error {
  constructor(message: string, public code: string) {
    super(message);
    this.name = 'HotkeyError';
  }
}

export function handleHotkeyError(error: Error, context: string): void {
  console.error(`Hotkey error in ${context}:`, error);

  // Log to error tracking service
  if (typeof window !== 'undefined' && (window as any).Sentry) {
    (window as any).Sentry.captureException(error, {
      tags: { component: 'hotkeys', context },
    });
  }

  // Show user-friendly message
  // (Implementation depends on notification system)
}
```

## Notes

### Design Considerations

- Use OS-appropriate modifier key symbols (⌘ for Mac, Ctrl for Windows/Linux)
- Provide visual feedback for all shortcut actions
- Group related shortcuts in help modal
- Make shortcuts discoverable through UI hints

### Future Enhancements

1. **Vim-style Navigation**: Advanced navigation modes
2. **Shortcut Recording**: Visual key capture for customization
3. **Shortcut Suggestions**: ML-based recommendations
4. **Conflict Auto-Resolution**: Smart conflict detection and resolution
5. **Mobile Gesture Mapping**: Map shortcuts to swipe gestures on mobile

### Dependencies

```json
{
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.0",
    "@testing-library/react": "^14.1.2",
    "jest": "^29.7.0",
    "playwright": "^1.40.0"
  }
}
```

### Browser Support

- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

### Accessibility Compliance

- **WCAG 2.1 Level AA**: Full keyboard navigation support
- **Screen Reader**: All shortcuts announced properly
- **Focus Management**: Visible focus indicators
- **Skip Links**: Provide skip navigation links

## References

- [IMPROVEMENT_TICKETS.md](../../IMPROVEMENT_TICKETS.md) - Epic 7: UX/UI Enhancements
- [ARIA Authoring Practices Guide](https://www.w3.org/WAI/ARIA/apg/)
- [Keyboard Event Reference](https://developer.mozilla.org/en-US/docs/Web/API/KeyboardEvent)
- [Gmail Keyboard Shortcuts](https://support.google.com/mail/answer/6594) - Inspiration
