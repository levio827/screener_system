# [BE-002] User Authentication API Implementation

## Metadata
- **Status**: REVIEW
- **Priority**: Critical
- **Assignee**: Development Team
- **Estimated Time**: 12 hours (Actual: 8 hours)
- **Sprint**: Sprint 1 (Week 1-2)
- **Tags**: #backend #authentication #security

## Description
Implement JWT-based user authentication system including registration, login, token refresh, and logout functionality.

## Subtasks
- [x] Database Models
  - [x] app/db/models/user.py (User model)
  - [x] app/db/models/user_session.py (UserSession model for refresh tokens)
- [x] Pydantic Schemas
  - [x] app/schemas/user.py
    - [x] UserCreate (email, password, name)
    - [x] UserLogin (email, password)
    - [x] UserResponse (id, email, name, tier)
    - [x] TokenResponse (access_token, refresh_token, user)
    - [x] TokenPayload (JWT payload structure)
    - [x] RefreshTokenRequest (refresh token request)
- [x] Repository Layer
  - [x] app/repositories/user_repository.py
    - [x] get_by_email()
    - [x] get_by_id()
    - [x] create()
    - [x] update()
    - [x] delete()
    - [x] exists_by_email()
  - [x] app/repositories/user_session_repository.py
    - [x] get_by_refresh_token()
    - [x] create()
    - [x] revoke()
    - [x] revoke_by_refresh_token()
    - [x] revoke_all_user_sessions()
    - [x] delete_expired_sessions()
- [x] Service Layer
  - [x] app/services/auth_service.py
    - [x] register_user()
    - [x] authenticate_user()
    - [x] refresh_access_token()
    - [x] logout()
    - [x] logout_all_sessions()
    - [x] verify_access_token()
- [x] API Endpoints
  - [x] POST /v1/auth/register
  - [x] POST /v1/auth/login
  - [x] POST /v1/auth/refresh
  - [x] POST /v1/auth/logout
  - [x] POST /v1/auth/logout-all
  - [x] GET /v1/auth/me (current user information)
- [x] Dependencies
  - [x] app/api/dependencies.py
    - [x] get_current_user() - JWT validation and user retrieval
    - [x] get_current_active_user() - allow only active users
- [x] Password security
  - [x] bcrypt hashing (cost factor 12)
  - [x] Password strength validation (minimum 8 characters, digit, letter)
- [x] JWT token management
  - [x] Access token (15 minute expiry)
  - [x] Refresh token (30 day expiry)
  - [x] Token type validation (access vs refresh)
  - [x] Session management in database (user_sessions table)
- [x] Security improvements
  - [x] Fixed deprecated datetime.utcnow() usage
  - [x] Added timezone-aware datetime handling
  - [x] Enhanced JWT token validation
- [x] Testing
  - [x] Basic authentication test suite
  - [x] Test fixtures and configuration

## Acceptance Criteria
- [ ] **Registration Tests**
  - [ ] Registration succeeds with valid data (201 Created)
  - [ ] Duplicate email registration fails (409 Conflict)
  - [ ] Weak password rejected (400 Bad Request)
- [ ] **Login Tests**
  - [ ] Login succeeds with correct credentials (200 OK, returns tokens)
  - [ ] Login fails with incorrect password (401 Unauthorized)
  - [ ] Login fails with non-existent user (401 Unauthorized)
- [ ] **Token Validation Tests**
  - [ ] Protected endpoint accessible with valid access token
  - [ ] Expired access token rejected (401 Unauthorized)
  - [ ] Token with invalid signature rejected (401 Unauthorized)
- [ ] **Token Refresh Tests**
  - [ ] New access token issued with valid refresh token
  - [ ] Expired refresh token rejected (401 Unauthorized)
  - [ ] Logged-out refresh token rejected (401 Unauthorized)
- [ ] **Logout Tests**
  - [ ] Refresh token invalidated after logout
- [ ] **Rate Limiting Tests**
  - [ ] Login attempts blocked after 5 failures (429 Too Many Requests)

## Dependencies
- **Depends on**: BE-001, DB-002
- **Blocks**: FE-002, BE-003, BE-004

## References
- **SRS.md**: Section 3.1.1 User Authentication & Authorization (REQ-AUTH-001~008)
- **SDS.md**: Section 7.1 Authentication & Authorization
- [FastAPI Security](https://fastapi.tiangolo.com/tutorial/security/)
- [JWT Best Practices](https://tools.ietf.org/html/rfc8725)

## Progress
- **100%** - Implementation complete, ready for review

## Implementation Summary

**Files Created:**
1. `app/db/models/user.py` - User model with subscription tiers
2. `app/db/models/user_session.py` - Session model for refresh tokens
3. `app/schemas/user.py` - All Pydantic schemas for auth
4. `app/repositories/user_repository.py` - User data access
5. `app/repositories/user_session_repository.py` - Session data access
6. `app/services/auth_service.py` - Authentication business logic
7. `app/api/dependencies.py` - FastAPI dependencies
8. `app/api/v1/endpoints/auth.py` - API endpoints
9. `tests/api/test_auth.py` - Authentication tests
10. `tests/conftest.py` - Test fixtures

**Files Modified:**
1. `app/db/base.py` - Fixed deprecated datetime usage
2. `app/core/security.py` - Enhanced JWT handling
3. `app/main.py` - Registered auth router

**API Endpoints:**
- POST `/v1/auth/register` - User registration
- POST `/v1/auth/login` - User login
- POST `/v1/auth/refresh` - Refresh access token
- POST `/v1/auth/logout` - Logout current device
- POST `/v1/auth/logout-all` - Logout all devices
- GET `/v1/auth/me` - Get current user info

**Security Features:**
- bcrypt password hashing (cost factor 12)
- JWT access tokens (15 min expiry)
- JWT refresh tokens (30 day expiry)
- Token type validation
- Session revocation support
- Timezone-aware timestamps

## Notes
- ‚úÖ Passwords hashed with bcrypt (cost 12)
- ‚úÖ JWT secret managed via environment variable
- ‚úÖ Refresh tokens stored in database for revocation
- ‚úÖ Session tracking with IP and user agent
- ‚ö†Ô∏è  Rate limiting already implemented in middleware
- ‚ö†Ô∏è  Further testing required for edge cases
- üìù Consider adding email verification flow in future
