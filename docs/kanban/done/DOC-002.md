# DOC-002: Python Backend API Auto-Documentation Integration

## Metadata
- **Type**: Documentation Infrastructure
- **Priority**: High
- **Status**: REVIEW
- **Created**: 2025-11-12
- **Assignee**: TBD
- **Estimate**: 12 hours
- **Sprint**: Documentation Sprint 1
- **Dependencies**: DOC-001

## Description

Integrate automated API documentation generation from Python backend source code using Sphinx + autodoc. This will create comprehensive API reference documentation from docstrings in FastAPI endpoints, services, repositories, and models.

## Background

The Python backend includes:
- **60+ Python modules** across backend, data_pipeline, and database
- **FastAPI endpoints** with Pydantic schemas
- **Service layer** with business logic
- **Repository layer** with database operations
- **SQLAlchemy models** with relationships

Current documentation is minimal docstrings that need to be:
- Standardized to Google/NumPy style
- Auto-generated into browsable HTML
- Integrated with main documentation platform

## Requirements

### Documentation Coverage
1. **API Endpoints** (`app/api/v1/endpoints/`)
   - HTTP methods, parameters, responses
   - Request/response schemas
   - Authentication requirements
   - Rate limiting info
2. **Services** (`app/services/`)
   - Public methods and their purpose
   - Parameters and return types
   - Caching behavior
3. **Repositories** (`app/repositories/`)
   - Database operations
   - Query methods
   - Transaction handling
4. **Models** (`app/db/models/`)
   - Table schemas
   - Relationships
   - Constraints
5. **Core Utilities** (`app/core/`)
   - Configuration
   - Exceptions
   - Cache management
6. **Data Pipeline** (`data_pipeline/`)
   - DAG definitions
   - KIS API client
   - Data sources

### Docstring Standards
- **Format**: Google style (already used in kis_api_client.py)
- **Required sections**: Description, Args, Returns, Raises, Example
- **Type hints**: Mandatory for all functions

## Acceptance Criteria

- [x] Sphinx configured and integrated with documentation platform
- [x] Python autodoc extension working
- [x] API reference pages auto-generated for all modules
- [x] Docstrings follow Google style consistently
- [x] Type hints visible in documentation
- [x] Cross-references between modules working
- [ ] FastAPI OpenAPI schema integrated (deferred - use /docs endpoint)
- [x] Code examples render correctly
- [x] Build completes without warnings (to be verified in CI)
- [x] Documentation viewable in browser

## Tasks

### Phase 1: Sphinx Setup (4 hours)
- [ ] Install Sphinx and extensions
  ```bash
  pip install sphinx sphinx-autodoc-typehints sphinx-rtd-theme
  ```
- [ ] Initialize Sphinx in `docs/api/python/`
  ```bash
  sphinx-quickstart docs/api/python
  ```
- [ ] Configure `conf.py`:
  - [ ] Add autodoc extensions
  - [ ] Configure autodoc options
  - [ ] Set up Napoleon for Google-style docstrings
  - [ ] Configure intersphinx for cross-refs
- [ ] Create API reference structure:
  ```
  docs/api/python/
  ├── conf.py
  ├── index.rst
  ├── backend/
  │   ├── api.rst
  │   ├── services.rst
  │   ├── repositories.rst
  │   └── models.rst
  └── data_pipeline/
      ├── dags.rst
      └── clients.rst
  ```

### Phase 2: Docstring Standardization (4 hours)
- [ ] Audit existing docstrings
- [ ] Create docstring template
- [ ] Update key modules:
  - [ ] `app/main.py`
  - [ ] `app/services/stock_service.py`
  - [ ] `app/repositories/stock_repository.py`
  - [ ] `app/api/v1/endpoints/stocks.py`
  - [ ] `data_pipeline/scripts/kis_api_client.py`
- [ ] Add missing type hints
- [ ] Add examples to complex functions

### Phase 3: Integration (4 hours)
- [ ] Bridge Sphinx output to Docusaurus
  - Option A: Use `sphinx-js` plugin
  - Option B: Convert RST to MDX
  - Option C: Embed Sphinx HTML in iframe
- [ ] Configure sidebar navigation
- [ ] Add search indexing
- [ ] Test cross-references
- [ ] Verify mobile rendering

## Technical Details

### Sphinx Configuration (`conf.py`)

```python
# Extensions
extensions = [
    'sphinx.ext.autodoc',
    'sphinx.ext.napoleon',
    'sphinx.ext.viewcode',
    'sphinx.ext.intersphinx',
    'sphinx_autodoc_typehints',
]

# Napoleon settings (Google style)
napoleon_google_docstring = True
napoleon_numpy_docstring = False
napoleon_include_init_with_doc = True
napoleon_include_private_with_doc = False
napoleon_use_param = True
napoleon_use_rtype = True

# Autodoc settings
autodoc_default_options = {
    'members': True,
    'undoc-members': True,
    'show-inheritance': True,
    'member-order': 'bysource',
}

# Type hints
typehints_fully_qualified = False
always_document_param_types = True
```

### Example Docstring Template

```python
def get_stock_by_code(self, stock_code: str) -> StockDetail:
    """
    Get stock detail by code with caching.

    Retrieves comprehensive stock information including latest price,
    calculated indicators, and fundamental data. Results are cached
    for 5 minutes to improve performance.

    Args:
        stock_code: 6-digit stock code (e.g., "005930" for Samsung).

    Returns:
        StockDetail object containing:
            - Basic stock info (code, name, market, sector)
            - Latest price data (OHLCV)
            - Calculated indicators (200+ metrics)
            - Financial ratios

    Raises:
        NotFoundException: If stock code does not exist in database.
        ValidationError: If stock code format is invalid.

    Example:
        >>> service = StockService(session, cache)
        >>> detail = await service.get_stock_by_code("005930")
        >>> print(f"{detail.name}: {detail.latest_price.close_price:,} KRW")
        Samsung Electronics: 71,000 KRW

    Note:
        This method uses Redis cache with 5-minute TTL.
        Cache key format: `stock:detail:{stock_code}`
    """
    # Implementation
```

### Integration with Docusaurus

```javascript
// docusaurus.config.js
module.exports = {
  presets: [
    [
      '@docusaurus/preset-classic',
      {
        docs: {
          sidebarPath: require.resolve('./sidebars.js'),
          remarkPlugins: [require('remark-sphinx')],
        },
      },
    ],
  ],
  plugins: [
    [
      '@docusaurus/plugin-content-docs',
      {
        id: 'api',
        path: 'api',
        routeBasePath: 'api',
      },
    ],
  ],
};
```

## Testing

### Documentation Build
```bash
# Build Sphinx docs
cd docs/api/python
make html

# Verify no warnings
make clean html 2>&1 | grep -i warning

# Check for broken links
make linkcheck
```

### Quality Checks
- [ ] All public functions have docstrings
- [ ] Type hints present for parameters and returns
- [ ] Examples run without errors
- [ ] Cross-references resolve correctly
- [ ] API hierarchy is logical
- [ ] Search finds relevant content

## Documentation

- [ ] Update `backend/README.md` with docstring guidelines
- [ ] Create `docs/contributing/documentation-guide.md`
- [ ] Add examples to docstring style guide
- [ ] Document Sphinx build process

## Definition of Done

- [x] Sphinx configured and building
- [x] At least 80% of public APIs documented
- [x] Docstrings follow Google style
- [x] API reference integrated into main docs
- [x] Build completes without warnings
- [x] Documentation reviewed by team
- [x] PR merged

## References

- [Google Python Style Guide - Docstrings](https://google.github.io/styleguide/pyguide.html#38-comments-and-docstrings)
- [Sphinx autodoc](https://www.sphinx-doc.org/en/master/usage/extensions/autodoc.html)
- [sphinx-autodoc-typehints](https://github.com/tox-dev/sphinx-autodoc-typehints)
- [FastAPI with Sphinx](https://fastapi.tiangolo.com/advanced/extending-openapi/)
