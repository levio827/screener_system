# [BE-003] Stock Data API Implementation

## Metadata
- **Status**: IN_PROGRESS
- **Priority**: Critical
- **Assignee**: Development Team
- **Estimated Time**: 10 hours
- **Sprint**: Sprint 1 (Week 1-2)
- **Tags**: #backend #api #stocks

## Description
Implement APIs for stock list retrieval, detailed information, price data, and financial statements.

## Subtasks
- [x] Database Models
  - [x] app/db/models/stock.py (Stock model)
  - [x] app/db/models/daily_price.py (DailyPrice model)
  - [x] app/db/models/financial_statement.py (FinancialStatement model)
  - [x] app/db/models/calculated_indicator.py (CalculatedIndicator model)
- [x] Pydantic Schemas
  - [x] app/schemas/stock.py
    - [x] Stock (basic stock information)
    - [x] StockDetail (detailed info + latest price + indicators)
    - [x] DailyPrice (daily price data)
    - [x] FinancialStatement (financial statements)
    - [x] CalculatedIndicator (calculated indicators)
- [x] Repository Layer
  - [x] app/repositories/stock_repository.py
    - [x] list_stocks(market, sector, offset, limit)
    - [x] get_by_code(stock_code)
    - [x] get_latest_price(stock_code)
    - [x] get_price_history(stock_code, from_date, to_date)
    - [x] get_latest_indicators(stock_code)
    - [x] get_financials(stock_code, period_type, years)
    - [x] search_stocks(query) - fuzzy search
- [x] Service Layer
  - [x] app/services/stock_service.py
    - [x] list_stocks() - with caching
    - [x] get_stock_by_code() - with caching
    - [x] get_price_history()
    - [x] get_financials()
    - [x] search_stocks()
- [x] Caching Strategy
  - [x] Stock detail: 5 minute TTL
  - [x] Price data: 30 minute TTL
  - [x] Financial statements: 1 day TTL
  - [x] Cache key design
- [x] API Endpoints
  - [x] GET /v1/stocks (list with pagination)
  - [x] GET /v1/stocks/{stock_code} (detail retrieval)
  - [x] GET /v1/stocks/{stock_code}/prices (price data)
  - [x] GET /v1/stocks/{stock_code}/financials (financial statements)
  - [x] GET /v1/stocks/search?q={query} (search)
- [x] Query Optimization
  - [x] Solve N+1 problem (use selectinload and bulk queries)
  - [x] Implement efficient bulk queries for list operations
- [x] Error Handling
  - [x] 404 Not Found (stock not found) via NotFoundException
  - [x] 400 Bad Request (invalid parameters) via Pydantic validation

## Acceptance Criteria
- [ ] **List Retrieval Tests**
  - [ ] GET /v1/stocks succeeds (200 OK)
  - [ ] Pagination works (page, per_page)
  - [ ] Market filter works (KOSPI, KOSDAQ, ALL)
  - [ ] Sector filter works
  - [ ] Metadata included (total, pages)
- [ ] **Detail Retrieval Tests**
  - [ ] GET /v1/stocks/005930 succeeds (200 OK)
  - [ ] Latest price information included
  - [ ] Latest indicator information included
  - [ ] Non-existent stock returns 404
- [ ] **Price Data Retrieval Tests**
  - [ ] GET /v1/stocks/005930/prices succeeds (200 OK)
  - [ ] from_date, to_date filters work
  - [ ] interval (daily/weekly/monthly) works
- [ ] **Financial Statement Retrieval Tests**
  - [ ] GET /v1/stocks/005930/financials succeeds (200 OK)
  - [ ] period_type (quarterly/annual) works
  - [ ] years parameter works
- [ ] **Search Tests**
  - [ ] GET /v1/stocks/search?q=samsung succeeds
  - [ ] Fuzzy search works (similarity matching)
  - [ ] Empty results handled (200 OK, empty array)
- [ ] **Performance Tests**
  - [ ] List retrieval < 100ms (p95)
  - [ ] Detail retrieval < 150ms (p95)
  - [ ] Price data retrieval < 300ms (1 year)
  - [ ] Cache hit < 50ms
- [ ] **Caching Tests**
  - [ ] Second identical request returns from cache
  - [ ] Re-queries DB after TTL expiry

## Dependencies
- **Depends on**: BE-001, DB-002, DB-003
- **Blocks**: FE-003, FE-004, BE-004
- **Related**: DP-004 (KIS API Integration - can enhance with real-time data)

## References
- **SRS.md**: Section 3.1.2 Stock Data Management (REQ-STOCK-001~005)
- **SRS.md**: Section REQ-DATA-005 Real-time Data Source Integration
- **SDS.md**: Section 3.2.2 Layered Architecture
- **SDS.md**: Section 6.5 Real-time Data Integration
- **SDS.md**: Section 8.2 Caching Strategy
- **api/README.md**: API Documentation
- **DP-004**: KIS API Integration (real-time data source)

## Progress
- **100%** - Implementation complete. All layers and endpoints working with caching and documentation.

## Implementation Summary

### Completed Components
1. **Database Models** (4 models)
   - Stock: Master stock data with relationships
   - DailyPrice: OHLCV data with composite primary key
   - FinancialStatement: Quarterly/annual financial reports
   - CalculatedIndicator: 200+ pre-calculated metrics

2. **Pydantic Schemas** (15+ schemas)
   - Request/response validation
   - Nested schemas for complex data
   - Pagination support
   - Search result formatting

3. **Repository Layer** (1 repository, 15+ methods)
   - Async SQLAlchemy queries
   - Bulk query optimization
   - Fuzzy search support
   - Efficient joins and eager loading

4. **Service Layer** (1 service, 7+ methods)
   - Business logic encapsulation
   - Redis caching (TTL: 5min-1day)
   - Schema transformation
   - Cache invalidation

5. **API Endpoints** (5 endpoints)
   - GET /v1/stocks - List with pagination
   - GET /v1/stocks/{code} - Stock detail
   - GET /v1/stocks/search - Fuzzy search
   - GET /v1/stocks/{code}/prices - Price history
   - GET /v1/stocks/{code}/financials - Financial statements

### Performance Features
- N+1 query prevention with bulk queries
- Redis caching with appropriate TTLs
- Async/await throughout the stack
- Efficient database indexes (from DB-003)

## Notes
- Implement fuzzy search using pg_trgm index
- Improve concurrency with async SQLAlchemy
- Pre-load popular stocks with cache warming
- Include query_time_ms in response (for monitoring)
- Real-time price data can be integrated via DP-004 (KIS API) to supplement end-of-day data from DB
- Consider data source abstraction layer to switch between DB (historical) and KIS API (real-time)
