# [BE-003] Stock Data API Implementation

## Metadata
- **Status**: TODO
- **Priority**: Critical
- **Assignee**: TBD
- **Estimated Time**: 10 hours
- **Sprint**: Sprint 1 (Week 2-3)
- **Tags**: #backend #api #stocks

## Description
Implement APIs for stock list retrieval, detailed information, price data, and financial statements.

## Subtasks
- [ ] Database Models
  - [ ] app/db/models/stock.py (Stock model)
  - [ ] app/db/models/daily_price.py (DailyPrice model)
  - [ ] app/db/models/financial_statement.py (FinancialStatement model)
  - [ ] app/db/models/calculated_indicator.py (CalculatedIndicator model)
- [ ] Pydantic Schemas
  - [ ] app/schemas/stock.py
    - [ ] Stock (basic stock information)
    - [ ] StockDetail (detailed info + latest price + indicators)
    - [ ] DailyPrice (daily price data)
    - [ ] FinancialStatement (financial statements)
    - [ ] CalculatedIndicator (calculated indicators)
- [ ] Repository Layer
  - [ ] app/repositories/stock_repository.py
    - [ ] list_stocks(market, sector, offset, limit)
    - [ ] get_by_code(stock_code)
    - [ ] get_latest_price(stock_code)
    - [ ] get_price_history(stock_code, from_date, to_date)
    - [ ] get_latest_indicators(stock_code)
    - [ ] get_financials(stock_code, period_type, years)
    - [ ] search_stocks(query) - fuzzy search
- [ ] Service Layer
  - [ ] app/services/stock_service.py
    - [ ] list_stocks() - with caching
    - [ ] get_stock_by_code() - with caching
    - [ ] get_price_history()
    - [ ] get_financials()
    - [ ] search_stocks()
- [ ] Caching Strategy
  - [ ] Stock detail: 5 minute TTL
  - [ ] Price data: 30 minute TTL
  - [ ] Financial statements: 1 day TTL
  - [ ] Cache key design
- [ ] API Endpoints
  - [ ] GET /v1/stocks (list with pagination)
  - [ ] GET /v1/stocks/{stock_code} (detail retrieval)
  - [ ] GET /v1/stocks/{stock_code}/prices (price data)
  - [ ] GET /v1/stocks/{stock_code}/financials (financial statements)
  - [ ] GET /v1/stocks/search?q={query} (search)
- [ ] Query Optimization
  - [ ] Solve N+1 problem (use selectinload)
  - [ ] Verify query plan with EXPLAIN ANALYZE
- [ ] Error Handling
  - [ ] 404 Not Found (stock not found)
  - [ ] 400 Bad Request (invalid parameters)

## Acceptance Criteria
- [ ] **List Retrieval Tests**
  - [ ] GET /v1/stocks succeeds (200 OK)
  - [ ] Pagination works (page, per_page)
  - [ ] Market filter works (KOSPI, KOSDAQ, ALL)
  - [ ] Sector filter works
  - [ ] Metadata included (total, pages)
- [ ] **Detail Retrieval Tests**
  - [ ] GET /v1/stocks/005930 succeeds (200 OK)
  - [ ] Latest price information included
  - [ ] Latest indicator information included
  - [ ] Non-existent stock returns 404
- [ ] **Price Data Retrieval Tests**
  - [ ] GET /v1/stocks/005930/prices succeeds (200 OK)
  - [ ] from_date, to_date filters work
  - [ ] interval (daily/weekly/monthly) works
- [ ] **Financial Statement Retrieval Tests**
  - [ ] GET /v1/stocks/005930/financials succeeds (200 OK)
  - [ ] period_type (quarterly/annual) works
  - [ ] years parameter works
- [ ] **Search Tests**
  - [ ] GET /v1/stocks/search?q=samsung succeeds
  - [ ] Fuzzy search works (similarity matching)
  - [ ] Empty results handled (200 OK, empty array)
- [ ] **Performance Tests**
  - [ ] List retrieval < 100ms (p95)
  - [ ] Detail retrieval < 150ms (p95)
  - [ ] Price data retrieval < 300ms (1 year)
  - [ ] Cache hit < 50ms
- [ ] **Caching Tests**
  - [ ] Second identical request returns from cache
  - [ ] Re-queries DB after TTL expiry

## Dependencies
- **Depends on**: BE-001, DB-002, DB-003
- **Blocks**: FE-003, FE-004, BE-004
- **Related**: DP-004 (KIS API Integration - can enhance with real-time data)

## References
- **SRS.md**: Section 3.1.2 Stock Data Management (REQ-STOCK-001~005)
- **SRS.md**: Section REQ-DATA-005 Real-time Data Source Integration
- **SDS.md**: Section 3.2.2 Layered Architecture
- **SDS.md**: Section 6.5 Real-time Data Integration
- **SDS.md**: Section 8.2 Caching Strategy
- **api/README.md**: API Documentation
- **DP-004**: KIS API Integration (real-time data source)

## Progress
- **0%** - Not started

## Notes
- Implement fuzzy search using pg_trgm index
- Improve concurrency with async SQLAlchemy
- Pre-load popular stocks with cache warming
- Include query_time_ms in response (for monitoring)
- Real-time price data can be integrated via DP-004 (KIS API) to supplement end-of-day data from DB
- Consider data source abstraction layer to switch between DB (historical) and KIS API (real-time)
