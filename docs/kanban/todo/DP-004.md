# [DP-004] Korea Investment & Securities (KIS) API Integration

## Metadata
- **Status**: TODO
- **Priority**: Critical
- **Assignee**: TBD
- **Estimated Time**: 20 hours
- **Sprint**: Sprint 2 (Week 4)
- **Tags**: #data-pipeline #external-api #kis-api #real-data

## Description
Integrate with Korea Investment & Securities (한국투자증권) API to fetch real-time stock market data. Replace mock data sources with actual production data from KIS API.

## Subtasks
- [ ] KIS API Client Implementation
  - [ ] OAuth 2.0 authentication
    - [ ] Auto-refresh token mechanism
    - [ ] Token expiration handling
    - [ ] Thread-safe token storage
  - [ ] HTTP client with connection pooling
  - [ ] Rate limiting (20 requests/second)
  - [ ] Error handling and retry logic
- [ ] API Endpoints Integration
  - [ ] Current price query (현재가)
  - [ ] Order book query (호가) - 10 levels
  - [ ] Historical chart data (일/분봉)
  - [ ] Stock info query (종목 정보)
- [ ] Data Source Abstraction Layer
  - [ ] AbstractDataSource interface
  - [ ] KISDataSource implementation
  - [ ] MockDataSource for testing
  - [ ] DataSourceFactory with config-based selection
- [ ] Caching Strategy
  - [ ] Redis cache integration
  - [ ] Cache key design (stock:{code}:price, stock:{code}:orderbook)
  - [ ] TTL configuration (price: 30min, orderbook: 10sec)
  - [ ] Cache invalidation on market close
- [ ] Circuit Breaker Pattern
  - [ ] Failure threshold (5 failures)
  - [ ] Timeout period (60 seconds)
  - [ ] State management (CLOSED, OPEN, HALF_OPEN)
  - [ ] Fallback to cached data
- [ ] Configuration Management
  - [ ] Add KIS credentials to .env
  - [ ] Feature flags (ENABLE_KIS_API, KIS_USE_REAL_SERVER)
  - [ ] Rate limit configuration
  - [ ] Timeout settings
- [ ] Integration with Existing DAGs
  - [ ] Update daily_price_ingestion_dag.py
  - [ ] Replace mock data fetcher with KIS client
  - [ ] Add data validation layer
  - [ ] Logging and monitoring

## Acceptance Criteria
- [ ] **Authentication**
  - [ ] OAuth token obtained successfully
  - [ ] Token auto-refreshes before expiration
  - [ ] Handles authentication failures gracefully
- [ ] **Data Fetching**
  - [ ] Fetch current price for 2,400+ stocks
  - [ ] Order book data with 10-level depth
  - [ ] Historical data (daily, intraday)
  - [ ] Data accuracy validated (spot check 100 stocks)
- [ ] **Rate Limiting**
  - [ ] Respects 20 req/sec limit
  - [ ] No 429 (rate limit) errors in production
  - [ ] Request queue manages backpressure
- [ ] **Performance**
  - [ ] API call latency < 200ms (p95)
  - [ ] Cache hit rate > 80%
  - [ ] Full data ingestion < 10 minutes
- [ ] **Reliability**
  - [ ] Circuit breaker activates on failures
  - [ ] Fallback to cached data works
  - [ ] 99.9% success rate during market hours
- [ ] **Testing**
  - [ ] Unit tests for KIS client (>90% coverage)
  - [ ] Integration tests with real API (virtual server)
  - [ ] Mock tests for all edge cases
  - [ ] Load testing (1000 req/min sustained)

## Dependencies
- **Depends on**: DP-001, DB-002, BE-001
- **Blocks**: DP-002, DP-003, BE-006

## References
- **SDS.md**: Section 6.4 External Data Sources (to be added)
- **SRS.md**: REQ-DATA-004 Real-time Data Integration (to be added)
- [KIS API Documentation](https://apiportal.koreainvestment.com/)
- [KIS API Portal](https://apiportal.koreainvestment.com/apiservice/)

## Progress
- **0%** - Not started

## Notes
- Use virtual server (모의투자) for development and testing
- Real server requires approval and has stricter limits
- API provides 3-5 second delayed data (not true real-time)
- Market hours: 09:00-15:30 KST (Mon-Fri)
- Store API credentials securely (never commit to git)
- Consider implementing request deduplication for identical queries
